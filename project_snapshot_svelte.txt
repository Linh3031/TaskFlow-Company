--- START FILE: ./index.html ---
<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    
    <title>Check List CV</title>
    
    <meta property="og:title" content="Check List CV" />
    <meta property="og:site_name" content="Check List CV" />
    <meta property="og:description" content="H·ªá th·ªëng qu·∫£n l√Ω c√¥ng vi·ªác v√† ph√¢n ca" />
    <meta property="og:image" content="/logo.jpeg" />
    <meta property="og:type" content="website" />

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" type="image/jpeg" href="/logo.jpeg">
    <link rel="apple-touch-icon" href="/logo.jpeg">
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
--- END FILE: ./index.html ---

--- START FILE: ./make_snapshot.js ---
/* Tool: Project Slicer for AI Context 
   Run: node make_snapshot.js
*/
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

// C·∫•u h√¨nh c√°c nh√≥m file c·∫ßn t√°ch
const GROUPS = {
    'snapshot_admin.txt': ['src/components/admin'],
    'snapshot_features.txt': ['src/components/health-staff', 'src/components/realtime', 'src/components/luyke'],
    'snapshot_services.txt': ['src/services', 'src/utils', 'src/logic'],
    'snapshot_core.txt': ['src/stores.js', 'src/components/common', 'src/App.svelte', 'src/main.js', 'src/config.js', 'src/styles']
};

// H√†m qu√©t file ƒë·ªá quy
function getFiles(dir) {
    let results = [];
    if (!fs.existsSync(dir)) return results;
    
    // N·∫øu l√† file ƒë∆°n l·∫ª
    if (fs.statSync(dir).isFile()) return [dir];

    const list = fs.readdirSync(dir);
    list.forEach(file => {
        file = path.join(dir, file);
        const stat = fs.statSync(file);
        if (stat && stat.isDirectory()) {
            results = results.concat(getFiles(file));
        } else {
            // Ch·ªâ l·∫•y c√°c file code text
            if (/\.(svelte|js|ts|css|html|json|md)$/.test(file)) {
                results.push(file);
            }
        }
    });
    return results;
}

// Th·ª±c thi
console.log("üöÄ ƒêang t·∫°o snapshot...");

for (const [outputName, folders] of Object.entries(GROUPS)) {
    let content = `SNAPSHOT GROUP: ${outputName}\n\n`;
    let fileCount = 0;

    folders.forEach(folder => {
        const files = getFiles(folder);
        files.forEach(filePath => {
            try {
                const data = fs.readFileSync(filePath, 'utf8');
                content += `\n================================================================================\n`;
                content += `File: ${filePath}\n`;
                content += `================================================================================\n\n`;
                content += data + "\n";
                fileCount++;
            } catch (e) {
                console.error(`L·ªói ƒë·ªçc file ${filePath}: ${e.message}`);
            }
        });
    });

    fs.writeFileSync(outputName, content);
    console.log(`‚úÖ ƒê√£ t·∫°o ${outputName} (${fileCount} files)`);
}

console.log("üéâ Ho√†n t·∫•t! H√£y k√©o th·∫£ 4 file .txt v·ª´a t·∫°o v√†o Gemini.");
--- END FILE: ./make_snapshot.js ---

--- START FILE: ./package.json ---
{
  "name": "task-flow-908",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "devDependencies": {
    "@sveltejs/vite-plugin-svelte": "^6.2.1",
    "autoprefixer": "^10.4.22",
    "postcss": "^8.5.6",
    "svelte": "^5.43.8",
    "tailwindcss": "^3.4.17",
    "vite": "^7.2.4"
  },
  "dependencies": {
    "firebase": "^12.6.0",
    "xlsx": "^0.18.5"
  }
}

--- END FILE: ./package.json ---

--- START FILE: ./postcss.config.js ---
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
--- END FILE: ./postcss.config.js ---

--- START FILE: ./src/App.svelte ---
<script>
  // Version 10.6 - Add Installment Calc Feature
  import { onMount, onDestroy, tick } from 'svelte';
  import { db } from './lib/firebase';
  import { collection, onSnapshot, query, where, doc, updateDoc, arrayUnion, writeBatch, serverTimestamp, getDocs } from 'firebase/firestore';
  import { currentUser, currentTasks, taskTemplate, DEFAULT_TEMPLATE, storeList } from './lib/stores.js';
  import { getTodayStr, getCurrentTimeShort } from './lib/utils.js';
  import Login from './components/Login.svelte';
  import Header from './components/Header.svelte';
  import TaskList from './components/TaskList.svelte';
  // import HandoverInput from './components/HandoverInput.svelte'; // [HIDDEN]
  import InstallmentCalc from './components/InstallmentCalc.svelte'; // [NEW IMPORT]
  import AdminModal from './components/AdminModal.svelte';
  import TaskModal from './components/TaskModal.svelte';
  import TourGuide from './components/TourGuide.svelte';
  import ShiftSchedule from './components/ShiftSchedule.svelte';

  let activeTab = 'warehouse';
  let showAdminModal = false;
  let showTaskModal = false;
  let selectedTask = null;
  let noteInput = '';
  let selectedDate = getTodayStr();
  
  let activeStoreId = '';
  let showTour = false;
  const tourKey = 'taskflow_v6_general_tour_seen';

  const tourSteps = [
      { target: '.app-header', title: 'Xin ch√†o!', content: 'Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi TaskFlow.' },
      { target: '#tab-nav-container', title: 'Chuy·ªÉn ƒê·ªïi B·ªô Ph·∫≠n', content: 'Chuy·ªÉn gi·ªØa: Kho, Thu Ng√¢n, Tr·∫£ G√≥p, L·ªãch Ca.' },
      { target: '#date-navigator', title: 'Ch·ªçn Ng√†y', content: 'B·∫•m < ho·∫∑c > ƒë·ªÉ chuy·ªÉn ng√†y.' },
      { target: '#btn-notif', title: 'Th√¥ng B√°o', content: 'Xem ai nh·∫Øc t√™n b·∫°n.' },
      { target: '#btn-admin', title: 'C√†i ƒê·∫∑t', content: 'C·∫•u h√¨nh h·ªá th·ªëng.' }
  ];
  let unsubStores = () => {};
  let unsubTemplate = () => {};
  let unsubTasks = () => {};
  let hasCheckedInit = false; 
  let isTasksLoaded = false; 

  // --- LOGIC HI·ªÇN TH·ªä NG√ÄY TH√ÅNG ---
  $: displayDateLabel = (() => {
      if (!selectedDate) return '';
      const [y, m, d] = selectedDate.split('-');
      return `${d}/${m}`;
  })();
  $: displayDayOfWeek = (() => {
      if (!selectedDate) return '';
      const date = new Date(selectedDate);
      const days = ['CN', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
      return days[date.getDay()];
  })();
  function changeDate(offset) {
      const d = new Date(selectedDate);
      d.setDate(d.getDate() + offset);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      selectedDate = `${year}-${month}-${day}`;
  }
  
  function openDatePicker() {
      try { document.getElementById('hidden-date-input').showPicker(); } 
      catch (e) { document.getElementById('hidden-date-input').click(); }
  }

  // Reset c·ªù khi ƒë·ªïi kho ho·∫∑c ƒë·ªïi ng√†y
  $: if (activeStoreId || selectedDate) {
      hasCheckedInit = false;
      isTasksLoaded = false; 
  }

  onMount(() => {
    unsubStores = onSnapshot(collection(db, 'stores'), (snap) => {
        storeList.set(snap.docs.map(d => ({id:d.id, ...d.data()})));
    });
    if ($currentUser && !localStorage.getItem(tourKey)) showTour = true;
  });
  onDestroy(() => { unsubStores(); unsubTemplate(); unsubTasks(); });

  $: if ($currentUser && !activeStoreId) {
      if ($currentUser.storeIds && $currentUser.storeIds.length > 0) {
          activeStoreId = $currentUser.storeIds[0];
      } else if ($currentUser.role === 'super_admin') {
          activeStoreId = '908';
      }
  }

  $: if ($currentUser && activeStoreId) loadDataForUser(activeStoreId, selectedDate);
  // T·ª∞ ƒê·ªòNG KH·ªûI T·∫†O (CH·∫†Y NG·∫¶M AN TO√ÄN)
  $: if ($currentUser && activeStoreId && selectedDate === getTodayStr() && $taskTemplate && $currentTasks && isTasksLoaded) {
       if (!hasCheckedInit) {
           initDailyTasksSafe(activeStoreId, selectedDate, $currentTasks, $taskTemplate);
       }
  }

  function generateFixedID(storeId, dateStr, type, title) {
      const cleanTitle = title.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
      return `${storeId}_${dateStr}_${type}_${cleanTitle}`;
  }

  async function initDailyTasksSafe(storeId, dateStr, currentTasks, template) {
      if (dateStr !== getTodayStr()) return;
      hasCheckedInit = true;

      const dayOfWeek = new Date().getDay();
      const batch = writeBatch(db);
      let hasUpdates = false;
      const types = ['warehouse', 'cashier']; // B·ªè handover kh·ªèi auto-init n·∫øu kh√¥ng c·∫ßn thi·∫øt

      types.forEach(type => {
          const templateItems = template[type] || [];
          templateItems.forEach(tpl => {
              if (tpl.days && tpl.days.includes(dayOfWeek)) {
                  
                  const fixedID = generateFixedID(storeId, dateStr, type, tpl.title);
      
                  // Ki·ªÉm tra tr√πng l·∫∑p
                  const existsByID = currentTasks.some(t => t.id === fixedID);
                  const existsByTitle = currentTasks.some(t => 
                      t.title.trim().toLowerCase() === tpl.title.trim().toLowerCase() && 
                      t.type === type
                  );

                  if (!existsByID && !existsByTitle) {
                      const docRef = doc(db, 'tasks', fixedID);
             
                      batch.set(docRef, {
                          title: tpl.title.trim(),
                          timeSlot: tpl.time,
                          isImportant: tpl.isImportant || false,
                          type: type,
                          storeId: storeId,
                          date: dateStr,
                          completed: false,
                          createdBy: 'System',
                          timestamp: serverTimestamp()
                      });
                      hasUpdates = true;
                  }
              }
          });
      });

      if (hasUpdates) {
          console.log("‚ö° ƒêang ƒë·ªìng b·ªô c√¥ng vi·ªác thi·∫øu...");
          try { await batch.commit(); } catch(e) { console.error(e); }
      }
  }

  function loadDataForUser(storeId, dateStr) {
      if(unsubTemplate) unsubTemplate();
      if(unsubTasks) unsubTasks();

      unsubTemplate = onSnapshot(doc(db, 'settings', `template_${storeId}`), (docSnap) => {
          taskTemplate.set(docSnap.exists() ? docSnap.data() : DEFAULT_TEMPLATE);
      });
      const q = query(collection(db, 'tasks'), where('date', '==', dateStr), where('storeId', '==', storeId));
      unsubTasks = onSnapshot(q, (snapshot) => {
          const tasks = [];
          snapshot.forEach(doc => {
              const data = doc.data();
              if (data.type) tasks.push({ id: doc.id, ...data });
          });
          currentTasks.set(tasks);
          isTasksLoaded = true; 
      });
  }

  function handleTaskClick(event) {
    const task = event.detail;
    if (task.completed) {
      if(confirm('Ho√†n t√°c (Undo)?')) {
          const user = $currentUser.name || $currentUser.username;
          const time = getCurrentTimeShort();
          updateDoc(doc(db, 'tasks', task.id), { 
              completed: false, 
              history: arrayUnion({ action: 'undo', user, time, fullTime: new Date().toISOString() })
          });
      }
    } else {
      selectedTask = task;
      noteInput = '';
      showTaskModal = true;
    }
  }

  function confirmComplete() {
    if (!selectedTask) return;
    const user = $currentUser.name || $currentUser.username;
    const time = getCurrentTimeShort();
    updateDoc(doc(db, 'tasks', selectedTask.id), {
      completed: true, completedBy: user, time: time, note: noteInput,
      history: arrayUnion({ action: 'done', user, time, fullTime: new Date().toISOString() })
    });
    showTaskModal = false; selectedTask = null;
  }

  async function handleJumpToTask(event) {
      const { taskId, tab } = event.detail;
      if (tab) activeTab = tab;
      await tick();
      const el = document.getElementById("task-" + taskId);
      if (el) {
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          el.style.transition = "background-color 0.5s";
          el.style.backgroundColor = "#fff9c4"; 
          setTimeout(() => { el.style.backgroundColor = ""; }, 2000);
      } else { alert("Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác n√†y!"); }
  }
</script>

<main>
  {#if !$currentUser} <Login /> {:else}
    <div class="app-container">
      <Header on:openAdmin={() => showAdminModal = true} on:openTour={() => showTour = true} on:openIosGuide={() => alert('Tr√™n iPhone: B·∫•m n√∫t Chia s·∫ª -> Ch·ªçn "Th√™m v√†o MH ch√≠nh"')} on:jumpToTask={handleJumpToTask} />
      
      <nav id="tab-nav-container" class="tab-nav">
        {#each [
            {id:'warehouse', icon:'inventory_2', label:'Kho', color:'#ff9800'},
            {id:'cashier', icon:'point_of_sale', label:'Thu Ng√¢n', color:'#4caf50'},
            {id:'installment', icon:'calculate', label:'Tr·∫£ G√≥p', color:'#673ab7'}, // [CHANGED] Handover -> Installment
            {id:'schedule', icon:'calendar_month', label:'L·ªãch Ca', color:'#e91e63'}
        ] as t}
            <button class="tab-btn {activeTab===t.id?'active':''}" on:click={() => activeTab=t.id} style="--theme-color: {t.color};">
                <div class="icon-box"><span class="material-icons-round">{t.icon}</span></div><small>{t.label}</small>
            </button>
        {/each}
      </nav>

      <div id="main-content" class="content-area">
        <div class="section-header {activeTab}-theme flex flex-col gap-2 items-start sm:flex-row sm:items-center sm:justify-between">
          <div class="flex items-center justify-between w-full sm:w-auto">
              <h3>
                 {#if $currentUser.role === 'super_admin'}
                      üõ°Ô∏è View: <select bind:value={activeStoreId} class="ml-1 bg-transparent border-none font-bold text-indigo-600 outline-none cursor-pointer"><option value="908">Kho 908</option>{#each $storeList as s}{#if s.id !== '908'} <option value={s.id}>{s.id}</option> {/if}{/each}</select>
                 {:else}
                    {#if activeTab==='warehouse'}üì¶ Checklist Kho{/if}
                    {#if activeTab==='cashier'}üí∞ Checklist Thu Ng√¢n{/if}
                    {#if activeTab==='installment'}üßÆ T√≠nh Tr·∫£ G√≥p{/if} {#if activeTab==='schedule'}üìÖ L·ªãch Ph√¢n Ca{/if}
                 {/if}
              </h3>
              {#if activeTab !== 'schedule' && activeTab !== 'installment'}
                <span class="task-count ml-2">{$currentTasks.filter(t => t.type === activeTab && !t.completed).length} ch∆∞a xong</span>
               {/if}
           </div>
           
           {#if activeTab !== 'schedule' && activeTab !== 'installment'}
            <div id="date-navigator" class="flex items-center gap-1 w-full sm:w-auto bg-gray-100 p-1 rounded-lg border border-gray-200 shadow-sm">
                 <button class="w-8 h-8 flex items-center justify-center bg-white rounded-md text-gray-500 hover:text-indigo-600 hover:shadow-sm transition-all active:scale-95" on:click={() => changeDate(-1)}>
                    <span class="material-icons-round text-lg">chevron_left</span>
                </button>
                <button class="relative flex-1 sm:flex-none flex flex-col items-center justify-center px-3 cursor-pointer group min-w-[70px] bg-transparent border-none" on:click={openDatePicker}>
                     <span class="text-[10px] font-bold text-gray-400 leading-none uppercase">{displayDayOfWeek}</span>
                    <span class="text-sm font-black text-gray-800 leading-tight group-hover:text-indigo-600 transition-colors">{displayDateLabel}</span>
                </button>
                <input id="hidden-date-input" type="date" bind:value={selectedDate} class="absolute opacity-0 pointer-events-none w-0 h-0">
                <button class="w-8 h-8 flex items-center justify-center bg-white rounded-md text-gray-500 hover:text-indigo-600 hover:shadow-sm transition-all active:scale-95" on:click={() => changeDate(1)}>
                    <span class="material-icons-round text-lg">chevron_right</span>
                </button>
             </div>
          {/if}
        </div>

        {#if activeTab === 'installment'} 
            <InstallmentCalc /> 
        {:else if activeTab === 'schedule'} 
            <ShiftSchedule {activeTab} /> 
        {:else} 
            <TaskList {activeTab} on:taskClick={handleTaskClick} /> 
        {/if}
      </div>
      <footer>Design by 3031 | Kho ƒëang xem: {activeStoreId}</footer>
    </div>
  {/if}
  
  {#if showAdminModal} <AdminModal on:close={() => showAdminModal = false} on:switchTab={(e) => { activeTab = e.detail; showAdminModal = false; }} /> {/if}
  {#if showTaskModal && selectedTask} <TaskModal taskTitle={selectedTask.title} bind:note={noteInput} on:cancel={() => showTaskModal = false} on:confirm={confirmComplete} /> {/if}
  {#if showTour} <TourGuide steps={tourSteps} on:complete={() => { showTour = false; localStorage.setItem(tourKey, 'true'); }} /> {/if}
</main>

<style>
  main { width: 100%; height: 100%; }
  .app-container { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-body); }
  .tab-nav { flex-shrink: 0; background: #ffffff; padding: 5px 10px; display: flex; gap: 5px; justify-content: space-between; border-bottom: 1px solid #eee; }
  .tab-btn { flex: 1; border: none; background: transparent; padding: 5px; display: flex; flex-direction: column; align-items: center; color: #bbb; cursor: pointer; transition: all 0.2s ease; }
  .icon-box { width: 36px; height: 24px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 2px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  .tab-btn small { font-size: 0.7rem; font-weight: 700; }
  .tab-btn.active { color: var(--theme-color); }
  .tab-btn.active .icon-box { background: var(--theme-color); color: white; width: 45px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
  .content-area { flex-grow: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; padding: 10px; }
  .section-header { flex-shrink: 0; padding: 10px; border-radius: 10px; margin-bottom: 10px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .section-header h3 { font-size: 1rem; margin: 0; font-weight: 700; }
  .task-count { background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 800; color: #555; }
  footer { flex-shrink: 0; text-align: center; padding: 10px; color: #999; font-size: 0.75rem; font-weight: 700; background: #f4f7fc; }
</style>
--- END FILE: ./src/App.svelte ---

--- START FILE: ./src/app.css ---
/* src/app.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

@import url('https://fonts.googleapis.com/icon?family=Material+Icons+Round');

.material-icons-round {
  font-family: 'Material Icons Round';
  font-weight: normal;
  font-style: normal;
  font-size: 24px;
  line-height: 1;
  letter-spacing: normal;
  text-transform: none;
  display: inline-block;
  white-space: nowrap;
  word-wrap: normal;
  direction: ltr;
  -webkit-font-feature-settings: 'liga';
  font-feature-settings: 'liga';
  -webkit-font-smoothing: antialiased;
}

body { 
  font-family: 'Nunito', sans-serif;
  background-color: #f4f7fc;
}

/* FIX FONT INPUT TIME (B·∫ÆT BU·ªòC) */
input[type="time"] {
    font-family: 'Nunito', sans-serif !important;
}

/* ·∫®n scrollbar */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
--- END FILE: ./src/app.css ---

--- START FILE: ./src/components/AdminModal.svelte ---
<script>
  // Version 47.0 - Clean Header (Moved Config to Schedule)
  import { createEventDispatcher } from 'svelte';
  import { currentUser } from '../lib/stores';
  import { db } from '../lib/firebase';
  
  import AdminTemplate from './admin/AdminTemplate.svelte';
  import AdminAccounts from './admin/AdminAccounts.svelte';
  import AdminSchedule from './admin/AdminSchedule.svelte';
  // StoreConfig ƒë∆∞·ª£c chuy·ªÉn v√†o trong AdminSchedule n√™n kh√¥ng c·∫ßn import ·ªü ƒë√¢y n·ªØa, 
  // tr·ª´ khi b·∫°n mu·ªën gi·ªØ n√≥ nh∆∞ m·ªôt modal to√†n c·ª•c. Nh∆∞ng theo y√™u c·∫ßu, t√¥i s·∫Ω ·∫©n n√∫t k√≠ch ho·∫°t ·ªü header.

  const dispatch = createEventDispatcher();
  
  $: isSuperAdmin = $currentUser?.role === 'super_admin';
  $: myStores = $currentUser?.storeIds || [];
  
  let targetStore = '';
  $: if (myStores.length > 0 && !targetStore) { targetStore = myStores[0]; }
  
  $: isDemoMode = targetStore?.includes('DEMO');

  let activeSection = 'schedule'; 
  // let showStoreConfig = false; // Moved to AdminSchedule

  function handleSwitchTab(e) {
      dispatch('switchTab', e.detail);
      dispatch('close');
  }
</script>

<div class="fixed inset-0 z-50 bg-slate-100 flex flex-col animate-fadeIn">
    <div class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 shadow-sm z-20">
        <div class="flex items-center gap-4 lg:gap-6">
            <button class="w-10 h-10 rounded-xl hover:bg-slate-100 flex items-center justify-center transition-all text-slate-500 hover:text-indigo-600" on:click={() => dispatch('close')} aria-label="ƒê√≥ng"><span class="material-icons-round">arrow_back</span></button>
            <h2 class="text-xl font-bold text-slate-800 tracking-tight hidden lg:block">Qu·∫£n Tr·ªã</h2>
            
            <div class="flex items-center gap-2">
                <div id="store-select-container" class="relative">
                    <select bind:value={targetStore} class="pl-3 pr-8 py-1.5 bg-indigo-50 border-indigo-100 text-indigo-700 font-bold rounded-lg text-sm outline-none appearance-none cursor-pointer hover:bg-indigo-100 transition-colors">
                        {#each myStores as s}<option value={s}>{s}</option>{/each}
                    </select>
                    <span class="material-icons-round absolute right-2 top-1/2 -translate-y-1/2 text-indigo-400 text-sm pointer-events-none">expand_more</span>
                </div>

                <div class="flex bg-slate-100 p-1 rounded-lg ml-2">
                    <button class="px-4 py-1.5 rounded-md text-sm font-bold transition-all {activeSection==='schedule'?'bg-white text-indigo-600 shadow-sm':'text-slate-500 hover:text-slate-700'}" on:click={() => activeSection = 'schedule'}>Ph√¢n Ca</button>
                    <button class="px-4 py-1.5 rounded-md text-sm font-bold transition-all {activeSection==='template'?'bg-white text-orange-600 shadow-sm':'text-slate-500 hover:text-slate-700'}" on:click={() => activeSection = 'template'}>T·∫°o c√¥ng vi·ªác</button>
                    <button class="px-4 py-1.5 rounded-md text-sm font-bold transition-all {activeSection==='accounts'?'bg-white text-blue-600 shadow-sm':'text-slate-500 hover:text-slate-700'}" on:click={() => activeSection = 'accounts'}>Nh√¢n S·ª±</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-auto p-4 lg:p-6 relative">
        {#if activeSection === 'schedule'}
            <AdminSchedule {targetStore} on:switchTab={handleSwitchTab} />
        {/if}
        
        {#if activeSection === 'template'} 
            <AdminTemplate {targetStore} /> 
        {/if}
        
        {#if activeSection === 'accounts'} 
            <AdminAccounts {targetStore} {isSuperAdmin} />
        {/if}
    </div>
</div>

<style>
    .animate-fadeIn { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); } 
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
</style>
--- END FILE: ./src/components/AdminModal.svelte ---

--- START FILE: ./src/components/CumulativeHistoryModal.svelte ---
<script>
    import { onMount } from 'svelte';
    import { db } from '../lib/firebase';
    import { doc, getDoc } from 'firebase/firestore';
    import { createEventDispatcher } from 'svelte';

    export let storeId;
    export let currentMonth; // 1-12
    export let currentYear;
    export let currentStats = []; // D·ªØ li·ªáu c·ªßa th√°ng hi·ªán t·∫°i (ƒë·ªÉ so s√°nh)

    const dispatch = createEventDispatcher();
    let loading = true;
    let historyData = []; 
    let aggregatedStats = [];
    let sortField = 'total_hours';
    let sortDirection = 'desc';

    // Reactive statement: Ch·∫°y l·∫°i khi input thay ƒë·ªïi v√† c√≥ gi√° tr·ªã h·ª£p l·ªá
    $: if (storeId && currentMonth && currentYear) {
        loadHistory();
    }

    async function loadHistory() {
        // 1. Ki·ªÉm tra an to√†n d·ªØ li·ªáu ƒë·∫ßu v√†o ƒë·ªÉ tr√°nh l·ªói NaN/undefined
        const mBase = Number(currentMonth);
        const yBase = Number(currentYear);

        if (!storeId || !mBase || !yBase || isNaN(mBase) || isNaN(yBase)) {
            return; // Ch∆∞a ƒë·ªß d·ªØ li·ªáu th√¨ ch∆∞a ch·∫°y
        }

        loading = true;
        historyData = [];
        
        // 2. V√≤ng l·∫∑p l·∫•y 3 th√°ng
        for (let i = 0; i < 3; i++) {
            let m = mBase - i;
            let y = yBase;
            
            if (m <= 0) { 
                m += 12; 
                y -= 1; 
            }

            const label = `T${m}/${y}`;
            const isCurrent = (i === 0);

            if (isCurrent) {
                historyData.push({
                    label: `${label} (Hi·ªán t·∫°i)`,
                    stats: currentStats || [],
                    isCurrent: true
                });
            } else {
                try {
                    const docId = `${y}-${String(m).padStart(2, '0')}`;
                    const snap = await getDoc(doc(db, 'stores', storeId, 'schedules', docId));
                    if (snap.exists()) {
                        const data = snap.data();
                        historyData.push({
                            label: label,
                            stats: data.stats || [],
                            isCurrent: false
                        });
                    } else {
                        historyData.push({ label: label, stats: [], isCurrent: false });
                    }
                } catch (e) {
                    console.error("L·ªói t·∫£i l·ªãch s·ª≠:", e);
                    historyData.push({ label: label, stats: [], isCurrent: false });
                }
            }
        }

        calculateAggregatedStats();
        loading = false;
    }

    function calculateAggregatedStats() {
        let map = {};

        historyData.forEach(monthItem => {
            monthItem.stats.forEach(s => {
                if (!map[s.id]) {
                    map[s.id] = {
                        id: s.id,
                        name: s.name,
                        gender: s.gender,
                        isMale: (s.gender || '').trim().toLowerCase() === 'nam',
                        details: {}, 
                        total: { hours: 0, gh: 0, tn: 0, kho: 0, weekend: 0 }
                    };
                }
                
                map[s.id].details[monthItem.label] = {
                    hours: s.totalHours || 0,
                    gh: s.gh || 0,
                    tn: s.tn || 0,
                    kho: s.kho || 0,
                    weekend: s.weekendHardRoles || 0 
                };

                map[s.id].total.hours += (s.totalHours || 0);
                map[s.id].total.gh += (s.gh || 0);
                map[s.id].total.tn += (s.tn || 0);
                map[s.id].total.kho += (s.kho || 0);
                map[s.id].total.weekend += (s.weekendHardRoles || 0);
            });
        });

        aggregatedStats = Object.values(map);
        handleSort(sortField); 
    }

    function handleSort(field) {
        if (sortField === field) {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
            sortField = field;
            sortDirection = 'desc';
        }

        aggregatedStats = aggregatedStats.sort((a, b) => {
            let valA = 0, valB = 0;
            
            if (field === 'name') {
                return sortDirection === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
            }
            
            switch(field) {
                case 'total_hours': valA = a.total.hours; valB = b.total.hours; break;
                case 'total_gh': valA = a.total.gh; valB = b.total.gh; break;
                case 'total_tn': valA = a.total.tn; valB = b.total.tn; break;
                case 'total_kho': valA = a.total.kho; valB = b.total.kho; break;
                case 'total_weekend': valA = a.total.weekend; valB = b.total.weekend; break;
            }

            return sortDirection === 'asc' ? valA - valB : valB - valA;
        });
    }
</script>

<div class="fixed inset-0 z-[100] bg-slate-900/60 flex items-center justify-center p-4 backdrop-blur-sm" on:click={() => dispatch('close')}>
    <div class="bg-white w-full max-w-[95%] xl:max-w-7xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-popIn" on:click|stopPropagation>
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
            <div>
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <span class="material-icons-round text-indigo-600">history_edu</span> 
                    L≈©y K·∫ø 3 Th√°ng G·∫ßn Nh·∫•t
                </h3>
            </div>
            <button class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition-colors" on:click={() => dispatch('close')}>
                <span class="material-icons-round text-slate-500">close</span>
            </button>
        </div>

        <div class="flex-1 overflow-auto bg-white">
            {#if loading}
                <div class="h-64 flex flex-col items-center justify-center text-slate-400">
                    <span class="material-icons-round animate-spin text-3xl mb-2 text-indigo-300">sync</span>
                    <span class="text-sm font-bold">ƒêang t·∫£i d·ªØ li·ªáu...</span>
                </div>
            {:else}
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-600 sticky top-0 z-10 shadow-sm text-xs uppercase tracking-wider">
                        <tr>
                            <th class="p-3 border-b border-r font-bold cursor-pointer hover:bg-slate-100 bg-slate-50 sticky left-0 z-20 min-w-[150px]" on:click={() => handleSort('name')}>
                                Nh√¢n S·ª± {sortField==='name'?(sortDirection==='asc'?'‚ñ≤':'‚ñº'):''}
                            </th>

                            <th class="p-2 border-b text-center bg-indigo-50 border-r border-indigo-100 text-indigo-800 font-bold cursor-pointer hover:bg-indigo-100 min-w-[60px]" on:click={() => handleSort('total_hours')}>
                                T·ªïng Gi·ªù {sortField==='total_hours'?(sortDirection==='asc'?'‚ñ≤':'‚ñº'):''}
                            </th>
                            <th class="p-2 border-b text-center bg-blue-50 border-r border-blue-100 text-blue-700 font-bold cursor-pointer hover:bg-blue-100 min-w-[50px]" on:click={() => handleSort('total_gh')}>
                                T.GH {sortField==='total_gh'?(sortDirection==='asc'?'‚ñ≤':'‚ñº'):''}
                            </th>
                            <th class="p-2 border-b text-center bg-purple-50 border-r border-purple-100 text-purple-700 font-bold cursor-pointer hover:bg-purple-100 min-w-[50px]" on:click={() => handleSort('total_tn')}>
                                T.TN {sortField==='total_tn'?(sortDirection==='asc'?'‚ñ≤':'‚ñº'):''}
                            </th>
                            <th class="p-2 border-b text-center bg-orange-50 border-r border-orange-100 text-orange-700 font-bold cursor-pointer hover:bg-orange-100 min-w-[50px]" on:click={() => handleSort('total_kho')}>
                                T.Kho {sortField==='total_kho'?(sortDirection==='asc'?'‚ñ≤':'‚ñº'):''}
                            </th>
                            <th class="p-2 border-b text-center bg-red-50 border-r border-red-100 text-red-700 font-bold cursor-pointer hover:bg-red-100 min-w-[60px]" title="T·ªïng ca nghi·ªáp v·ª• cu·ªëi tu·∫ßn" on:click={() => handleSort('total_weekend')}>
                                T.CT {sortField==='total_weekend'?(sortDirection==='asc'?'‚ñ≤':'‚ñº'):''}
                            </th>

                            {#each historyData as month}
                                <th class="p-2 border-b border-r text-center min-w-[120px] bg-white text-slate-500">
                                    <div class="font-bold {month.isCurrent ? 'text-indigo-600' : ''}">{month.label}</div>
                                    <div class="flex justify-center gap-1 text-[9px] font-normal opacity-60 mt-1">
                                        GH ¬∑ TN ¬∑ K ¬∑ CT
                                    </div>
                                </th>
                            {/each}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 text-xs">
                        {#each aggregatedStats as staff}
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="p-3 font-bold border-r border-slate-100 sticky left-0 bg-white z-10 {staff.isMale ? 'text-blue-600' : 'text-pink-600'}">
                                    {staff.name}
                                </td>

                                <td class="p-2 text-center font-black text-indigo-900 bg-indigo-50/30 border-r border-indigo-50 text-sm">{Math.round(staff.total.hours)}</td>
                                <td class="p-2 text-center font-bold text-blue-700 bg-blue-50/30 border-r border-blue-50">{staff.total.gh}</td>
                                <td class="p-2 text-center font-bold text-purple-700 bg-purple-50/30 border-r border-purple-50">{staff.total.tn}</td>
                                <td class="p-2 text-center font-bold text-orange-700 bg-orange-50/30 border-r border-orange-50">{staff.total.kho}</td>
                                <td class="p-2 text-center font-bold text-red-600 bg-red-50/30 border-r border-red-50">{staff.total.weekend}</td>

                                {#each historyData as month}
                                    {@const d = staff.details[month.label] || { hours:0, gh:0, tn:0, kho:0, weekend:0 }}
                                    <td class="p-2 text-center border-r border-slate-100 {month.isCurrent ? 'bg-yellow-50/20' : ''}">
                                        <div class="mb-1 font-bold text-slate-800">{Math.round(d.hours)}h</div>
                                        <div class="flex justify-center gap-1.5 text-[10px] text-slate-400">
                                            <span class="{d.gh>0?'text-blue-600 font-bold':''}">{d.gh||'-'}</span>
                                            <span>¬∑</span>
                                            <span class="{d.tn>0?'text-purple-600 font-bold':''}">{d.tn||'-'}</span>
                                            <span>¬∑</span>
                                            <span class="{d.kho>0?'text-orange-600 font-bold':''}">{d.kho||'-'}</span>
                                            <span>¬∑</span>
                                            <span class="{d.weekend>0?'text-red-500 font-bold':''}">{d.weekend||'-'}</span>
                                        </div>
                                    </td>
                                {/each}
                            </tr>
                        {/each}
                    </tbody>
                </table>
            {/if}
        </div>
    </div>
</div>

<style>
    .animate-popIn { animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes popIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
--- END FILE: ./src/components/CumulativeHistoryModal.svelte ---

--- START FILE: ./src/components/HandoverInput.svelte ---
<script>
  // Version 41.0 - Optimized Handover (Use Cache)
  import { onMount } from 'svelte';
  import { db } from '../lib/firebase';
  import { collection, addDoc, serverTimestamp, query, where, getDocs } from 'firebase/firestore';
  import { currentUser, storeUsersCache } from '../lib/stores'; // Import Cache
  import { getTodayStr } from '../lib/utils';

  let taskTitle = '', deadline = '';
  let selectedTargetStore = $currentUser?.storeIds?.[0] || ''; 
  $: myStores = $currentUser?.storeIds || [];

  let storeUsers = [];
  let showSuggestions = false;
  let suggestionList = [];
  let cursorPosition = 0;

  // Logic t·∫£i User th√¥ng minh
  $: if (selectedTargetStore) loadStoreUsersSmart(selectedTargetStore);

  async function loadStoreUsersSmart(storeId) {
      // 1. Ki·ªÉm tra trong Cache tr∆∞·ªõc
      if ($storeUsersCache[storeId]) {
          storeUsers = $storeUsersCache[storeId];
          // console.log("Loaded users from Cache");
          return;
      }

      // 2. N·∫øu ch∆∞a c√≥ th√¨ m·ªõi t·∫£i t·ª´ DB
      try {
          const q = query(collection(db, 'users'), where('storeIds', 'array-contains', storeId));
          const snap = await getDocs(q);
          const users = snap.docs.map(d => ({ username: d.data().username, name: d.data().name }));
          
          storeUsers = users;
          
          // 3. L∆∞u v√†o Cache
          storeUsersCache.update(c => ({ ...c, [storeId]: users }));
          // console.log("Loaded users from DB & Cached");
      } catch (e) { console.error(e); }
  }

  function handleInput(e) {
      const val = e.target.value;
      cursorPosition = e.target.selectionStart;
      const textBeforeCursor = val.slice(0, cursorPosition);
      const lastWord = textBeforeCursor.split(/\s+/).pop();

      if (lastWord.startsWith('@')) {
          const queryText = lastWord.slice(1).toLowerCase();
          suggestionList = storeUsers.filter(u => 
              u.name.toLowerCase().includes(queryText) || 
              u.username.toLowerCase().includes(queryText)
          );
          showSuggestions = true;
      } else { showSuggestions = false; }
  }

  function selectUser(user) {
      const textBeforeCursor = taskTitle.slice(0, cursorPosition);
      const textAfterCursor = taskTitle.slice(cursorPosition);
      const lastAtIndex = textBeforeCursor.lastIndexOf('@');
      taskTitle = textBeforeCursor.slice(0, lastAtIndex) + `@${user.username} ` + textAfterCursor;
      showSuggestions = false;
      document.getElementById('handover-input').focus();
  }

  async function addTask() {
    if (!taskTitle.trim()) return;
    try {
      const docRef = await addDoc(collection(db, 'tasks'), {
        type: 'handover', title: taskTitle, completed: false, createdBy: $currentUser?.name,
        deadline: deadline, date: getTodayStr(),
        storeId: selectedTargetStore, 
        timestamp: serverTimestamp()
      });

      const regex = /@([\w.-]+)/g;
      const matches = taskTitle.match(regex);
      
      if (matches) {
          const rawTags = matches.map(m => m.substring(1));
          const realTargets = [];
          
          rawTags.forEach(tag => {
              const foundUser = storeUsers.find(u => u.username.toLowerCase() === tag.toLowerCase());
              if (foundUser) realTargets.push(foundUser.username);
              else realTargets.push(tag); 
          });

          const uniqueTargets = [...new Set(realTargets)];
          const batchPromises = uniqueTargets.map(targetUser => {
              return addDoc(collection(db, 'notifications'), {
                  toUser: targetUser, 
                  fromUser: $currentUser.name || $currentUser.username,
                  content: `ƒë√£ nh·∫Øc ƒë·∫øn b·∫°n trong b√†n giao: "${taskTitle}"`,
                  taskId: docRef.id, 
                  targetTab: 'handover',
                  isRead: false, type: 'mention', createdAt: serverTimestamp()
              });
          });
          await Promise.all(batchPromises);
      }

      taskTitle = ''; deadline = '';
    } catch (err) { alert(err.message); }
  }
</script>

<div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-2 mb-4 animate-popIn relative">
  <div class="flex gap-2 items-center">
      {#if myStores.length > 1}
        <label for="store-select" class="sr-only">Ch·ªçn kho</label>
        <select id="store-select" bind:value={selectedTargetStore} class="p-2 border rounded-lg text-xs font-bold bg-indigo-50 text-indigo-700 outline-none cursor-pointer">
            {#each myStores as s}<option value={s}>{s}</option>{/each}
        </select>
      {/if}

      <div class="relative">
          <label for="deadline-input" class="sr-only">H·∫°n ch√≥t</label>
          <span class="absolute left-2 top-1/2 -translate-y-1/2 material-icons-round text-gray-400 text-sm">alarm</span>
          <input id="deadline-input" type="datetime-local" bind:value={deadline} class="pl-7 pr-2 py-2 border rounded-lg text-sm bg-gray-50 outline-none focus:bg-white focus:ring-2 focus:ring-purple-200 transition-all">
      </div>
  </div>

  <div class="flex gap-2 relative">
      <label for="handover-input" class="sr-only">N·ªôi dung c√¥ng vi·ªác</label>
      <input 
        id="handover-input"
        type="text" 
        bind:value={taskTitle} 
        on:input={handleInput}
        placeholder="Nh·∫≠p vi·ªác b√†n giao... (G√µ @ ƒë·ªÉ ch·ªçn ng∆∞·ªùi nh·∫≠n)" 
        class="flex-1 p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-purple-200 transition-all" 
        on:keydown={(e) => e.key === 'Enter' && !showSuggestions && addTask()}
      >
      <button class="w-10 h-10 bg-purple-600 text-white rounded-lg flex items-center justify-center shadow-md hover:bg-purple-700 active:scale-95 transition-all" on:click={addTask} aria-label="G·ª≠i c√¥ng vi·ªác"><span class="material-icons-round">send</span></button>
      
      {#if showSuggestions && suggestionList.length > 0}
        <div class="absolute bottom-full left-0 mb-1 w-64 bg-white border border-gray-200 rounded-lg shadow-xl z-50 max-h-48 overflow-y-auto">
             <div class="p-2 bg-gray-50 text-[10px] font-bold text-gray-500 border-b">CH·ªåN NG∆Ø·ªúI NH·∫ÆC T√äN</div>
            {#each suggestionList as user}
                <button class="w-full text-left p-2 hover:bg-indigo-50 flex items-center gap-2 transition-colors border-b border-gray-50 last:border-0" on:click={() => selectUser(user)}>
                    <div class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-[10px] font-bold">
                         {user.name.charAt(0)}
                    </div>
                    <div>
                         <div class="text-xs font-bold text-gray-800">{user.name}</div>
                        <div class="text-[10px] text-gray-400">@{user.username}</div>
                    </div>
                </button>
            {/each}
        </div>
      {/if}
  </div>
</div>
<style>.animate-popIn { animation: popIn 0.3s ease-out; } @keyframes popIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }</style>
--- END FILE: ./src/components/HandoverInput.svelte ---

--- START FILE: ./src/components/Header.svelte ---
<script>
  // Version 11.1 - FULL CODE (Restored Profile Logic + Fixes)
  import { createEventDispatcher, onMount, onDestroy } from 'svelte';
  import { currentUser, setUser } from '../lib/stores';
  import { db } from '../lib/firebase';
  import { doc, updateDoc, collection, query, where, onSnapshot, orderBy, limit } from 'firebase/firestore';
  import NotificationDropdown from './NotificationDropdown.svelte';
  
  const dispatch = createEventDispatcher();
  
  // --- LOGIC PWA ---
  let deferredPrompt;
  let showInstallBtn = false;
  
  onMount(() => {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallBtn = true;
    });

    const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
    const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
    
    if (isIos && !isInStandaloneMode) {
      showInstallBtn = true;
    }
    if ($currentUser?.role?.includes('admin')) {
      showInstallBtn = true;
    }
  });

  function handleInstall() {
    const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
    if (isIos) {
      dispatch('openIosGuide');
    } else if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            showInstallBtn = false;
        }
        deferredPrompt = null;
      });
    } else {
      if (confirm("‚ö†Ô∏è Tr√¨nh duy·ªát ch·∫∑n c√†i t·ª± ƒë·ªông. Xem h∆∞·ªõng d·∫´n c√†i th·ªß c√¥ng?")) {
          alert("üëâ H∆∞·ªõng d·∫´n: B·∫•m menu (‚ãÆ) -> Ch·ªçn 'Th√™m v√†o m√†n h√¨nh ch√≠nh' (Install App).");
      }
    }
  }

  function handleLogout() {
    if(confirm("ƒêƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?")) {
        setUser(null);
        window.location.reload();
    }
  }

  // --- LOGIC ƒê·ªîI M·∫¨T KH·∫®U (ƒê√£ kh√¥i ph·ª•c ƒë·∫ßy ƒë·ªß) ---
  let showProfileModal = false;
  let oldPass = '';
  let newPass = '';
  let changePassLoading = false;

  async function handleChangePassword() {
      if (!oldPass || !newPass) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
      if (oldPass !== $currentUser.pass) return alert("M·∫≠t kh·∫©u c≈© kh√¥ng ch√≠nh x√°c!");
      if (newPass.length < 6) return alert("M·∫≠t kh·∫©u m·ªõi ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n!");

      changePassLoading = true;
      try {
          await updateDoc(doc(db, 'users', $currentUser.username), { pass: newPass });
          const updatedUser = { ...$currentUser, pass: newPass };
          setUser(updatedUser);
          alert("‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!");
          showProfileModal = false;
          oldPass = ''; newPass = '';
      } catch (e) { 
          alert("L·ªói: " + e.message); 
      } finally { 
          changePassLoading = false;
      }
  }

  // --- LOGIC TH√îNG B√ÅO (T·ªëi ∆∞u Performance & Fix Leak) ---
  let notifications = [];
  let unreadCount = 0;
  let showNotifDropdown = false;
  let unsubNotif = null; // Kh·ªüi t·∫°o null ƒë·ªÉ qu·∫£n l√Ω state
  let notifContainer;

  // H√†m x·ª≠ l√Ω click ra ngo√†i ƒë·ªÉ ƒë√≥ng dropdown
  function handleWindowClick(event) {
      if (showNotifDropdown && notifContainer && !notifContainer.contains(event.target)) {
          showNotifDropdown = false;
      }
  }

  // Chuy·ªÉn ti·∫øp s·ª± ki·ªán nh·∫£y t·ªõi task t·ª´ Dropdown l√™n App
  function forwardJump(event) {
      dispatch('jumpToTask', event.detail);
      showNotifDropdown = false;
  }

  // Reactive Statement: Qu·∫£n l√Ω k·∫øt n·ªëi Firebase an to√†n
  $: if ($currentUser) {
      // 1. D·ªçn d·∫πp listener c≈© n·∫øu c√≥ (Quan tr·ªçng ƒë·ªÉ tr√°nh ƒë∆° m√°y)
      if (unsubNotif) {
          unsubNotif();
          unsubNotif = null;
      }

      // 2. T·∫°o bi·∫øn th·ªÉ t√™n user (Hoa/Th∆∞·ªùng) ƒë·ªÉ b·∫Øt m·ªçi th√¥ng b√°o
      const username = $currentUser.username;
      const userVariants = [...new Set([username, username.toLowerCase()])];
      
      const q = query(
          collection(db, 'notifications'), 
          where('toUser', 'in', userVariants),
          orderBy('createdAt', 'desc'),
          limit(20)
      );
      
      // 3. Kh·ªüi t·∫°o listener m·ªõi
      unsubNotif = onSnapshot(q, (snapshot) => {
          notifications = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
          unreadCount = notifications.filter(n => !n.isRead).length;
      }, (error) => {
          console.error("L·ªói t·∫£i th√¥ng b√°o:", error);
          if (error.message.includes("indexes")) {
              console.log("%cüëá B·∫§M V√ÄO ƒê√ÇY T·∫†O INDEX üëá", "color: red; font-size: 16px; font-weight: bold;");
              // Link index s·∫Ω hi·ªán trong console tr√¨nh duy·ªát
          }
      });
  }

  // D·ªçn d·∫πp khi component b·ªã h·ªßy
  onDestroy(() => {
      if (unsubNotif) unsubNotif();
  });
</script>

<svelte:window on:click={handleWindowClick} />

<header class="app-header bg-white shadow-sm px-4 py-3 flex justify-between items-center z-50 shrink-0 sticky top-0">
  <button class="flex items-center gap-3 hover:bg-gray-50 p-1 rounded-lg transition-colors text-left max-w-[50%]" on:click={() => showProfileModal = true}>
    <div class="w-9 h-9 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center font-bold text-sm border border-indigo-200 shadow-sm shrink-0">
      {$currentUser?.name?.charAt(0).toUpperCase() || 'U'}
    </div>
    <div class="flex flex-col justify-center overflow-hidden">
      <span class="font-bold text-gray-800 text-sm leading-tight truncate w-full">{$currentUser?.name || 'User'}</span>
      <span class="text-[10px] font-bold text-green-600 flex items-center gap-1">
        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online
      </span>
    </div>
  </button>
  
  <div class="flex items-center gap-2 relative">
    {#if showInstallBtn}
      <button 
        id="btn-install"
        class="w-8 h-8 flex items-center justify-center text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-full transition-colors animate-bounce border border-blue-200" 
        on:click={handleInstall}
        title="C√†i ƒë·∫∑t App"
      >
        <span class="material-icons-round text-xl">download</span>
      </button>
    {/if}

    <button 
      id="btn-help"
      class="w-8 h-8 flex items-center justify-center text-purple-500 bg-purple-50 hover:bg-purple-100 rounded-full transition-colors" 
      on:click={() => dispatch('openTour')} 
      title="Xem h∆∞·ªõng d·∫´n"
    >
      <span class="material-icons-round text-xl">help_outline</span>
    </button>

    <div class="relative" bind:this={notifContainer}>
        <button 
            id="btn-notif"
            class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-slate-50 rounded-full transition-all {unreadCount > 0 ? 'animate-wiggle' : ''}" 
            on:click={() => showNotifDropdown = !showNotifDropdown} 
            title="Th√¥ng b√°o"
        >
            <span class="material-icons-round text-xl">notifications</span>
            {#if unreadCount > 0}
                <span class="absolute top-0 right-0 w-4 h-4 bg-red-500 text-white text-[9px] font-bold flex items-center justify-center rounded-full border-2 border-white">
                    {unreadCount > 9 ? '9+' : unreadCount}
                </span>
            {/if}
        </button>
        {#if showNotifDropdown}
            <NotificationDropdown {notifications} on:close={() => showNotifDropdown = false} on:jumpToTask={forwardJump} />
        {/if}
    </div>

    {#if $currentUser?.role === 'admin' || $currentUser?.role === 'super_admin'}
      <button 
        id="btn-admin"
        class="w-8 h-8 flex items-center justify-center text-orange-500 bg-orange-50 hover:bg-orange-100 rounded-full transition-colors" 
        on:click={() => dispatch('openAdmin')} 
        title="C√†i ƒë·∫∑t"
      >
        <span class="material-icons-round text-xl">settings</span>
      </button>
    {/if}
  </div>
</header>

{#if showProfileModal}
<div class="fixed inset-0 z-[100] bg-slate-900/60 flex items-center justify-center p-4 backdrop-blur-sm" on:click={() => showProfileModal = false}>
    <div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl animate-popIn" on:click|stopPropagation>
        <div class="text-center mb-4">
            <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-2 text-2xl font-bold border-2 border-indigo-200">
                {$currentUser?.name?.charAt(0).toUpperCase()}
            </div>
            <h3 class="font-bold text-lg text-slate-800">{$currentUser?.name}</h3>
            <p class="text-xs text-gray-500">{$currentUser?.username}</p>
        </div>
        
        <div class="space-y-3">
            <div class="pt-2 border-t border-dashed border-slate-200">
                <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">ƒê·ªïi m·∫≠t kh·∫©u</h4>
                <div>
                    <input type="password" bind:value={oldPass} placeholder="M·∫≠t kh·∫©u c≈©" class="w-full mb-2 p-2 border border-slate-200 rounded-lg outline-none focus:border-indigo-500 text-sm">
                </div>
                <div>
                    <input type="password" bind:value={newPass} placeholder="M·∫≠t kh·∫©u m·ªõi (6+ k√Ω t·ª±)" class="w-full mb-2 p-2 border border-slate-200 rounded-lg outline-none focus:border-indigo-500 text-sm">
                </div>
                <button class="w-full py-2 bg-indigo-600 text-white font-bold rounded-xl shadow hover:bg-indigo-700 disabled:opacity-50 text-sm" on:click={handleChangePassword} disabled={changePassLoading}>
                    {changePassLoading ? 'ƒêang l∆∞u...' : 'X√°c nh·∫≠n ƒë·ªïi'}
                </button>
            </div>

            <button class="w-full py-2 bg-red-50 text-red-600 font-bold rounded-xl hover:bg-red-100 flex items-center justify-center gap-2 mt-4 text-sm" on:click={handleLogout}>
                <span class="material-icons-round text-lg">logout</span> ƒêƒÉng Xu·∫•t
            </button>
        </div>
    </div>
</div>
{/if}

<style>
    .animate-popIn { animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); } 
    @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes wiggle { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } }
    .animate-wiggle { animation: wiggle 0.5s ease-in-out infinite; }
</style>
--- END FILE: ./src/components/Header.svelte ---

--- START FILE: ./src/components/InstallmentCalc.svelte ---
<script>
    // Component: T√≠nh Tr·∫£ G√≥p (File 2 - Integrated History v2.0)
    import { onMount } from 'svelte'; // [ADDED] C·∫ßn cho LocalStorage

    // --- STATE ---
    let productPrice = 0;
    // Gi√° b√°n (d√πng ƒë·ªÉ t√≠nh tr·∫£ tr∆∞·ªõc)
    let originalBasePrice = 0;
    // Gi√° g·ªëc (d√πng ƒë·ªÉ t√≠nh BH 1-1)

    // Tr·∫£ tr∆∞·ªõc
    let downPaymentType = 'percent';
    let downPaymentPercent = 0; 
    let downPaymentAmount = 0;
    
    // C·∫•u h√¨nh
    let interestPackage = 0;
    let termMonths = 6;
    
    // B·∫£o hi·ªÉm 1-1
    let selectedBh11Group = 'none';

    // --- [NEW] STATE HISTORY & TABS ---
    let activeTab = 'calc'; 
    let history = [];

    // --- [NEW] LOGIC HISTORY (From File Mau) ---
    onMount(() => {
        // N·∫†P L·ªäCH S·ª¨ T·ª™ TR√åNH DUY·ªÜT (LocalStorage)
        const savedHistory = localStorage.getItem('installment_history_v2'); // ƒê·ªïi key m·ªôt ch√∫t ƒë·ªÉ kh√¥ng ƒë·ª•ng file c≈© n·∫øu ch·∫°y chung domain
        if (savedHistory) {
            try {
                history = JSON.parse(savedHistory);
            } catch (e) {
                console.error('L·ªói ƒë·ªçc l·ªãch s·ª≠ c≈©', e);
            }
        }
    });

    // T·ª∞ ƒê·ªòNG L∆ØU V√ÄO TR√åNH DUY·ªÜT
    $: {
        if (history) {
            localStorage.setItem('installment_history_v2', JSON.stringify(history));
        }
    }

    // --- FORMATTER ---
    const formatCurrency = (val) => {
        if (!val || isNaN(val)) return '0';
        return Math.round(val).toLocaleString('vi-VN');
    };

    const parseNumber = (str) => {
        return Number(String(str).replace(/[^0-9]/g, '')) ||
        0;
    };

    // --- LOGIC NH·∫¨P LI·ªÜU GI√Å B√ÅN ---
    let displayPrice = "";
    function handlePriceInput(e) {
        const raw = parseNumber(e.target.value);
        productPrice = raw;
        displayPrice = formatCurrency(raw);
        recalcDownPayment();
    }

    // --- LOGIC NH·∫¨P LI·ªÜU GI√Å G·ªêC (CHO BH 1-1) ---
    let displayBasePrice = "";
    function handleBasePriceInput(e) {
        const raw = parseNumber(e.target.value);
        originalBasePrice = raw;
        displayBasePrice = formatCurrency(raw);
    }

    // --- LOGIC TR·∫¢ TR∆Ø·ªöC ---
    function handleDownPaymentPercentInput(e) {
        let val = parseFloat(e.target.value);
        if (isNaN(val)) val = 0;
        if (val > 100) val = 100;
        if (val < 0) val = 0;
        downPaymentPercent = val;
        recalcDownPayment();
    }

    let displayDownPaymentAmount = "";
    function handleDownPaymentAmountInput(e) {
        const raw = parseNumber(e.target.value);
        downPaymentAmount = raw;
        if (downPaymentAmount > productPrice) downPaymentAmount = productPrice;
        displayDownPaymentAmount = formatCurrency(downPaymentAmount);
        if (productPrice > 0) {
            downPaymentPercent = (downPaymentAmount / productPrice) * 100;
        } else {
            downPaymentPercent = 0;
        }
    }

    function recalcDownPayment() {
        if (downPaymentType === 'percent') {
            downPaymentAmount = (productPrice * downPaymentPercent) / 100;
            displayDownPaymentAmount = formatCurrency(downPaymentAmount);
        } else {
             if (productPrice > 0) {
                downPaymentPercent = (downPaymentAmount / productPrice) * 100;
            }
        }
    }

    function setDownType(type) {
        downPaymentType = type;
        recalcDownPayment();
    }

    // --- LOGIC T√çNH TO√ÅN (Gi·ªØ nguy√™n c·ªßa File 2) ---

    // 1. Ph√≠ BH 1-1 (D·ª±a tr√™n GI√Å G·ªêC - originalBasePrice)
    $: bh11Fee = (() => {
        const p = originalBasePrice; // D√πng gi√° g·ªëc ƒë·ªÉ t√≠nh ph√≠
        if (selectedBh11Group === 'none' || p === 0) return 0;

        // --- NH√ìM C≈® (Theo m·ª©c gi√° c·ªë ƒë·ªãnh) ---
        // Nh√≥m 1: M√°y L·∫°nh
        if (selectedBh11Group === 'air_conditioner') {
            return p <= 10000000 ? 250000 : 350000;
        }
        // Nh√≥m 2: T·ªß l·∫°nh, ƒë√¥ng, m√°t
        if (selectedBh11Group === 'fridge') {
            if (p <= 10000000) return 400000;
            if (p <= 25000000) return 700000;
            return 1350000;
        }
        // Nh√≥m 3: M√°y gi·∫∑t, s·∫•y
        if (selectedBh11Group === 'washer') {
            if (p <= 10000000) return 400000;
            if (p <= 25000000) return 700000;
            return 1350000;
        }
        // Nh√≥m 4: M√°y l·ªçc n∆∞·ªõc
        if (selectedBh11Group === 'water_purifier') {
            if (p <= 8000000) return 280000;
            if (p <= 11000000) return 380000;
            return 460000;
        }

        // --- NH√ìM M·ªöI (Theo % + Min 200k) ---
        // Smartphone: 4.62%
        if (selectedBh11Group === 'smartphone') {
            const fee = p * 0.0462;
            return fee < 200000 ? 200000 : fee;
        }
        // Laptop - Tablet: 6.0%
        if (selectedBh11Group === 'laptop_tablet') {
            const fee = p * 0.06;
            return fee < 200000 ? 200000 : fee;
        }
        // Smart Watch: 5.5%
        if (selectedBh11Group === 'smart_watch') {
            const fee = p * 0.055;
            return fee < 200000 ? 200000 : fee;
        }
        // ƒêi·ªán t·ª≠ (Tivi): 7.0% (Kh√¥ng √°p Min 200k theo ƒë·ªÅ b√†i, ho·∫∑c √°p d·ª•ng n·∫øu c·∫ßn)
        if (selectedBh11Group === 'tv') {
            return p * 0.07;
        }

        return 0;
    })();

    // 2. T√≠nh to√°n tr·∫£ g√≥p
    $: loanAmount = Math.max(0, productPrice - downPaymentAmount);
    $: bhkvBase = (loanAmount > 0 && loanAmount <= 5000000) ? 5000000 : loanAmount;
    $: bhkvRatePercent = (() => {
        if (termMonths <= 6) return 2.6;
        if (termMonths <= 9) return 2.9;
        return 3.5;
    })();
    $: bhkvValue = loanAmount > 0 ? (bhkvBase * bhkvRatePercent / 100) : 0;
    $: monthlyBase = (loanAmount > 0 && termMonths > 0) ? (loanAmount / termMonths) : 0;
    $: monthlyFee = 12000;
    $: monthlyPayment = monthlyBase + monthlyFee;

    $: totalInstallmentAmount = monthlyPayment * termMonths;
    $: finalTotalPrice = downPaymentAmount + bhkvValue + bh11Fee + totalInstallmentAmount;
    // T·ªïng ti·ªÅn ph·∫£i ƒë∆∞a tr∆∞·ªõc (G·ªìm BH 1-1)
    $: totalPrepaid = downPaymentAmount + bhkvValue + bh11Fee;
    $: diffPrice = finalTotalPrice - productPrice;

    // --- [NEW] LOGIC HISTORY ACTIONS ---
    function saveToHistory() {
        if (productPrice === 0) return;
        const newItem = {
            id: Date.now(),
            timestamp: new Date().toLocaleString('vi-VN', { hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'}),
            price: productPrice,
            prepaid: totalPrepaid,
            monthly: monthlyPayment,
            term: termMonths,
            diff: diffPrice,
            selected: false 
        };
        history = [newItem, ...history].slice(0, 10);
    }

    function deleteHistoryItem(id) {
        history = history.filter(item => item.id !== id);
    }

    function clearHistory() {
        if(confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠?')) {
            history = [];
        }
    }

    function clearSelection() {
        history = history.map(item => ({...item, selected: false}));
    }

    $: selectedItems = history.filter(h => h.selected);
    $: comboTotalProductPrice = selectedItems.reduce((sum, item) => sum + item.price, 0);
    $: comboTotalPrepaid = selectedItems.reduce((sum, item) => sum + item.prepaid, 0);
    $: comboTotalMonthly = selectedItems.reduce((sum, item) => sum + item.monthly, 0);

</script>

<div class="h-full flex flex-col bg-slate-50 relative pb-64 overflow-y-auto">
    
    <div class="bg-white px-2 pt-1 pb-0 z-10 flex gap-2 border-b border-slate-200 sticky top-0">
        <button 
            class="flex-1 pb-2 text-sm font-bold uppercase transition-all border-b-2 {activeTab === 'calc' ?
            'text-indigo-600 border-indigo-600' : 'text-slate-400 border-transparent hover:text-slate-600'}"
            on:click={() => activeTab = 'calc'}
        >
            T√≠nh To√°n
        </button>
        <button 
            class="flex-1 pb-2 text-sm font-bold uppercase transition-all border-b-2 {activeTab === 'history' ?
            'text-indigo-600 border-indigo-600' : 'text-slate-400 border-transparent hover:text-slate-600'}"
            on:click={() => activeTab = 'history'}
        >
            L·ªãch S·ª≠ <span class="ml-1 text-[10px] bg-slate-100 px-1.5 py-0.5 rounded-full text-slate-500">{history.length}</span>
        </button>
    </div>

    {#if activeTab === 'calc'}
    <div class="p-2 space-y-2 animate-fadeIn">
        
        <div class="flex gap-2">
            <div class="bg-white p-2.5 rounded-lg shadow-sm border border-slate-200 flex-[2]">
                <label class="text-[9px] font-bold text-slate-400 uppercase mb-0.5 block">Gi√° B√°n (ƒê·ªÉ t√≠nh vay)</label>
                <div class="relative">
                    <input 
                        type="text" 
                        inputmode="numeric"
                        value={displayPrice} 
                        on:input={handlePriceInput}
                        class="w-full text-xl font-black text-indigo-700 outline-none border-b border-slate-200 focus:border-indigo-500 py-0 bg-transparent placeholder-slate-300"
                        placeholder="0"
                    >
                    <span class="absolute right-0 bottom-1 text-[10px] font-bold text-slate-400">VNƒê</span>
                </div>
            </div>

            <div class="bg-white p-2.5 rounded-lg shadow-sm border border-slate-200 flex-1 min-w-[80px] opacity-70">
                <label class="text-[9px] font-bold text-slate-400 uppercase mb-0.5 block">L√£i Su·∫•t</label>
                <div class="relative">
                    <input 
                        type="number" 
                        bind:value={interestPackage}
                        class="w-full text-xl font-bold text-slate-700 outline-none border-b border-slate-200 py-0 bg-transparent text-center"
                        readonly
                    >
                    <span class="absolute right-0 bottom-1 text-[10px] font-bold text-slate-400">%</span>
                </div>
            </div>
        </div>

        <div class="bg-white p-2.5 rounded-lg shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-1">
                <label class="text-[9px] font-bold text-slate-400 uppercase">Tr·∫£ Tr∆∞·ªõc (G·ªëc)</label>
                <div class="flex bg-slate-100 rounded p-0.5 border border-slate-200">
                    <button 
                        class="px-2 py-0.5 rounded text-[9px] font-bold transition-all {downPaymentType==='percent' ?
                        'bg-white text-indigo-600 shadow-sm' : 'text-gray-400'}"
                        on:click={()=>setDownType('percent')}
                    >%</button>
                    <button 
                        class="px-2 py-0.5 rounded text-[9px] font-bold transition-all {downPaymentType==='amount' 
                        ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-400'}"
                        on:click={()=>setDownType('amount')}
                    >VNƒê</button>
                </div>
            </div>

            <div class="flex items-end gap-2">
                {#if downPaymentType === 'percent'}
                    <div class="w-16 relative shrink-0">
                        <input 
                            type="number" 
                            bind:value={downPaymentPercent}
                            on:input={handleDownPaymentPercentInput}
                            on:focus={(e) => e.target.select()} 
                            class="w-full text-lg font-bold text-indigo-600 outline-none border-b-2 border-indigo-100 focus:border-indigo-500 py-0 text-center bg-transparent"
                        >
                        <span class="absolute right-0 bottom-1 text-[9px] font-bold text-indigo-300">%</span>
                    </div>
                    <div class="flex-1 text-right pb-1 border-b border-slate-100">
                        <div class="text-[9px] font-bold text-slate-400">Th√†nh ti·ªÅn:</div>
                        <div class="text-sm font-black text-slate-700">{formatCurrency(downPaymentAmount)}</div>
                    </div>
                {:else}
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            inputmode="numeric"
                            value={displayDownPaymentAmount}
                            on:input={handleDownPaymentAmountInput}
                            class="w-full text-lg font-bold text-indigo-600 outline-none border-b-2 border-indigo-100 focus:border-indigo-500 py-0 
                            bg-transparent"
                            placeholder="0"
                        >
                        <span class="absolute right-0 bottom-1 text-[9px] font-bold text-indigo-300">VNƒê</span>
                    </div>
                {/if}
            </div>
            
            <div class="mt-1 flex justify-between items-center bg-orange-50 px-2 py-0.5 rounded">
                <span class="text-[9px] font-bold text-orange-400 uppercase">C·∫ßn Vay</span>
                <span class="text-xs font-black text-orange-600">{formatCurrency(loanAmount)}</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
            
            <div class="bg-white p-2 rounded-lg shadow-sm border border-slate-200">
                <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">K·ª≥ H·∫°n</label>
                <div class="flex items-center gap-1">
                    <button class="w-8 h-8 rounded bg-slate-100 text-indigo-600 font-bold flex items-center justify-center active:scale-90" on:click={()=>termMonths = Math.max(1, termMonths-1)}>-</button>
                    <div class="flex-1 relative text-center">
                         <input 
                            type="number" 
                            bind:value={termMonths}
                            min="1"
                            class="w-full text-xl font-black text-slate-700 outline-none border-none bg-transparent text-center p-0 m-0"
                        >
                         <span class="text-[9px] text-slate-400 font-bold block -mt-1">Th√°ng</span>
                    </div>
                    <button class="w-8 h-8 rounded bg-slate-100 text-indigo-600 font-bold flex items-center justify-center active:scale-90" on:click={()=>termMonths++}>+</button>
                </div>
            </div>

            <div class="bg-white p-2 rounded-lg shadow-sm border border-slate-200 flex flex-col justify-between">
                <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">B·∫£o Hi·ªÉm 1-1</label>
                <select 
                    bind:value={selectedBh11Group}
                    class="w-full text-[11px] font-bold text-slate-700 bg-slate-50 border border-slate-200 rounded py-1.5 px-1 outline-none focus:border-indigo-500"
                >
                    <option value="none">Kh√¥ng ch·ªçn</option>
                    <option value="air_conditioner">M√°y L·∫°nh</option>
                    <option value="fridge">T·ªß l·∫°nh, ƒê√¥ng, M√°t</option>
                    <option value="washer">M√°y Gi·∫∑t, S·∫•y</option>
                    <option value="water_purifier">M√°y L·ªçc N∆∞·ªõc</option>
                    <option value="smartphone">Smartphone (4.62%)</option>
                    <option value="laptop_tablet">Laptop - Tablet (6.0%)</option>
                    <option value="smart_watch">Smart Watch (5.5%)</option>
                    <option value="tv">ƒêi·ªán t·ª≠ - Tivi (7.0%)</option>
                </select>
                {#if bh11Fee > 0}
                    <div class="text-[10px] text-right font-bold text-indigo-600 mt-1">+{formatCurrency(bh11Fee)}ƒë</div>
                {/if}
            </div>
        </div>

        {#if selectedBh11Group !== 'none'}
            <div class="bg-indigo-50/50 p-2.5 rounded-lg shadow-sm border border-indigo-100 animate-slideUp">
                <label class="text-[9px] font-bold text-indigo-500 uppercase mb-0.5 block flex items-center gap-1">
                    <span class="material-icons-round text-[10px]">price_check</span> Nh·∫≠p Gi√° M√°y G·ªëc (ƒê·ªÉ t√≠nh ph√≠ BH)
                </label>
                
                <div class="relative">
                    <input 
                        type="text" 
                        inputmode="numeric"
                        value={displayBasePrice} 
                        on:input={handleBasePriceInput}
                        class="w-full text-lg font-black text-indigo-700 outline-none border-b border-indigo-200 focus:border-indigo-500 py-0 bg-transparent placeholder-indigo-300"
                        placeholder="Nh·∫≠p gi√° g·ªëc..."
                    >
                    <span class="absolute right-0 bottom-1 text-[10px] font-bold text-indigo-400">VNƒê</span>
                </div>
            </div>
        {/if}

    </div>
    {/if}

    {#if activeTab === 'history'}
        <div class="p-2 space-y-2 animate-fadeIn pb-24">
            {#if history.length === 0}
                <div class="text-center py-10 opacity-40">
                    <span class="material-icons-round text-4xl mb-2 text-slate-300">history</span>
                    <p class="text-xs font-bold text-slate-400">Ch∆∞a c√≥ l·ªãch s·ª≠ t√≠nh to√°n</p>
                </div>
            {:else}
                <div class="flex justify-between items-center px-1 mb-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Ch·ªçn ƒë·ªÉ t√≠nh Combo</span>
                    <button on:click={clearHistory} class="text-[10px] font-bold text-red-400 hover:text-red-600 uppercase">X√≥a h·∫øt</button>
                </div>
                {#each history as item (item.id)}
                    <label class="bg-white p-3 rounded-lg shadow-sm border {item.selected ?
                    'border-indigo-500 ring-1 ring-indigo-500' : 'border-slate-200'} relative group animate-slideIn flex gap-3 cursor-pointer select-none transition-all">
                        
                        <div class="flex items-center justify-center">
                            <input 
                                type="checkbox" 
                                bind:checked={item.selected}
                                class="w-5 h-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500 accent-indigo-600"
                            >
                        </div>

                        <div class="flex-1">
                            <button 
                                class="absolute top-2 right-2 text-slate-300 hover:text-red-500 p-1 z-10"
                                on:click|preventDefault|stopPropagation={() => deleteHistoryItem(item.id)}
                            >
                                <span class="material-icons-round text-base">close</span>
                            </button>
                            
                            <div class="flex items-center gap-2 mb-2 pr-6">
                                <span class="text-[9px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">{item.timestamp}</span>
                                <span class="text-[10px] font-bold text-slate-500">Gi√° b√°n:</span>
                                <span class="text-xs font-black text-indigo-700">{formatCurrency(item.price)} ƒë</span>
                            </div>

                            <div class="grid grid-cols-3 gap-2 text-center bg-slate-50 rounded p-2 border border-slate-100">
                                <div>
                                    <div class="text-[8px] font-bold text-slate-400 uppercase">Tr·∫£ Tr∆∞·ªõc</div>
                                    <div class="text-[10px] font-bold text-slate-700">{formatCurrency(item.prepaid)}</div>
                                </div>
                                <div>
                                    <div class="text-[8px] font-bold text-slate-400 uppercase">G√≥p/Th√°ng</div>
                                    <div class="text-[10px] font-bold text-indigo-600">{formatCurrency(item.monthly)}</div>
                                </div>
                                <div>
                                    <div class="text-[8px] font-bold text-slate-400 uppercase">K·ª≥ H·∫°n</div>
                                    <div class="text-[10px] font-bold text-slate-700">{item.term} Th</div>
                                </div>
                            </div>
                        </div>
                    </label>
                {/each}
            {/if}
        </div>
    {/if}

    <div class="h-6"></div>

    {#if activeTab === 'calc'}
    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-[60] rounded-t-xl animate-slideUp pb-6">
        <div class="p-3 max-w-md mx-auto">
            
            <div class="flex justify-between items-end mb-2">
                <div>
                    <div class="text-[9px] font-bold text-slate-400 uppercase">G√≥p m·ªói th√°ng (ƒê√£ +12k ph√≠ thu h·ªô)</div>
                    <div class="text-3xl font-black text-indigo-600 tracking-tighter leading-none">
                        {formatCurrency(Math.round(monthlyPayment))} <small class="text-sm text-slate-500 font-bold">ƒë</small>
                    </div>
                </div>
                <button 
                    on:click={saveToHistory}
                    class="bg-indigo-50 hover:bg-indigo-100 active:bg-indigo-200 text-indigo-600 p-2 rounded-lg flex flex-col items-center justify-center transition-all border border-indigo-100"
                    title="L∆∞u v√†o l·ªãch s·ª≠"
                >
                    <span class="material-icons-round text-xl">save</span>
                    <span class="text-[8px] font-bold uppercase mt-0.5">L∆∞u</span>
                </button>
            </div>

            <div class="flex gap-2 mb-2">
                <div class="flex-1 bg-slate-50 rounded p-1.5 border border-slate-100 text-center">
                    <div class="text-[8px] font-bold text-slate-400 uppercase">BHKV ({bhkvRatePercent}%)</div>
                    <div class="text-xs font-bold text-slate-700">{formatCurrency(Math.round(bhkvValue))}</div>
                </div>
                {#if bh11Fee > 0}
                    <div class="flex-1 bg-indigo-50 rounded p-1.5 border border-indigo-100 text-center">
                        <div class="text-[8px] font-bold text-indigo-400 uppercase">BH 1 ƒê·ªïi 1</div>
                        <div class="text-xs font-bold text-indigo-700">{formatCurrency(bh11Fee)}</div>
                    </div>
                {/if}
            </div>

            <div class="space-y-1">
                <div class="flex justify-between items-center text-sm bg-teal-50 -mx-3 px-3 py-1.5 border-y border-teal-100">
                    <span class="text-teal-800 font-bold text-xs uppercase">T·ªïng Ti·ªÅn ƒê∆∞a Tr∆∞·ªõc:</span>
                    <span class="font-black text-teal-700 text-base">{formatCurrency(Math.round(totalPrepaid))} ƒë</span>
                </div>
                
                <div class="flex justify-between items-center text-[10px] pt-1 px-1">
                    <span class="text-slate-500">Gi√° b√°n: <b class="text-slate-700">{formatCurrency(productPrice)}</b></span>
                    <span class="text-slate-500">T·ªïng g√≥p: <b class="text-indigo-700">{formatCurrency(Math.round(finalTotalPrice))}</b></span>
                    <span class="text-orange-600 font-bold">L·ªách: +{formatCurrency(Math.round(diffPrice))}</span>
                </div>
            </div>

            <div class="text-center mt-2 opacity-30">
                <span class="text-[8px] font-mono font-bold text-slate-500">Design by 3031</span>
            </div>

        </div>
    </div>
    {/if}

    {#if activeTab === 'history' && selectedItems.length > 0}
    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-indigo-200 shadow-[0_-4px_20px_rgba(0,0,0,0.15)] z-[60] rounded-t-xl animate-slideUp pb-6 bg-indigo-50">
        <div class="p-3 max-w-md mx-auto">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] font-bold text-indigo-400 uppercase">ƒêang ch·ªçn: {selectedItems.length} ƒë∆°n</span>
                <button 
                    on:click={clearSelection}
                    class="text-[10px] font-bold text-red-500 hover:text-red-700 uppercase bg-white px-2 py-0.5 rounded shadow-sm border border-red-100"
                >
                    B·ªè ch·ªçn t·∫•t c·∫£
                </button>
            </div>
            
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-white p-2 rounded shadow-sm border border-indigo-100 text-center">
                    <div class="text-[8px] font-bold text-slate-400 uppercase">T·ªïng Gi√° B√°n</div>
                    <div class="text-[13px] font-black text-slate-700">{formatCurrency(comboTotalProductPrice)}<small>ƒë</small></div>
                </div>
                <div class="bg-white p-2 rounded shadow-sm border border-indigo-100 text-center">
                    <div class="text-[8px] font-bold text-slate-400 uppercase">T·ªïng Tr·∫£ Tr∆∞·ªõc</div>
                    <div class="text-[13px] font-black text-teal-600">{formatCurrency(comboTotalPrepaid)}<small>ƒë</small></div>
                </div>
                <div class="bg-white p-2 rounded shadow-sm border border-indigo-100 text-center">
                    <div class="text-[8px] font-bold text-slate-400 uppercase">T·ªïng G√≥p/Th</div>
                    <div class="text-[13px] font-black text-indigo-600">{formatCurrency(comboTotalMonthly)}<small>ƒë</small></div>
                </div>
            </div>
        </div>
    </div>
    {/if}

</div>

<style>
    .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    /* [NEW] Th√™m animation cho History */
    .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .animate-slideIn { animation: slideInLeft 0.3s ease-out; }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
</style>
--- END FILE: ./src/components/InstallmentCalc.svelte ---

--- START FILE: ./src/components/Login.svelte ---
<script>
  // Version 7.4 - Fix Invalid ID Error (Sanitize Slash Character)
  import { db } from '../lib/firebase';
  import { collection, getDocs, query, where, writeBatch, doc, serverTimestamp } from 'firebase/firestore';
  import { setUser, DEFAULT_TEMPLATE } from '../lib/stores.js';
  import { safeString, getTodayStr } from '../lib/utils.js';
  
  let username = '';
  let password = '';
  let showPassword = false;
  let isSuperAdminLogin = false;
  let errorMsg = '';
  let isLoading = false;

  const tourKey = 'taskflow_v6_general_tour_seen';

  // --- H√ÄM T·∫†O D·ªÆ LI·ªÜU DEMO ---
  async function seedDemoData() {
      const demoStoreId = 'DEMO_1';
      const todayStr = getTodayStr();
      const dateObj = new Date();
      const monthStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
      const batch = writeBatch(db);

      console.log("‚è≥ ƒêang kh·ªüi t·∫°o d·ªØ li·ªáu Demo...");

      // 1. T·∫†O C√îNG VI·ªÜC M·∫™U (TASKS)
      // D√πng template chu·∫©n (gi·ªëng kho 908)
      const types = ['warehouse', 'cashier'];
      types.forEach(type => {
          (DEFAULT_TEMPLATE[type] || []).forEach(tpl => {
              // FIX L·ªñI: Chu·∫©n h√≥a ID k·ªπ c√†ng (B·ªè d·∫•u, b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát nh∆∞ /)
              const cleanTitle = tpl.title
                  .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // B·ªè d·∫•u ti·∫øng Vi·ªát
                  .replace(/[^a-zA-Z0-9]/g, "") // B·ªè h·∫øt k√Ω t·ª± l·∫° (/, -, d·∫•u c√°ch...)
                  .toLowerCase();

              const taskId = `${demoStoreId}_${todayStr}_${type}_${cleanTitle}`;
              const taskRef = doc(db, 'tasks', taskId);
              
              batch.set(taskRef, {
                  title: tpl.title,
                  timeSlot: tpl.time,
                  isImportant: tpl.isImportant || false,
                  type: type,
                  storeId: demoStoreId,
                  date: todayStr,
                  completed: false,
                  createdBy: 'System Demo',
                  timestamp: serverTimestamp()
              });
          });
      });

      // Th√™m v√†i vi·ªác B√†n Giao m·∫´u
      const handovers = [
          { t: "Giao ch√¨a kh√≥a t·ªß k√©t cho ca sau", time: "12:00" },
          { t: "L∆∞u √Ω: Kh√°ch VIP c·ªçc ƒë∆°n h√†ng #999", time: "14:30" }
      ];
      handovers.forEach((h, i) => {
          const hId = `${demoStoreId}_${todayStr}_handover_demo_${i}`;
          batch.set(doc(db, 'tasks', hId), {
              title: h.t,
              deadline: `${todayStr}T${h.time}`,
              type: 'handover',
              storeId: demoStoreId,
              date: todayStr,
              completed: false,
              createdBy: 'Qu·∫£n L√Ω Demo',
              timestamp: serverTimestamp()
          });
      });

      // 2. T·∫†O DANH S√ÅCH NH√ÇN VI√äN M·∫™U
      const demoStaff = [
          { id: 'demo_nv1', name: 'Nguy·ªÖn VƒÉn An', gender: 'Nam' },
          { id: 'demo_nv2', name: 'Tr·∫ßn Th·ªã B√≠ch', gender: 'N·ªØ' },
          { id: 'demo_nv3', name: 'L√™ Ho√†ng C∆∞·ªùng', gender: 'Nam' },
          { id: 'demo_nv4', name: 'Ph·∫°m Thu Dung', gender: 'N·ªØ' },
          { id: 'demo_nv5', name: 'V≈© Minh Em', gender: 'Nam' }
      ];
      batch.set(doc(db, 'settings', `staff_list_${demoStoreId}`), {
          staffList: demoStaff,
          updatedAt: serverTimestamp()
      });

      // 3. T·∫†O C·∫§U H√åNH CA & L·ªäCH L√ÄM VI·ªÜC TH√ÅNG N√ÄY
      // C·∫•u h√¨nh Matrix
      batch.set(doc(db, 'settings', `shift_matrix_${demoStoreId}`), {
          genderConfig: { kho: 'mixed', tn: 'mixed' },
          comboCols: ['123', '456', '23', '45', '2-5'],
          matrix: {}, 
          updatedAt: serverTimestamp()
      });

      // T·∫°o L·ªãch (Schedule) gi·∫£ l·∫≠p
      const daysInMonth = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0).getDate();
      const scheduleData = {};
      
      for (let d = 1; d <= daysInMonth; d++) {
          const dayData = demoStaff.map((s, idx) => {
              // Thu·∫≠t to√°n g√°n ca xoay v√≤ng ƒë∆°n gi·∫£n ƒë·ªÉ demo: 123 -> 456 -> OFF
              const pattern = (d + idx) % 3; 
              let shift = 'OFF', role = '';
              
              if (pattern === 0) { shift = '123'; role = (idx % 2 === 0) ? 'Kho' : 'Thu Ng√¢n'; }
              else if (pattern === 1) { shift = '456'; role = (idx % 2 !== 0) ? 'Kho' : 'Thu Ng√¢n'; }
              
              return {
                  staffId: s.id, name: s.name, gender: s.gender,
                  shift: shift, role: role,
                  originalShift: shift, originalRole: role
              };
          });
          scheduleData[d] = dayData;
      }

      // T√≠nh Stats gi·∫£
      const stats = demoStaff.map(s => ({
          id: s.id, name: s.name, gender: s.gender,
          totalHours: 150, gh: 5, tn: 10, kho: 10 
      }));

      batch.set(doc(db, 'stores', demoStoreId, 'schedules', monthStr), {
          data: scheduleData,
          stats: stats,
          config: { matrix: {}, approvedCombos: [] },
          updatedAt: serverTimestamp()
      });

      try {
          await batch.commit();
          console.log("‚úÖ ƒê√£ t·∫°o xong d·ªØ li·ªáu Demo!");
      } catch (e) {
          console.error("L·ªói t·∫°o Demo:", e);
          throw e; // N√©m l·ªói ra ƒë·ªÉ hi·ªÉn th·ªã alert b√™n d∆∞·ªõi
      }
  }

  async function handleLogin() {
    isLoading = true;
    errorMsg = 'ƒêang ki·ªÉm tra...';
    const cleanU = safeString(username).toLowerCase();
    const cleanP = safeString(password);

    // --- FIX: T√ÄI KHO·∫¢N SETUP QUY·ªÄN L·ª∞C TUY·ªÜT ƒê·ªêI ---
    if (cleanU === 'setup' && cleanP === 'Linh30!0') {
        setUser({ 
            username: 'setup', 
            name: 'System Setup', 
            role: 'super_admin', 
            storeIds: [], 
            storeId: '' 
        });
        return;
    }
    // ------------------------------------------------

    if (cleanU === 'demo' && cleanP === '123456') {
        try {
            // T·∫†O D·ªÆ LI·ªÜU TR∆Ø·ªöC KHI V√ÄO
            await seedDemoData();
            
            localStorage.removeItem(tourKey);
            setUser({ username: 'demo', name: 'Qu·∫£n L√Ω Demo', role: 'admin', storeIds: ['DEMO_1'], storeId: 'DEMO_1' });
            return;
        } catch(e) { 
            console.error(e);
            errorMsg = "L·ªói kh·ªüi t·∫°o Demo: " + e.message;
            isLoading = false;
            return;
        }
    }

    try {
      const q = query(collection(db, 'users'), where('username_idx', '==', cleanU));
      const snapshot = await getDocs(q);

      if (snapshot.empty) { 
          errorMsg = 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!';
          isLoading = false; 
          return;
      }

      let foundUser = null;
      snapshot.forEach(doc => {
        const data = doc.data();
        if (safeString(data.pass) === cleanP) {
            if (isSuperAdminLogin) {
                if (data.role === 'super_admin') foundUser = data;
            } else {
                const stores = data.storeIds || (data.storeId ? [data.storeId] : []);
                if (data.role !== 'super_admin' && stores.length > 0) {
                    foundUser = data; 
                    foundUser.storeIds = stores;
                }
            }
         }
      });

      if (foundUser) setUser(foundUser);
      else errorMsg = isSuperAdminLogin ? 'B·∫°n kh√¥ng c√≥ quy·ªÅn Super Admin!' : 'Sai m·∫≠t kh·∫©u!';
    } catch (err) { 
        errorMsg = err.message;
    } finally { 
        isLoading = false;
    }
  }
</script>

<div id="login-screen" class="screen">
  <div class="login-card">
    <div class="brand-logo"><span class="material-icons-round">rocket_launch</span></div>
    <h2 class="title">TaskFlow</h2>
    <p class="subtitle">ƒêƒÉng nh·∫≠p h·ªá th·ªëng</p>
    
    <form on:submit|preventDefault={handleLogin}>
      <div class="flex items-center justify-end mb-4 gap-2">
         <label for="sa-check" class="text-xs font-bold text-gray-500 cursor-pointer select-none">Qu·∫£n tr·ªã h·ªá th·ªëng</label>
         <input id="sa-check" type="checkbox" bind:checked={isSuperAdminLogin} class="w-4 h-4 accent-purple-600 cursor-pointer">
      </div>

      <div class="input-wrapper">
        <label for="username-field" class="sr-only">T√™n ƒëƒÉng nh·∫≠p</label>
        <span class="material-icons-round input-icon" aria-hidden="true">person</span>
        <input id="username-field" class="input-field" type="text" bind:value={username} placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
      </div>

      <div class="input-wrapper">
        <label for="password-field" class="sr-only">M·∫≠t kh·∫©u</label>
        <span class="material-icons-round input-icon" aria-hidden="true">lock</span>
        <input id="password-field" class="input-field" type={showPassword?'text':'password'} bind:value={password} placeholder="M·∫≠t kh·∫©u" required style="padding-right:40px!important">
        <button type="button" class="eye-icon" on:click={()=>showPassword=!showPassword} aria-label={showPassword ? "·∫®n m·∫≠t kh·∫©u" : "Hi·ªán m·∫≠t kh·∫©u"}>
            <span class="material-icons-round text-gray-400">{showPassword?'visibility':'visibility_off'}</span>
        </button>
      </div>
      
      <button type="submit" class="btn-grad" disabled={isLoading}>{isLoading?'...':(isSuperAdminLogin?'LOGIN ADMIN':'V√ÄO KHO')}</button>
      <p class="error-msg" role="alert">{errorMsg}</p>
      
      <div class="mt-4 space-y-2">
          <div class="text-xs text-gray-500">
              Qu√™n m·∫≠t kh·∫©u? Vui l√≤ng li√™n h·ªá <b class="text-purple-600">Qu·∫£n l√Ω kho</b> ƒë·ªÉ ƒë∆∞·ª£c c·∫•p l·∫°i.
          </div>
          
          <div class="text-xs text-gray-500">
              Li√™n h·ªá <b class="text-purple-600">3031</b> ƒë·ªÉ t·∫°o t√†i kho·∫£n ch√≠nh th·ª©c mi·ªÖn ph√≠
          </div>
      </div>
      
      <div class="mt-4 text-xs text-gray-400 pt-2 border-t border-dashed border-gray-200">
          ƒêƒÉng nh·∫≠p ƒë·ªÉ xem t√≠nh nƒÉng Demo : <b>demo</b>/<b>123456</b>
      </div>
    </form>
  </div>
</div>

<style>
  .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; }
  .login-card { background: #fff; width: 90%; max-width: 350px; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
  .brand-logo { width: 60px; height: 60px; margin: 0 auto 15px; background: #f3f0ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #764ba2; }
  .brand-logo span { font-size: 32px; }
  .title { margin: 0; color: #333; font-weight: 800; }
  .subtitle { margin: 5px 0 10px; color: #666; font-size: 0.9rem; }
  .input-wrapper { position: relative; margin-bottom: 15px; }
  .input-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 20px; pointer-events: none; z-index: 10; }
  .eye-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; display: flex; align-items: center; padding: 5px; z-index: 20; }
  .input-field { width: 100%; padding: 12px 12px 12px 45px !important; border: 2px solid #eee; border-radius: 10px; outline: none; background: #f9f9f9; box-sizing: border-box; font-size: 1rem; appearance: none; }
  .input-field:focus { border-color: #667eea; background: white; }
  .btn-grad { width: 100%; padding: 12px; border: none; border-radius: 10px; background: linear-gradient(to right, #667eea, #764ba2); color: white; font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 10px; }
  .btn-grad:disabled { opacity: 0.7; cursor: not-allowed; }
  .error-msg { color: #ff4757; margin-top: 10px; font-size: 0.9rem; font-weight: bold; min-height: 20px; }
  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
</style>
--- END FILE: ./src/components/Login.svelte ---

--- START FILE: ./src/components/NotificationDropdown.svelte ---
<script>
  // Version 2.0 - Click to Jump Support
  import { db } from '../lib/firebase';
  import { doc, updateDoc } from 'firebase/firestore';
  import { createEventDispatcher } from 'svelte';
  import { formatDateTime } from '../lib/utils';

  export let notifications = [];
  const dispatch = createEventDispatcher();

  async function handleClick(notif) {
      // 1. ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
      if (!notif.isRead) {
          try {
              await updateDoc(doc(db, 'notifications', notif.id), { isRead: true });
          } catch (e) { console.error(e); }
      }
      
      // 2. Ph√°t s·ª± ki·ªán nh·∫£y t·ªõi Task (n·∫øu c√≥ taskId)
      if (notif.taskId) {
          dispatch('jumpToTask', { 
              taskId: notif.taskId,
              tab: notif.targetTab || 'handover'
          });
      }
      
      dispatch('close');
  }
</script>

<div class="absolute right-0 top-12 w-80 bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden z-[100] animate-popIn origin-top-right">
    <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
        <h4 class="font-bold text-slate-700 text-sm">Th√¥ng b√°o</h4>
        {#if notifications.length > 0}
            <span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">
                {notifications.filter(n => !n.isRead).length} m·ªõi
            </span>
         {/if}
    </div>
    
    <div class="max-h-80 overflow-y-auto">
        {#each notifications as notif}
            <button class="w-full text-left p-3 border-b border-slate-50 hover:bg-indigo-50 transition-colors flex gap-3 relative {notif.isRead ? 'opacity-60' : 'bg-white'}" on:click={() => handleClick(notif)}>
                <div class="w-8 h-8 rounded-full bg-indigo-200 text-indigo-700 flex items-center justify-center font-bold text-xs shrink-0">
                     {notif.fromUser?.charAt(0).toUpperCase() || 'S'}
                </div>
                
                <div class="flex-1">
                    <p class="text-xs text-slate-800 leading-snug">
                         <span class="font-bold">{notif.fromUser}</span> 
                        {notif.content}
                    </p>
                    <span class="text-[10px] text-slate-400 mt-1 block">
                        {formatDateTime(notif.createdAt?.toDate())}
                    </span>
                </div>

                {#if !notif.isRead}
                    <div class="absolute right-2 top-1/2 -translate-y-1/2 w-2 h-2 bg-red-500 rounded-full"></div>
                {/if}
            </button>
        {/each}

        {#if notifications.length === 0}
            <div class="p-8 text-center text-slate-400 text-xs">
                <span class="material-icons-round text-3xl mb-2 opacity-30">notifications_off</span>
                <p>Ch∆∞a c√≥ th√¥ng b√°o n√†o</p>
            </div>
         {/if}
    </div>
</div>

<style>
    .animate-popIn { animation: popIn 0.2s ease-out; }
    @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>
--- END FILE: ./src/components/NotificationDropdown.svelte ---

--- START FILE: ./src/components/ShiftSchedule.svelte ---
<script>
  // Version 40.5 - Refactored (Phase 4.1: Extracted Excel Export) [Surgical Fix]
  import { onMount } from 'svelte';
  import { db } from '../lib/firebase';
  import { doc, onSnapshot, updateDoc, getDoc, setDoc } from 'firebase/firestore';
  import { currentUser } from '../lib/stores';
  import TourGuide from './TourGuide.svelte';
  import CumulativeHistoryModal from './CumulativeHistoryModal.svelte'; 
  
  // T√≠ch h·ª£p c√°c m·∫£nh gh√©p giao di·ªán
  import ScheduleControls from './ShiftScheduleParts/ScheduleControls.svelte';
  import ScheduleTable from './ShiftScheduleParts/ScheduleTable.svelte';
  import DayStatsModal from './ShiftScheduleParts/DayStatsModal.svelte';
  import EditShiftModal from './ShiftScheduleParts/EditShiftModal.svelte';
  import PersonalScheduleModal from './ShiftScheduleParts/PersonalScheduleModal.svelte';

  // [NEW] Import Service Xu·∫•t Excel
  import { exportScheduleToExcel } from '../utils/excelExport.js';

  export let activeTab;
  let scheduleData = null, loading = false, errorMsg = '';
  let viewMonth = new Date().getMonth() + 1;
  let viewYear = new Date().getFullYear();
  $: currentMonthStr = `${viewYear}-${String(viewMonth).padStart(2,'0')}`;
  
  let selectedStaff = null;
  let editingShift = null;
  let selectedDayStats = null;
  let showHistoryModal = false; 
  
  let showPastDays = false;
  let highlightedDay = null;
  let tempEditingShift = null;

  $: myStores = $currentUser?.storeIds || [];
  $: isAdmin = $currentUser?.role === 'admin' || $currentUser?.role === 'super_admin';
  let selectedViewStore = '';
  $: if (myStores.length > 0 && !selectedViewStore) { selectedViewStore = myStores[0]; }

  let unsubscribe = () => {};
  $: if (activeTab === 'schedule' && selectedViewStore && currentMonthStr) { loadSchedule(currentMonthStr, selectedViewStore); }

  function isPastDay(d) {
      const today = new Date();
      if (viewYear > today.getFullYear()) return false;
      if (viewYear < today.getFullYear()) return true;
      if (viewMonth > today.getMonth() + 1) return false;
      if (viewMonth < today.getMonth() + 1) return true;
      return Number(d) < today.getDate(); 
  }

  function handleDayHeaderClick(d) {
      if (highlightedDay === d) highlightedDay = null; 
      else highlightedDay = d;
      showDayStats(d);
  }

  async function loadSchedule(monthStr, storeId) {
      scheduleData = null; loading = true; errorMsg = '';
      if (unsubscribe) unsubscribe();
      try {
          const ref = doc(db, 'stores', storeId, 'schedules', monthStr);
          unsubscribe = onSnapshot(ref, (snap) => {
              loading = false;
              if(snap.exists()) { scheduleData = snap.data(); } 
              else { scheduleData = null; }
          });
      } catch (e) { loading = false; errorMsg = e.message; }
  }

  async function handleRestoreBackup() {
      if (!isAdmin) return;
      if (!confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n mu·ªën kh√¥i ph·ª•c l·∫°i phi√™n b·∫£n l·ªãch C≈® c·ªßa th√°ng ${viewMonth}/${viewYear}?\n\nD·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®!`)) return;
      loading = true;
      try {
          const backupRef = doc(db, 'stores', selectedViewStore, 'schedules', `${currentMonthStr}_backup`);
          const backupSnap = await getDoc(backupRef);
          if (!backupSnap.exists()) { alert("‚ùå Kh√¥ng t√¨m th·∫•y b·∫£n sao l∆∞u n√†o."); loading = false; return; }
          const mainRef = doc(db, 'stores', selectedViewStore, 'schedules', currentMonthStr);
          await setDoc(mainRef, backupSnap.data());
          alert("‚úÖ ƒê√£ kh√¥i ph·ª•c th√†nh c√¥ng!");
      } catch (e) { alert("L·ªói: " + e.message); } finally { loading = false; }
  }

  function getShiftColor(code) {
      if (code === 'OFF') return 'bg-red-600 text-white border-red-700 font-black tracking-wider text-[10px] shadow-sm';
      const map = { '123': 'bg-green-50 text-green-700 border-green-100', '456': 'bg-orange-50 text-orange-700 border-orange-100', '23': 'bg-cyan-50 text-cyan-700 border-cyan-100', '45': 'bg-blue-50 text-blue-700 border-blue-100', '2-5': 'bg-pink-50 text-pink-700 border-pink-100', '2345': 'bg-red-50 text-red-700 border-red-100' };
      return map[code] || 'bg-white text-gray-800 border-gray-200';
  }

  function getRoleBadge(role) {
      if (!role || role === 'TV') return null;
      if (role === 'GH' || role === 'Giao H√†ng') return { text: 'GH', class: 'bg-blue-600 text-white' };
      if (role === 'Thu Ng√¢n' || role === 'TN') return { text: 'TN', class: 'bg-purple-600 text-white' };
      if (role === 'Kho') return { text: 'K', class: 'bg-orange-500 text-white' };
      return { text: role.charAt(0), class: 'bg-gray-500 text-white' };
  }

  function getWeekday(day) { 
      const date = new Date(viewYear, viewMonth - 1, day);
      return ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][date.getDay()]; 
  }
  
  function viewPersonalSchedule(staffId, staffName) { 
      if(!scheduleData?.data) return;
      let days = []; 
      Object.keys(scheduleData.data).sort((a,b)=>Number(a)-Number(b)).forEach(d => { 
          const assign = scheduleData.data[d].find(x => x.staffId === staffId); 
          if(assign) days.push({ day: d, weekday: getWeekday(d), ...assign }); 
      });
      const firstDayDate = new Date(viewYear, viewMonth - 1, 1); 
      let startDayIdx = firstDayDate.getDay(); 
      if (startDayIdx === 0) startDayIdx = 6; else startDayIdx = startDayIdx - 1; 
      let blankCells = Array(startDayIdx).fill(null); 
      const stat = scheduleData.stats.find(s => s.id === staffId) || { totalHours:0, gh:0, tn:0, kho:0 }; 
      selectedStaff = { id: staffId, name: staffName, days, blankCells, stats: stat };
  }
  
  function openEditShift(day, staffId, assign) { 
      if (!isAdmin) return; 
      const staffInfo = scheduleData.stats.find(s => s.id === staffId);
      tempEditingShift = { 
          day, staffId, name: assign.name, shift: assign.shift, role: assign.role || 'TV', 
          isOFF: assign.shift === 'OFF', gender: staffInfo ? staffInfo.gender : 'N·ªØ', 
          originalRole: assign.originalRole !== undefined ? assign.originalRole : (assign.role || 'TV'), 
          originalShift: assign.originalShift !== undefined ? assign.originalShift : assign.shift 
      }; 
      editingShift = JSON.parse(JSON.stringify(tempEditingShift)); 
  }
  
  async function saveShiftChange() { 
      if (!editingShift || !scheduleData) return;
      if (editingShift.role === 'GH' && editingShift.gender !== 'Nam') { 
          if (!confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO: Nh√¢n vi√™n ${editingShift.name} l√† N·ªÆ.\nV·ªã tr√≠ Giao H√†ng th∆∞·ªùng y√™u c·∫ßu NAM.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën g√°n kh√¥ng?`)) return;
      } 
      const approvedCombos = scheduleData.config?.approvedCombos || []; 
      if (approvedCombos.length > 0 && !editingShift.isOFF) { 
          const dayKey = String(editingShift.day);
          const currentDayAssignments = scheduleData.data[dayKey]; 
          let targetRoleCode = 'TV'; 
          if (editingShift.role === 'GH') targetRoleCode = 'GH';
          else if (editingShift.role === 'Thu Ng√¢n') targetRoleCode = 'TN'; 
          else if (editingShift.role === 'Kho') targetRoleCode = 'Kho';
          
          const comboConfig = approvedCombos.find(c => { 
              let cRole = c.role || 'TV'; if (cRole === 'Thu Ng√¢n') cRole = 'TN'; 
              return c.code === editingShift.shift && cRole === targetRoleCode; 
          });
          const quota = comboConfig ? (parseInt(comboConfig.qty) || 0) : 0;
          const currentCount = currentDayAssignments.filter(a => { 
              if (a.staffId === editingShift.staffId) return false; 
              let r = a.role || 'TV'; if (r === 'Giao H√†ng') r = 'GH'; if (r === 'Thu Ng√¢n') r = 'TN'; if (r === 'Kho') r = 'Kho'; 
              return a.shift === editingShift.shift && r === targetRoleCode; 
          }).length;
          
          if (currentCount + 1 > quota) { 
              const msg = quota === 0 ? `‚õî C·∫¢NH B√ÅO: Combo [${editingShift.shift} - ${targetRoleCode}] KH√îNG C√ì trong b·∫£ng ƒë·ªãnh m·ª©c!\n(Quota = 0)\n\nB·∫°n c√≥ mu·ªën √©p bu·ªôc g√°n kh√¥ng?` : `‚ö†Ô∏è C·∫¢NH B√ÅO V∆Ø·ª¢T ƒê·ªäNH M·ª®C:\n\nCombo [${editingShift.shift} - ${targetRoleCode}] quy ƒë·ªãnh: ${quota}.\nHi·ªán t·∫°i: ${currentCount}.\nTh√™m m·ªõi th√†nh: ${currentCount + 1}.\n\nTi·∫øp t·ª•c?`;
              if (!confirm(msg)) return; 
          } 
      } 
      
      const dayKey = String(editingShift.day); const dayList = [...scheduleData.data[dayKey]];
      const idx = dayList.findIndex(x => x.staffId === editingShift.staffId); 
      if (idx !== -1) { 
          const oldRole = dayList[idx].role || 'TV';
          const newRole = editingShift.isOFF ? '' : (editingShift.role === 'TV' ? '' : editingShift.role);
          const updatedAssignment = { ...dayList[idx], shift: editingShift.isOFF ? 'OFF' : editingShift.shift, role: newRole }; 
          dayList[idx] = updatedAssignment;
          
          const newStats = [...scheduleData.stats]; 
          const statIdx = newStats.findIndex(s => s.id === editingShift.staffId);
          if (statIdx !== -1) { 
              const s = newStats[statIdx]; 
              let rOld = oldRole === 'Giao H√†ng' ? 'gh' : (oldRole === 'Thu Ng√¢n' ? 'tn' : (oldRole === 'Kho' ? 'kho' : ''));
              if(rOld) s[rOld] = Math.max(0, (s[rOld]||0) - 1); 
              let rNew = newRole === 'Giao H√†ng' ? 'gh' : (newRole === 'Thu Ng√¢n' ? 'tn' : (newRole === 'Kho' ? 'kho' : ''));
              if(rNew) s[rNew] = (s[rNew]||0) + 1; 
          } 
          try { 
              await updateDoc(doc(db, 'stores', selectedViewStore, 'schedules', currentMonthStr), { [`data.${dayKey}`]: dayList, stats: newStats });
              editingShift = null; 
          } catch (e) { alert("L·ªói: " + e.message); } 
      } 
  }
  
  function showDayStats(day) { 
      if (!scheduleData || !scheduleData.data[day]) return;
      const dayData = scheduleData.data[day];
      const roles = ['Kho', 'Thu Ng√¢n', 'GH', 'TV'];
      const matrix = { 'Kho': {}, 'Thu Ng√¢n': {}, 'GH': {}, 'TV': {} };
      const activeShifts = new Set();
      dayData.forEach(assign => { if (assign.shift !== 'OFF') activeShifts.add(assign.shift); }); 
      const cols = Array.from(activeShifts).sort();
      roles.forEach(r => { cols.forEach(c => matrix[r][c] = 0); matrix[r]['Total'] = 0; });
      dayData.forEach(assign => { 
          if (assign.shift === 'OFF') return; 
          let r = assign.role || 'TV'; 
          if (r === 'TN') r = 'Thu Ng√¢n'; 
          if (matrix[r]) { matrix[r][assign.shift] = (matrix[r][assign.shift] || 0) + 1; matrix[r]['Total']++; } 
      });
      const targetRoles = ['Kho', 'Thu Ng√¢n', 'GH'];
      const details = { 'Kho': {}, 'Thu Ng√¢n': {}, 'GH': {} };
      dayData.forEach(assign => {
          if (assign.shift === 'OFF') return;
          let r = assign.role || 'TV';
          if (r === 'TN') r = 'Thu Ng√¢n'; if (r === 'K') r = 'Kho'; if (r === 'Giao H√†ng') r = 'GH';
          if (targetRoles.includes(r)) {
               if (!details[r][assign.shift]) details[r][assign.shift] = [];
              details[r][assign.shift].push(assign.name);
          }
      });
      selectedDayStats = { day, weekday: getWeekday(day), cols, matrix, roles, details }; 
  }

  function getWeekendHardRoleCount(staffId) {
      if (!scheduleData || !scheduleData.data) return 0;
      let count = 0;
      const isHardRole = (r) => ['Kho', 'Thu Ng√¢n', 'Giao H√†ng', 'GH', 'TN', 'K'].includes(r);
      const isWeekend = (d) => { const date = new Date(viewYear, viewMonth - 1, d); const day = date.getDay(); return day === 0 || day === 6; };
      Object.keys(scheduleData.data).forEach(d => {
          if (isWeekend(d)) {
              const assign = scheduleData.data[d].find(a => a.staffId === staffId);
              if (assign && isHardRole(assign.role)) count++;
          }
      });
      return count;
  }

  // [SURGICAL] G·ªçi h√†m xu·∫•t Excel t·ª´ file util
  function handleExportExcel() {
      exportScheduleToExcel({
          scheduleData,
          viewMonth,
          viewYear,
          selectedViewStore,
          getWeekday,
          getWeekendHardRoleCount
      });
  }
  
  let showScheduleTour = false;
  const scheduleSteps = [ 
      { target: '.overflow-x-auto', title: '1. B·∫£ng L·ªãch T·ªïng', content: 'ƒê√¢y l√† to√†n b·ªô l·ªãch l√†m vi·ªác trong th√°ng.' }, 
      { target: '#store-view-selector', title: '2. Ch·ªçn Kho Xem', content: 'N·∫øu qu·∫£n l√Ω nhi·ªÅu kho, h√£y ch·ªçn kho t·∫°i ƒë√¢y ƒë·ªÉ xem l·ªãch t∆∞∆°ng ·ª©ng.' }, 
      { target: '#tour-staff-name', title: '3. Xem Chi Ti·∫øt C√° Nh√¢n', content: 'B·∫•m v√†o <b>T√™n Nh√¢n Vi√™n</b> ƒë·ªÉ m·ªü popup xem l·ªãch ri√™ng.' }, 
      { target: '#tour-total-col', title: '4. C·ªôt T·ªïng K·∫øt', content: 'K√©o v·ªÅ cu·ªëi b·∫£ng ƒë·ªÉ xem t·ªïng gi·ªù c√¥ng.', action: () => { const tableContainer = document.querySelector('.overflow-x-auto'); if(tableContainer) tableContainer.scrollLeft = tableContainer.scrollWidth; } } 
  ];
</script>

<ScheduleControls 
    {myStores} {scheduleData} {isAdmin}
    bind:selectedViewStore bind:viewMonth bind:viewYear bind:showPastDays
    on:openHistory={() => showHistoryModal = true}
    on:restoreBackup={handleRestoreBackup}
    on:exportExcel={handleExportExcel}
    on:startTour={() => showScheduleTour = true}
/>

{#if loading} 
    <div class="p-10 text-center text-gray-400 animate-pulse bg-white rounded-xl border border-dashed flex flex-col items-center">
        <span class="material-icons-round text-4xl animate-spin text-indigo-300">sync</span>
        <p class="mt-2 text-sm font-bold">ƒêang t·∫£i l·ªãch th√°ng {viewMonth}...</p>
    </div>
{:else if !scheduleData} 
    <div class="p-10 text-center text-gray-400 bg-white rounded-xl border border-dashed flex flex-col items-center">
        <span class="material-icons-round text-4xl text-gray-300">calendar_today</span>
        <p class="mt-2 text-sm">Ch∆∞a c√≥ l·ªãch l√†m vi·ªác th√°ng {viewMonth}/{viewYear}.</p>
        {#if isAdmin}<p class="text-xs text-indigo-500 mt-1">Vui l√≤ng v√†o m·ª•c "Qu·∫£n tr·ªã" ƒë·ªÉ t·∫°o.</p>{/if}
    </div>
{:else}
    <ScheduleTable 
        {scheduleData} {showPastDays} {highlightedDay} {isAdmin}
        {isPastDay} {getWeekday} {getRoleBadge} {getShiftColor} {getWeekendHardRoleCount}
        on:clickDayHeader={(e) => handleDayHeaderClick(e.detail)}
        on:clickStaff={(e) => viewPersonalSchedule(e.detail.id, e.detail.name)}
        on:clickCell={(e) => openEditShift(e.detail.day, e.detail.staffId, e.detail.assign)}
    />
{/if}

{#if showHistoryModal && scheduleData}
    <CumulativeHistoryModal storeId={selectedViewStore} currentMonth={viewMonth} currentYear={viewYear} currentStats={scheduleData.stats} on:close={() => showHistoryModal = false} />
{/if}

{#if selectedStaff}
    <PersonalScheduleModal {selectedStaff} {getRoleBadge} on:close={() => selectedStaff = null} />
{/if}

{#if editingShift}
    <EditShiftModal bind:editingShift {tempEditingShift} on:close={() => editingShift = null} on:save={saveShiftChange} />
{/if}

{#if selectedDayStats}
    <DayStatsModal {selectedDayStats} on:close={() => selectedDayStats = null} />
{/if}

{#if showScheduleTour}
    <TourGuide steps={scheduleSteps} on:complete={() => showScheduleTour = false} />
{/if}
--- END FILE: ./src/components/ShiftSchedule.svelte ---

--- START FILE: ./src/components/ShiftScheduleParts/DayStatsModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    const dispatch = createEventDispatcher();
    export let selectedDayStats;
</script>

<div class="fixed inset-0 z-[60] bg-slate-900/60 flex items-center justify-center p-4 backdrop-blur-sm" on:click={() => dispatch('close')}>
    <div class="bg-white w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]" on:click|stopPropagation>
        
        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center shrink-0">
            <h3 class="font-bold text-lg text-slate-800">Ng√†y {selectedDayStats.day} ({selectedDayStats.weekday})</h3>
             <button on:click={() => dispatch('close')} class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center"><span class="material-icons-round text-slate-500">close</span></button>
        </div>

        <div class="overflow-y-auto p-4 bg-white">
            <div class="mb-6 overflow-x-auto">
                 <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">T·ªïng quan s·ªë l∆∞·ª£ng</h4>
                <table class="w-full text-sm border-separate border-spacing-0 rounded-xl overflow-hidden border border-slate-200">
                    <thead class="bg-slate-50 text-slate-500">
                        <tr>
                            <th class="p-2 text-left font-bold border-b border-r border-slate-200 text-xs">B·ªô Ph·∫≠n</th>
                            {#each selectedDayStats.cols as col}<th class="p-2 text-center border-b border-slate-200 border-l border-white min-w-[40px] text-xs"><div class="font-black text-slate-700">{col}</div></th>{/each}
                            <th class="p-2 text-center font-bold bg-slate-100 border-b border-l border-slate-200 text-slate-700 text-xs">T·ªïng</th>
                        </tr>
                    </thead>
                    <tbody>
                        {#each selectedDayStats.roles as role}
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="p-2 font-bold border-r border-slate-100 text-xs {role==='GH'?'text-blue-600':(role==='Thu Ng√¢n'?'text-purple-600':(role==='Kho'?'text-orange-600':'text-gray-600'))}">{role}</td>
                                {#each selectedDayStats.cols as col}<td class="p-2 border-r border-slate-100 text-center font-mono text-xs {selectedDayStats.matrix[role][col]>0?'font-bold text-slate-800':'text-gray-300'}">{selectedDayStats.matrix[role][col] || '-'}</td>{/each}
                                <td class="p-2 text-center font-black text-slate-700 bg-slate-50 border-l border-slate-100 text-xs">{selectedDayStats.matrix[role]['Total']}</td>
                            </tr>
                        {/each}
                    </tbody>
                </table>
            </div>

            <h4 class="text-xs font-bold text-gray-400 uppercase mb-3 sticky top-0 bg-white py-2 z-10 border-b">Chi ti·∫øt nh√¢n s·ª±</h4>
            <div class="space-y-4">
                
                <div class="rounded-xl border border-orange-100 bg-orange-50/30 overflow-hidden">
                    <div class="bg-orange-100 px-3 py-2 flex items-center justify-between">
                        <span class="font-bold text-orange-700 text-sm flex items-center gap-2">
                            <span class="material-icons-round text-base">inventory_2</span> KHO
                        </span>
                        <span class="bg-white text-orange-600 text-[10px] font-bold px-2 py-0.5 rounded-full border border-orange-200">{selectedDayStats.matrix['Kho']['Total']} ng∆∞·ªùi</span>
                    </div>
                    <div class="p-3 grid gap-3">
                        {#each Object.keys(selectedDayStats.details['Kho']).sort() as shift}
                            <div class="flex items-start gap-2 text-sm border-b border-orange-100 last:border-0 pb-2 last:pb-0">
                                <div class="font-bold text-orange-600 bg-white border border-orange-200 px-2 py-1 rounded text-xs min-w-[40px] text-center shrink-0">{shift}</div>
                                <div class="flex flex-wrap gap-1.5 pt-0.5">
                                    {#each selectedDayStats.details['Kho'][shift] as name}
                                        <span class="text-slate-700 font-bold">{name}{#if name !== selectedDayStats.details['Kho'][shift][selectedDayStats.details['Kho'][shift].length - 1]}, {/if}</span>
                                    {/each}
                                </div>
                            </div>
                        {/each}
                        {#if Object.keys(selectedDayStats.details['Kho']).length === 0}
                            <span class="text-xs text-gray-400 italic">Kh√¥ng c√≥ nh√¢n s·ª±</span>
                        {/if}
                    </div>
                </div>

                <div class="rounded-xl border border-purple-100 bg-purple-50/30 overflow-hidden">
                    <div class="bg-purple-100 px-3 py-2 flex items-center justify-between">
                        <span class="font-bold text-purple-700 text-sm flex items-center gap-2">
                            <span class="material-icons-round text-base">point_of_sale</span> THU NG√ÇN
                        </span>
                         <span class="bg-white text-purple-600 text-[10px] font-bold px-2 py-0.5 rounded-full border border-purple-200">{selectedDayStats.matrix['Thu Ng√¢n']['Total']} ng∆∞·ªùi</span>
                    </div>
                    <div class="p-3 grid gap-3">
                        {#each Object.keys(selectedDayStats.details['Thu Ng√¢n']).sort() as shift}
                            <div class="flex items-start gap-2 text-sm border-b border-purple-100 last:border-0 pb-2 last:pb-0">
                                <div class="font-bold text-purple-600 bg-white border border-purple-200 px-2 py-1 rounded text-xs min-w-[40px] text-center shrink-0">{shift}</div>
                                <div class="flex flex-wrap gap-1.5 pt-0.5">
                                     {#each selectedDayStats.details['Thu Ng√¢n'][shift] as name}
                                        <span class="text-slate-700 font-bold">{name}{#if name !== selectedDayStats.details['Thu Ng√¢n'][shift][selectedDayStats.details['Thu Ng√¢n'][shift].length - 1]}, {/if}</span>
                                    {/each}
                                </div>
                            </div>
                        {/each}
                         {#if Object.keys(selectedDayStats.details['Thu Ng√¢n']).length === 0}
                            <span class="text-xs text-gray-400 italic">Kh√¥ng c√≥ nh√¢n s·ª±</span>
                        {/if}
                    </div>
                </div>

                <div class="rounded-xl border border-blue-100 bg-blue-50/30 overflow-hidden">
                    <div class="bg-blue-100 px-3 py-2 flex items-center justify-between">
                        <span class="font-bold text-blue-700 text-sm flex items-center gap-2">
                            <span class="material-icons-round text-base">local_shipping</span> GIAO H√ÄNG
                        </span>
                         <span class="bg-white text-blue-600 text-[10px] font-bold px-2 py-0.5 rounded-full border border-blue-200">{selectedDayStats.matrix['GH']['Total']} ng∆∞·ªùi</span>
                    </div>
                    <div class="p-3 grid gap-3">
                        {#each Object.keys(selectedDayStats.details['GH']).sort() as shift}
                            <div class="flex items-start gap-2 text-sm border-b border-blue-100 last:border-0 pb-2 last:pb-0">
                                <div class="font-bold text-blue-600 bg-white border border-blue-200 px-2 py-1 rounded text-xs min-w-[40px] text-center shrink-0">{shift}</div>
                                <div class="flex flex-wrap gap-1.5 pt-0.5">
                                    {#each selectedDayStats.details['GH'][shift] as name}
                                        <span class="text-slate-700 font-bold">{name}{#if name !== selectedDayStats.details['GH'][shift][selectedDayStats.details['GH'][shift].length - 1]}, {/if}</span>
                                    {/each}
                                </div>
                            </div>
                        {/each}
                         {#if Object.keys(selectedDayStats.details['GH']).length === 0}
                            <span class="text-xs text-gray-400 italic">Kh√¥ng c√≥ nh√¢n s·ª±</span>
                         {/if}
                    </div>
                </div>

            </div>
        </div>
         
    </div>
</div>
--- END FILE: ./src/components/ShiftScheduleParts/DayStatsModal.svelte ---

--- START FILE: ./src/components/ShiftScheduleParts/EditShiftModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    const dispatch = createEventDispatcher();
    
    export let editingShift;
    export let tempEditingShift;
    
    const QUICK_SHIFTS = ['OFF', '123', '456', '23', '45', '2345'];

    function resetEditShift() { 
        if (!editingShift) return; 
        editingShift.shift = editingShift.originalShift;
        editingShift.role = editingShift.originalRole; 
        editingShift.isOFF = editingShift.shift === 'OFF'; 
    }
</script>

<div class="fixed inset-0 z-[60] bg-slate-900/60 flex items-center justify-center p-4 backdrop-blur-sm" on:click={() => dispatch('close')}>
    <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl" on:click|stopPropagation>
        <div class="flex justify-between items-start mb-4">
            <div><h3 class="font-bold text-lg text-slate-800">S·ª≠a Ca: {editingShift.name}</h3><p class="text-xs text-gray-500">Ng√†y {editingShift.day} - Hi·ªán t·∫°i: <span class="font-bold">{tempEditingShift.shift}</span></p></div>
            {#if editingShift.shift !== editingShift.originalShift || editingShift.role !== editingShift.originalRole}
                <button class="text-xs text-red-600 hover:underline font-bold bg-red-50 px-2 py-1 rounded" on:click={resetEditShift}>Reset v·ªÅ g·ªëc</button>
            {/if}
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-2">Ch·ªçn Ca Nhanh</label>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    {#each QUICK_SHIFTS as s}
                        <button class="py-2 border rounded-lg font-bold text-xs transition-all shadow-sm {editingShift.isOFF && s==='OFF' ? 'bg-red-600 text-yellow-300 border-red-600 ring-2 ring-red-200' : (!editingShift.isOFF && editingShift.shift === s ? 'bg-indigo-600 text-white border-indigo-600 ring-2 ring-indigo-200' : 'bg-white hover:bg-gray-50 text-gray-600 border-gray-200')}" on:click={() => { if(s === 'OFF') { editingShift.isOFF = true; editingShift.shift = 'OFF'; } else { editingShift.isOFF = false; editingShift.shift = s; } }}>{s}</button>
                    {/each}
                </div>
                 <label class="block text-xs font-bold text-gray-500 mb-1 mt-3">Ca T√πy Ch·ªânh</label>
                <input type="text" value={editingShift.isOFF ? 'OFF' : editingShift.shift} on:input={(e) => { if(!editingShift.isOFF) editingShift.shift = e.target.value; }} disabled={editingShift.isOFF} class="w-full p-2.5 border rounded-lg text-center font-bold text-sm transition-colors {editingShift.isOFF ? 'bg-red-600 text-yellow-300 border-red-600 cursor-not-allowed opacity-100' : 'bg-white text-slate-800 border-gray-300 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200'}" placeholder="Nh·∫≠p m√£ ca (vd: 12-56)">
            </div>
            {#if !editingShift.isOFF}
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 animate-fadeIn">
                    <label class="block text-xs font-bold text-gray-500 mb-2">Vai Tr√≤ M·ªõi</label>
                    <div class="grid grid-cols-2 gap-2">
                        {#each ['TV', 'Thu Ng√¢n', 'Kho', 'GH'] as r}
                            <label class="flex items-center gap-2 cursor-pointer bg-white p-2 rounded border border-gray-200 hover:border-indigo-300 transition-colors">
                                <input type="radio" bind:group={editingShift.role} value={r} class="accent-indigo-600 w-4 h-4">
                                <span class="text-xs font-bold {r==='GH'?'text-blue-600':(r==='Thu Ng√¢n'?'text-purple-600':(r==='Kho'?'text-orange-600':'text-gray-600'))}">{r}</span>
                            </label>
                        {/each}
                    </div>
                </div>
             {/if}
        </div>
        <div class="flex gap-3 mt-6">
            <button class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold text-sm hover:bg-slate-200 transition-colors" on:click={() => dispatch('close')}>H·ªßy B·ªè</button>
            <button class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold text-sm shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:-translate-y-0.5 transition-all" on:click={() => dispatch('save')}>L∆∞u Thay ƒê·ªïi</button>
        </div>
    </div>
</div>
--- END FILE: ./src/components/ShiftScheduleParts/EditShiftModal.svelte ---

--- START FILE: ./src/components/ShiftScheduleParts/PersonalScheduleModal.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    const dispatch = createEventDispatcher();
    
    export let selectedStaff;
    export let getRoleBadge; // H√†m l·∫•y nh√£n ch·ª©c v·ª• truy·ªÅn t·ª´ cha xu·ªëng
</script>

<div class="fixed inset-0 z-[60] bg-slate-900/60 flex items-center justify-center p-4 backdrop-blur-sm" on:click={() => dispatch('close')}>
    <div class="bg-white w-full max-w-sm rounded-xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]" on:click|stopPropagation>
        <div class="p-4 bg-indigo-500 text-white shrink-0">
            <h3 class="font-bold text-lg">{selectedStaff.name}</h3>
            <div class="flex justify-between mt-2 text-xs font-bold bg-indigo-600/50 p-2 rounded">
               <span>{Math.round(selectedStaff.stats.totalHours) || 0} Gi·ªù</span>
                <span class="text-blue-100">GH: {selectedStaff.stats.gh || 0}</span>
                <span class="text-purple-100">TN: {selectedStaff.stats.tn || 0}</span>
                <span class="text-orange-100">K: {selectedStaff.stats.kho || 0}</span>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-3 bg-slate-100">
            <div class="grid grid-cols-7 gap-1 mb-1 text-center text-[10px] font-bold text-gray-400 uppercase">
                {#each ['T2','T3','T4','T5','T6','T7','CN'] as day}<div>{day}</div>{/each}
            </div>
            <div class="grid grid-cols-7 gap-1">
                {#each selectedStaff.blankCells as _}<div class="bg-transparent"></div>{/each}
                {#each selectedStaff.days as d}
                    <div class="bg-white rounded border shadow-sm p-1 flex flex-col items-center justify-center aspect-square {d.shift==='OFF'?'opacity-60 bg-slate-100':''}">
                        <div class="text-[10px] text-gray-400 font-bold mb-1">{d.day}</div>
                        <div class="font-black text-slate-800 text-xs {d.shift==='OFF'?'text-slate-400':''}">{d.shift}</div>
                        {#if d.shift !== 'OFF'}
                            {@const badge = getRoleBadge(d.role)}
                            {#if badge}<span class="text-[9px] font-bold px-1 rounded mt-0.5 leading-tight {badge.class}">{badge.text}</span>{/if}
                        {/if}
                    </div>
                {/each}
            </div>
        </div>
        <div class="p-3 border-t bg-white text-center"><button class="w-full py-2 bg-gray-100 rounded text-gray-600 font-bold text-sm" on:click={() => dispatch('close')}>ƒê√≥ng</button></div>
    </div>
</div>
--- END FILE: ./src/components/ShiftScheduleParts/PersonalScheduleModal.svelte ---

--- START FILE: ./src/components/ShiftScheduleParts/ScheduleControls.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    const dispatch = createEventDispatcher();

    // Nh·∫≠n d·ªØ li·ªáu t·ª´ component cha truy·ªÅn xu·ªëng
    export let myStores = [];
    export let scheduleData = null;
    export let isAdmin = false;

    // C√°c bi·∫øn d√πng bind: (c√≥ th·ªÉ thay ƒë·ªïi gi√° tr·ªã v√† b√°o ng∆∞·ª£c l·∫°i cho cha)
    export let selectedViewStore = '';
    export let viewMonth;
    export let viewYear;
    export let showPastDays;

    function prevMonth() {
        if (viewMonth === 1) { viewMonth = 12; viewYear--; } 
        else { viewMonth--; }
    }

    function nextMonth() {
        if (viewMonth === 12) { viewMonth = 1; viewYear++; } 
        else { viewMonth++; }
    }
</script>

<div class="flex items-center justify-between mb-3 px-1">
    <div class="flex items-center gap-2">
        {#if myStores.length > 1}
            <div id="store-view-selector" class="relative">
                <select bind:value={selectedViewStore} class="pl-3 pr-8 py-1.5 bg-white border border-gray-200 text-indigo-700 font-bold rounded-lg text-sm outline-none appearance-none cursor-pointer shadow-sm hover:border-indigo-300 transition-colors">
                    {#each myStores as s}<option value={s}>{s}</option>{/each}
                </select>
                <span class="material-icons-round absolute right-2 top-1/2 -translate-y-1/2 text-indigo-400 text-sm pointer-events-none">expand_more</span>
            </div>
        {:else}
            <span class="font-bold text-gray-500 text-sm bg-gray-100 px-2 py-1 rounded">Kho {selectedViewStore}</span>
        {/if}

        <div class="flex items-center gap-2 bg-white p-1 rounded-lg border shadow-sm">
            <button class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded" on:click={prevMonth}>
                <span class="material-icons-round text-gray-500">chevron_left</span>
            </button>
            <span class="font-bold text-indigo-700 px-2 min-w-[90px] text-center text-sm">T{viewMonth}/{viewYear}</span>
            <button class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded" on:click={nextMonth}>
                <span class="material-icons-round text-gray-500">chevron_right</span>
            </button>
        </div>
    </div>
    
    {#if scheduleData}
        <div class="flex gap-2">
            <button class="flex items-center gap-1 bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg font-bold text-xs shadow hover:bg-slate-200 transition-all border border-slate-200" on:click={() => showPastDays = !showPastDays} title="·∫®n/Hi·ªán c√°c ng√†y tr∆∞·ªõc h√¥m nay">
                <span class="material-icons-round text-sm">{showPastDays ? 'visibility_off' : 'visibility'}</span>
                <span class="hidden sm:inline">{showPastDays ? '·∫®n ng√†y c≈©' : 'Hi·ªán ng√†y c≈©'}</span>
            </button>
            
            <button class="flex items-center gap-2 bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-lg font-bold text-xs shadow hover:bg-indigo-100 transition-all border border-indigo-100" on:click={() => dispatch('openHistory')} title="Xem l·ªãch s·ª≠ gi·ªù c√¥ng c√°c th√°ng tr∆∞·ªõc">
                <span class="material-icons-round text-sm">history</span> L≈©y K·∫ø
            </button>
            
            {#if isAdmin}
                 <button class="flex items-center gap-2 bg-slate-200 text-slate-700 px-3 py-1.5 rounded-lg font-bold text-xs shadow hover:bg-slate-300 transition-all" on:click={() => dispatch('restoreBackup')} title="Ho√†n t√°c v·ªÅ phi√™n b·∫£n tr∆∞·ªõc khi √°p d·ª•ng">
                    <span class="material-icons-round text-sm">history</span> Kh√¥i Ph·ª•c
                </button>
            {/if}
            
            <button class="flex items-center gap-2 bg-green-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow hover:bg-green-700 transition-all" on:click={() => dispatch('exportExcel')}>
                <span class="material-icons-round text-sm">download</span> Xu·∫•t Excel
            </button>
            
            <button class="flex items-center justify-center bg-purple-500 text-white w-8 h-8 rounded-lg shadow hover:bg-purple-600 transition-all" on:click={() => dispatch('startTour')} title="H∆∞·ªõng d·∫´n xem l·ªãch">
                <span class="material-icons-round text-lg">help_outline</span>
            </button>
        </div>
    {/if}
</div>
--- END FILE: ./src/components/ShiftScheduleParts/ScheduleControls.svelte ---

--- START FILE: ./src/components/ShiftScheduleParts/ScheduleTable.svelte ---
<script>
    import { createEventDispatcher } from 'svelte';
    const dispatch = createEventDispatcher();

    // D·ªØ li·ªáu t·ª´ cha truy·ªÅn xu·ªëng
    export let scheduleData;
    export let showPastDays;
    export let highlightedDay;
    export let isAdmin;

    // C√°c h√†m t√≠nh to√°n t·ª´ cha truy·ªÅn xu·ªëng ƒë·ªÉ d√πng chung, kh√¥ng code l·∫∑p l·∫°i
    export let isPastDay;
    export let getWeekday;
    export let getShiftColor;
    export let getRoleBadge;
    export let getWeekendHardRoleCount;
</script>

<div class="overflow-x-auto border rounded-xl bg-white shadow-sm max-h-[75vh] relative scroll-smooth">
    <table class="w-full text-sm text-center border-collapse min-w-[1500px]">
        <thead class="bg-amber-400 text-slate-900 sticky top-0 z-30 shadow-md">
            <tr>
                <th rowspan="2" class="p-2 sticky left-0 bg-white border-r border-amber-200 z-40 min-w-[140px] text-left pl-3 shadow">NH√ÇN S·ª∞</th>
                {#each Object.keys(scheduleData.data).sort((a,b)=>Number(a)-Number(b)) as d}
                    {#if showPastDays || !isPastDay(d)}
                        <th class="p-1 border-l border-amber-500/30 min-w-[40px] text-xs font-black cursor-pointer hover:bg-amber-500 transition-colors select-none {['T7','CN'].includes(getWeekday(d)) ? 'bg-amber-300' : ''} {highlightedDay === d ? '!bg-indigo-300 !text-indigo-900 ring-2 ring-indigo-500 z-50 relative' : ''}" on:click={() => dispatch('clickDayHeader', d)}>{d}</th>
                    {/if}
                {/each}
                <th rowspan="2" class="p-2 w-12 bg-amber-100 text-[10px] border-l border-amber-300 font-bold">Gi·ªù</th>
                <th rowspan="2" class="p-2 w-10 bg-blue-100 text-[10px] border-l border-amber-300 font-bold text-blue-800">GH</th>
                <th rowspan="2" class="p-2 w-10 bg-purple-100 text-[10px] border-l border-amber-300 font-bold text-purple-800">TN</th>
                <th rowspan="2" class="p-2 w-10 bg-orange-100 text-[10px] border-l border-amber-300 font-bold text-orange-800">K</th>
                <th rowspan="2" class="p-2 w-14 bg-indigo-100 text-[10px] border-l border-amber-300 font-bold text-indigo-800" title="S·ªë ca nghi·ªáp v·ª• T7/CN">Ca<br>cu·ªëi tu·∫ßn</th>
            </tr>
            <tr>
                {#each Object.keys(scheduleData.data).sort((a,b)=>Number(a)-Number(b)) as d}
                    {#if showPastDays || !isPastDay(d)}
                        <th class="p-0.5 border-l border-amber-500/30 text-[9px] {['T7','CN'].includes(getWeekday(d))?'bg-amber-300/80 text-amber-900':'bg-amber-200/50 text-slate-700'} {highlightedDay === d ? '!bg-indigo-200 !text-indigo-900 border-x-2 border-indigo-400 relative z-40' : ''}">{getWeekday(d)}</th>
                    {/if}
                {/each}
            </tr>
        </thead>
        <tbody class="divide-y text-xs">
            {#each scheduleData.stats as staff, i}
                {@const weCount = getWeekendHardRoleCount(staff.id)}
                <tr class="hover:bg-blue-50 transition-colors">
                    <td id={i===0 ? 'tour-staff-name' : ''} class="p-2 font-bold text-left sticky left-0 bg-white border-r z-20 cursor-pointer hover:text-indigo-600 shadow pl-3 truncate max-w-[140px] {staff.gender==='Nam'?'text-blue-700':'text-pink-600'}" on:click={() => dispatch('clickStaff', { id: staff.id, name: staff.name })}>{staff.name}</td>
                    {#each Object.keys(scheduleData.data).sort((a,b)=>Number(a)-Number(b)) as d}
                        {#if showPastDays || !isPastDay(d)}
                            {@const assign = (scheduleData.data[d]||[]).find(x => x.staffId === staff.id)}
                            <td class="p-0.5 border-l border-gray-100 h-10 align-middle {isAdmin ? 'cursor-pointer hover:bg-gray-100' : ''} {['T7','CN'].includes(getWeekday(d)) ? 'bg-amber-50/50' : ''} {highlightedDay === d ? '!bg-indigo-50 border-x-2 border-indigo-300 relative z-10' : ''}" on:click={() => dispatch('clickCell', { day: d, staffId: staff.id, assign })}>
                                {#if assign}
                                    {@const badge = getRoleBadge(assign.role)}
                                    <div class="w-full h-full rounded py-1 font-bold text-[10px] flex flex-col items-center justify-center shadow-sm {getShiftColor(assign.shift)}">
                                        <span>{assign.shift}</span>
                                        {#if badge}<span class="text-[8px] leading-none px-1 py-0.5 rounded mt-0.5 {badge.class}">{badge.text}</span>{/if}
                                    </div>
                                {:else}<div class="text-gray-200">.</div>{/if}
                            </td>
                        {/if}
                    {/each}
                    <td class="p-2 font-bold text-center bg-amber-50 text-gray-700 border-l">{Math.round(staff.totalHours) || 0}</td>
                    <td class="p-2 font-bold text-center bg-blue-50 text-blue-600 border-l">{staff.gh || '-'}</td>
                    <td class="p-2 font-bold text-center bg-purple-50 text-purple-600 border-l">{staff.tn || 0}</td>
                    <td id={i===0 ? 'tour-total-col' : ''} class="p-2 font-bold text-center bg-orange-50 text-orange-600 border-l">{staff.kho || 0}</td>
                    <td class="p-2 font-bold text-center bg-indigo-50 text-indigo-700 border-l">{weCount}</td>
                </tr>
            {/each}
        </tbody>
    </table>
</div>
--- END FILE: ./src/components/ShiftScheduleParts/ScheduleTable.svelte ---

--- START FILE: ./src/components/StoreConfig.svelte ---
<script>
  // Version 25.1 - Instant Calculation Fix
  import { createEventDispatcher, onMount } from 'svelte';
  import { db } from '../lib/firebase';
  import { doc, getDoc, setDoc } from 'firebase/firestore';
  import { storeList, currentUser } from '../lib/stores';

  export let storeId;
  const dispatch = createEventDispatcher();
  
  let loading = false;
  let currentStoreId = storeId;
  let timeConfig = {};

  // DANH S√ÅCH CA C∆† B·∫¢N
  const BASE_SHIFTS = [
      { code: 'c1', label: 'Ca 1 (S√°ng s·ªõm)' },
      { code: 'c2', label: 'Ca 2 (S√°ng)' },
      { code: 'c3', label: 'Ca 3 (Tr∆∞a)' },
      { code: 'c4', label: 'Ca 4 (Chi·ªÅu)' },
      { code: 'c5', label: 'Ca 5 (T·ªëi)' },
      { code: 'c6', label: 'Ca 6 (ƒê√™m)' }
  ];

  // M·∫∑c ƒë·ªãnh
  const DEFAULT_TIMES = {
      'c1': { start: '08:00', end: '09:00' },
      'c2': { start: '09:00', end: '12:00' },
      'c3': { start: '12:00', end: '15:00' },
      'c4': { start: '15:00', end: '18:00' },
      'c5': { start: '18:00', end: '21:00' },
      'c6': { start: '21:00', end: '22:00' }
  };

  $: myStores = $storeList.filter(s => 
      $currentUser.role === 'super_admin' || 
      ($currentUser.storeIds && $currentUser.storeIds.includes(s.id))
  );

  async function loadStoreConfig(sid) {
      if (!sid) return;
      loading = true;
      timeConfig = JSON.parse(JSON.stringify(DEFAULT_TIMES));
      
      try {
          const docSnap = await getDoc(doc(db, 'stores', sid, 'settings', 'timeConfig'));
          if (docSnap.exists()) {
              timeConfig = { ...timeConfig, ...docSnap.data() };
          }
      } catch (e) { console.error(e); }
      finally { loading = false; }
  }

  $: if (currentStoreId) loadStoreConfig(currentStoreId);

  // H√ÄM T√çNH TO√ÅN (ƒê∆∞·ª£c g·ªçi ngay khi nh·∫≠p li·ªáu)
  function getDuration(cCode) {
      const sVal = timeConfig[cCode]?.start;
      const eVal = timeConfig[cCode]?.end;
      if (!sVal || !eVal) return 0;

      const d1 = new Date(`2000-01-01T${sVal}`);
      const d2 = new Date(`2000-01-01T${eVal}`);
      let diff = (d2 - d1) / 1000 / 60 / 60; // Gi·ªù
      if (diff < 0) diff += 24; // Qua ƒë√™m
      
      return parseFloat(diff.toFixed(1));
  }

  // Force Update UI khi nh·∫≠p li·ªáu
  function handleTimeChange() {
      timeConfig = { ...timeConfig }; // Trigger reactivity
  }

  async function saveConfig() {
      loading = true;
      try {
          const dataToSave = {};
          BASE_SHIFTS.forEach(s => {
              dataToSave[s.code] = {
                  start: timeConfig[s.code].start,
                  end: timeConfig[s.code].end
              };
          });

          await setDoc(doc(db, 'stores', currentStoreId, 'settings', 'timeConfig'), dataToSave);
          alert(`‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh gi·ªù cho Kho ${currentStoreId}!`);
          dispatch('close');
      } catch (e) { alert(e.message); }
      finally { loading = false; }
  }
</script>

<div class="fixed inset-0 z-[100] bg-slate-900/50 flex items-center justify-center p-4 backdrop-blur-sm" on:click={() => dispatch('close')}>
    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]" on:click|stopPropagation>
        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                <span class="material-icons-round text-indigo-500">access_time_filled</span> C·∫•u H√¨nh Gi·ªù G·ªëc
            </h3>
            <button on:click={() => dispatch('close')} class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center text-slate-500">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        
        <div class="px-4 pt-4 pb-2 bg-white">
            <label class="block text-xs font-bold text-slate-400 mb-1 uppercase">ƒêang √°p d·ª•ng cho kho</label>
            <div class="relative">
                <select bind:value={currentStoreId} class="w-full p-3 bg-indigo-50 border border-indigo-100 rounded-xl font-bold text-indigo-700 outline-none appearance-none cursor-pointer hover:bg-indigo-100 transition-colors">
                    {#each myStores as s}
                        <option value={s.id}>{s.id} - {s.name || 'Kho'}</option>
                    {/each}
                    {#if myStores.length === 0}
                         <option value={currentStoreId}>{currentStoreId}</option>
                    {/if}
                </select>
                <span class="material-icons-round absolute right-3 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none">expand_more</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-2">
            {#if loading}
                <div class="text-center py-4 text-slate-400 text-xs">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            {:else}
                {#each BASE_SHIFTS as shift}
                    <div class="flex items-center gap-3 p-3 border border-slate-100 rounded-xl hover:border-indigo-200 transition-colors group">
                        <div class="w-14">
                            <div class="font-black text-slate-700 text-lg leading-none uppercase">{shift.code}</div>
                            <div class="text-[9px] font-bold text-slate-400 mt-1 truncate">{shift.label}</div>
                        </div>

                        <div class="flex-1 flex items-center gap-2 bg-slate-50 p-1.5 rounded-lg border border-slate-200 group-hover:bg-white group-hover:shadow-sm transition-all">
                            <input type="time" bind:value={timeConfig[shift.code].start} on:input={handleTimeChange} class="w-full bg-transparent text-center font-bold text-slate-700 outline-none text-sm cursor-pointer">
                            <span class="text-slate-300 font-bold">-</span>
                            <input type="time" bind:value={timeConfig[shift.code].end} on:input={handleTimeChange} class="w-full bg-transparent text-center font-bold text-slate-700 outline-none text-sm cursor-pointer">
                        </div>

                        <div class="w-12 text-right">
                            <div class="text-sm font-black text-indigo-600">{getDuration(shift.code)}h</div>
                        </div>
                    </div>
                {/each}
            {/if}
        </div>

        <div class="p-4 border-t border-slate-100 bg-white flex gap-2">
            <div class="text-[10px] text-slate-400 flex-1 pr-2">
                *H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông c·ªông gi·ªù c·ªßa C1-C6 ƒë·ªÉ t√≠nh c√¥ng cho c√°c Combo (123, 456...)
            </div>
            <button class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 text-sm whitespace-nowrap" on:click={saveConfig} disabled={loading}>
                {loading ? 'ƒêang l∆∞u...' : 'L∆∞u Thay ƒê·ªïi'}
            </button>
        </div>
    </div>
</div>
--- END FILE: ./src/components/StoreConfig.svelte ---

--- START FILE: ./src/components/TaskList.svelte ---
<script>
  // Version 40.0 - Fix Display Tag Layout & Sorting
  import { createEventDispatcher } from 'svelte';
  import { currentTasks, currentUser } from '../lib/stores';
  import { formatDateTime } from '../lib/utils';
  
  export let activeTab = 'warehouse';
  const dispatch = createEventDispatcher();

  $: myStores = $currentUser?.storeIds || [];
  $: showStoreBadge = myStores.length > 1;
  
  let expandedHistoryTaskId = null;

  // 1. L·ªçc theo Tab
  $: filteredTasks = $currentTasks.filter(t => t.type === activeTab);

  // 2. GOM NH√ìM & S·∫ÆP X·∫æP
  $: groupedTasks = (() => {
      const groups = {};
      
      filteredTasks.forEach(task => {
          const timeKey = task.timeSlot || "Kh√°c";
          if (!groups[timeKey]) {
              groups[timeKey] = { timeSlot: timeKey, tasks: [], allDone: true };
          }
          groups[timeKey].tasks.push(task);
          if (!task.completed) groups[timeKey].allDone = false;
      });

      const groupArray = Object.values(groups);

      // Sort Group: Xong h·∫øt xu·ªëng ƒë√°y
      groupArray.sort((a, b) => {
          if (a.allDone !== b.allDone) return a.allDone - b.allDone;
          return a.timeSlot.localeCompare(b.timeSlot);
      });

      // Sort Task trong Group: Ch∆∞a xong l√™n ƒë·∫ßu -> Quan tr·ªçng -> Store
      groupArray.forEach(group => {
          group.tasks.sort((a, b) => {
             if (a.completed !== b.completed) return a.completed - b.completed; // 0 (False) l√™n tr∆∞·ªõc
             
             const impA = a.isImportant ? 1 : 0;
             const impB = b.isImportant ? 1 : 0;
             if (impA !== impB) return impB - impA;
             
             return (a.storeId||"").localeCompare(b.storeId||"");
          });
      });

      return groupArray;
  })();

  function toggleHistory(e, taskId) {
      e.stopPropagation(); 
      if (expandedHistoryTaskId === taskId) expandedHistoryTaskId = null;
      else expandedHistoryTaskId = taskId;
  }

  function handleTaskClick(task) { dispatch('taskClick', task); }

  function handleKeydown(e, task) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleTaskClick(task); }
  }

  // FIX: Logic t√°ch t√™n s·∫°ch s·∫Ω h∆°n
  function formatTaskTitle(title) {
      const regex = /@([^\s]+)/g; 
      const matches = title.match(regex) || [];
      // X√≥a tag v√† x√≥a kho·∫£ng tr·∫Øng th·ª´a (VD: "Vi·ªác A  " -> "Vi·ªác A")
      const mainText = title.replace(regex, '').replace(/\s+/g, ' ').trim();
      return { mainText, tags: matches };
  }
</script>

<div class="flex-1 overflow-y-auto pb-20 w-full px-1 scroll-smooth" id="task-list-container">
  {#each groupedTasks as group (group.timeSlot)}
    <div class="flex items-center gap-2 px-4 py-2 rounded-lg mt-4 mb-2 font-bold text-sm shadow-sm border sticky top-0 z-10 backdrop-blur-sm transition-all duration-500
        {group.allDone ? 'bg-gray-100 text-gray-500 border-gray-200' : 'bg-cyan-50 text-cyan-800 border-cyan-100 bg-cyan-50/90'}">
        <span class="material-icons-round text-base">schedule</span> 
        {group.timeSlot}
        {#if group.allDone}
            <span class="ml-auto text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Ho√†n t·∫•t</span>
        {/if}
    </div>

    <div class="flex flex-col gap-2">
        {#each group.tasks as task (task.id)}
            {@const titleData = formatTaskTitle(task.title || "")}
            
            <div class="relative group-task"> 
                <div 
                  role="button"
                  tabindex="0"
                  id={"task-" + task.id}
                  class="w-full p-4 rounded-xl flex items-start gap-3 shadow-sm border-l-4 transition-all active:scale-[0.99] duration-300 relative overflow-hidden cursor-pointer select-none
                  {task.completed ? 'bg-gray-50 opacity-60 border-l-gray-400' : (task.isImportant ? 'bg-red-50 border-l-red-500' : 'bg-white')}
                  {!task.completed && !task.isImportant && activeTab==='warehouse' ? 'border-l-orange-500' : ''}
                  {!task.completed && !task.isImportant && activeTab==='cashier' ? 'border-l-green-500' : ''}
                  {!task.completed && !task.isImportant && activeTab==='handover' ? 'border-l-purple-500' : ''}"
                  on:click={() => handleTaskClick(task)}
                  on:keydown={(e) => handleKeydown(e, task)}
                >
                  <div class="w-6 h-6 rounded-full border-2 flex-shrink-0 mt-0.5 flex items-center justify-center transition-colors
                    {task.completed ? 'bg-gray-400 border-gray-400' : (task.isImportant ? 'border-red-400 bg-red-100' : 'border-gray-300')}">
                      {#if task.completed}<span class="text-white text-sm font-bold">‚úì</span>{/if}
                      {#if !task.completed && task.isImportant}<span class="text-red-500 text-[10px]">‚òÖ</span>{/if}
                  </div>

                  <div class="flex-1 text-left pr-8"> 
                    <div class="text-sm leading-snug">
                         {#if showStoreBadge && task.storeId}
                            <span class="inline-block bg-indigo-100 text-indigo-700 text-[10px] px-1.5 py-0.5 rounded mr-1 font-bold tracking-wider align-middle border border-indigo-200 font-mono">[{task.storeId}]</span>
                        {/if}
                  
                        {#if task.isImportant}
                             <span class="material-icons-round text-sm text-red-500 align-middle mr-1">star</span>
                        {/if}
                        
                        <span class="{task.isImportant ? 'font-bold text-red-800' : 'font-bold text-gray-800'} {task.completed ? 'line-through text-gray-500' : ''}">
                            {titleData.mainText || task.title}
                        </span>

                        {#if titleData.tags.length > 0}
                             <span class="inline-flex gap-1 ml-1">
                                {#each titleData.tags as tag}
                                    <span class="text-xs font-normal {task.completed ? 'text-gray-300' : 'text-gray-400'}">
                                        ‚Äî {tag.replace('@', '')}
                                    </span>
                                {/each}
                             </span>
                        {/if}
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mt-2 items-center">
                        {#if activeTab === 'handover' && task.deadline}
                              <span class="bg-red-50 text-red-600 text-xs px-2 py-0.5 rounded flex items-center gap-1 border border-red-100">
                                <span class="material-icons-round text-[10px]">alarm</span> {formatDateTime(task.deadline)}
                            </span>
                        {/if}
                        {#if task.createdBy && task.createdBy !== 'System'}
                              <span class="bg-blue-50 text-blue-600 text-xs px-2 py-0.5 rounded border border-blue-100">{task.createdBy}</span>
                        {/if}
                        {#if task.completed}
                            <span class="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded flex items-center gap-1 border border-gray-200">
                                <span class="material-icons-round text-[10px]">check_circle</span> {task.completedBy} ‚Ä¢ {task.time}
                             </span>
                        {/if}
                    </div>
                    
                    {#if task.note}
                        <div class="mt-2 bg-yellow-50 text-yellow-800 text-xs p-2 rounded border border-yellow-100 italic flex gap-1">
                            <span class="material-icons-round text-[10px] mt-0.5">sticky_note_2</span>{task.note}
                        </div>
                    {/if}
                  </div>
                </div>

                <button class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-indigo-500 transition-colors z-20" on:click={(e) => toggleHistory(e, task.id)} title="L·ªãch s·ª≠"><span class="material-icons-round text-base">history</span></button>

                {#if expandedHistoryTaskId === task.id}
                    <div class="bg-gray-50 border-x border-b border-gray-200 rounded-b-xl mx-2 p-3 text-xs text-gray-600 animate-fadeIn shadow-inner mb-2 -mt-2 relative z-30">
                        <div class="font-bold mb-2 text-gray-400 uppercase text-[10px]">Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</div>
                        {#if task.history && task.history.length > 0}
                            <div class="space-y-2">
                                {#each task.history.slice().reverse() as log}
                                    <div class="flex justify-between items-center border-b border-gray-200 pb-1 last:border-0">
                                        <div class="flex items-center gap-2">
                                            <span class="material-icons-round text-[14px] {log.action==='done'?'text-green-600':'text-orange-500'}">{log.action==='done'?'check_circle':'undo'}</span>
                                            <span class="font-bold {log.action==='done'?'text-green-700':'text-orange-700'}">{log.action==='done'?'Ho√†n th√†nh':'Ho√†n t√°c'}</span>
                                            <span>b·ªüi <b>{log.user}</b></span>
                                        </div>
                                        <span class="font-mono text-[10px] text-gray-400">{log.time}</span>
                                    </div>
                                {/each}
                            </div>
                        {:else}
                            <div class="text-center italic text-gray-400">Ch∆∞a c√≥ l·ªãch s·ª≠ ghi l·∫°i.</div>
                        {/if}
                    </div>
                {/if}
            </div>
        {/each}
    </div>
  {/each}
  
  {#if groupedTasks.length === 0}
    <div class="text-center py-10 text-gray-400 flex flex-col items-center"><span class="material-icons-round text-4xl mb-2 opacity-30">assignment_turned_in</span><p class="text-sm">Ch∆∞a c√≥ c√¥ng vi·ªác n√†o</p></div>
  {/if}
</div>

<style>.animate-fadeIn { animation: fadeIn 0.2s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }</style>
--- END FILE: ./src/components/TaskList.svelte ---

--- START FILE: ./src/components/TaskModal.svelte ---
<script>
  // Version 41.0 - Optimized Task Modal (Use Cache)
  import { createEventDispatcher, onMount } from 'svelte';
  import { db } from '../lib/firebase';
  import { collection, addDoc, serverTimestamp, query, where, getDocs } from 'firebase/firestore';
  import { currentUser, storeUsersCache } from '../lib/stores'; // Import Cache
  export let taskTitle = '';
  export let note = ''; 

  const dispatch = createEventDispatcher();
  let storeUsers = [];
  let showSuggestions = false;
  let suggestionList = [];
  let cursorPosition = 0;

  // Logic t·∫£i user th√¥ng minh (gi·ªëng b√™n Handover)
  onMount(async () => {
      const currentStoreId = $currentUser.storeIds?.[0] || '';
      if (currentStoreId) {
          if ($storeUsersCache[currentStoreId]) {
              storeUsers = $storeUsersCache[currentStoreId];
              return;
          }
          try {
              const q = query(collection(db, 'users'), where('storeIds', 'array-contains', currentStoreId));
              const snap = await getDocs(q);
              const users = snap.docs.map(d => ({ username: d.data().username, name: d.data().name }));
              storeUsers = users;
              storeUsersCache.update(c => ({ ...c, [currentStoreId]: users }));
          } catch (e) { console.error(e); }
      }
  });

  function handleInput(e) {
      const val = e.target.value;
      cursorPosition = e.target.selectionStart;
      const textBeforeCursor = val.slice(0, cursorPosition);
      const lastWord = textBeforeCursor.split(/\s+/).pop();

      if (lastWord.startsWith('@')) {
          const queryText = lastWord.slice(1).toLowerCase();
          suggestionList = storeUsers.filter(u => u.name.toLowerCase().includes(queryText) || u.username.toLowerCase().includes(queryText));
          showSuggestions = true;
      } else { showSuggestions = false; }
  }

  function selectUser(user) {
      const textBeforeCursor = note.slice(0, cursorPosition);
      const textAfterCursor = note.slice(cursorPosition);
      const lastAtIndex = textBeforeCursor.lastIndexOf('@');
      note = textBeforeCursor.slice(0, lastAtIndex) + `@${user.username} ` + textAfterCursor;
      showSuggestions = false;
      document.getElementById('note-input').focus();
  }

  async function detectAndNotify(content) {
      if (!content) return;
      const regex = /@([\w.-]+)/g;
      const matches = content.match(regex);
      
      if (matches) {
          const rawTags = matches.map(m => m.substring(1));
          const realTargets = [];
          rawTags.forEach(tag => {
              const foundUser = storeUsers.find(u => u.username.toLowerCase() === tag.toLowerCase());
              if (foundUser) realTargets.push(foundUser.username);
              else realTargets.push(tag);
           });
          const uniqueUsers = [...new Set(realTargets)];
          const batchPromises = uniqueUsers.map(targetUser => {
              return addDoc(collection(db, 'notifications'), {
                  toUser: targetUser, 
                  fromUser: $currentUser.name || $currentUser.username,
                  content: `ƒë√£ nh·∫Øc ƒë·∫øn b·∫°n trong ghi ch√∫: "${taskTitle}"`,
                  isRead: false, type: 'mention', createdAt: serverTimestamp()
              });
          });
          await Promise.all(batchPromises);
      }
  }

  async function handleConfirm() {
      await detectAndNotify(note);
      dispatch('confirm');
  }
</script>

<div class="modal-overlay" role="dialog" aria-modal="true">
  <div class="modal-box text-center">
    <div class="modal-icon mb-2">
      <span class="material-icons-round text-4xl text-green-500">check_circle</span>
    </div>
    <h3 class="text-lg font-bold mb-1">X√°c nh·∫≠n ho√†n th√†nh</h3>
    <p class="text-gray-500 mb-4 text-sm">{taskTitle}</p>
    
    <div class="note-area mb-4 relative">
      <label for="note-input" class="sr-only">Ghi ch√∫ c√¥ng vi·ªác</label>
      <textarea 
        id="note-input"
        bind:value={note} 
        on:input={handleInput}
        rows="3" 
        placeholder="Ghi ch√∫... (G√µ @ ƒë·ªÉ ch·ªçn ng∆∞·ªùi)"
        class="w-full p-2 border rounded-lg resize-none text-sm focus:border-indigo-500 outline-none"
      ></textarea>
      
      {#if showSuggestions && suggestionList.length > 0}
        <div class="absolute bottom-full left-0 w-full mb-1 bg-white border border-gray-200 rounded-lg shadow-xl z-50 max-h-32 overflow-y-auto text-left">
            {#each suggestionList as user}
                <button class="w-full text-left p-2 hover:bg-indigo-50 flex items-center gap-2 border-b border-gray-50 last:border-0" on:click={() => selectUser(user)}>
                    <div class="w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-[9px] font-bold shrink-0">{user.name.charAt(0)}</div>
                    <div class="truncate">
                         <span class="text-xs font-bold text-gray-800">{user.name}</span>
                        <span class="text-[9px] text-gray-400 ml-1">@{user.username}</span>
                    </div>
                </button>
            {/each}
        </div>
      {/if}

      <p class="text-[10px] text-left text-gray-400 mt-1 pl-1">M·∫πo: Tag t√™n qu·∫£n l√Ω ƒë·ªÉ h·ªç nh·∫≠n th√¥ng b√°o ngay.</p>
    </div>
    
    <div class="flex gap-2">
      <button class="flex-1 py-2 rounded-lg bg-gray-100 font-bold text-gray-600" on:click={() => dispatch('cancel')}>H·ªßy</button>
      <button class="flex-1 py-2 rounded-lg bg-purple-600 text-white font-bold shadow-md" on:click={handleConfirm}>Ho√†n T·∫•t</button>
    </div>
  </div>
</div>

<style>
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
  .modal-box { background: white; width: 85%; max-width: 350px; padding: 20px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popIn 0.2s ease; }
  @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
</style>
--- END FILE: ./src/components/TaskModal.svelte ---

--- START FILE: ./src/components/TourGuide.svelte ---
<script>
  import { onMount, createEventDispatcher, onDestroy, tick } from 'svelte';
  export let steps = []; 
  
  const dispatch = createEventDispatcher();
  let currentStepIndex = 0;
  let styleString = 'opacity: 0;';
  let tooltipStyle = 'opacity: 0;'; 
  let arrowClass = '';
  let isMobile = false;
  let retryCount = 0;
  const MAX_RETRIES = 10; 

  async function runStepAction() {
      const step = steps[currentStepIndex];
      if (step && typeof step.action === 'function') {
          await step.action();
          await tick();
          await new Promise(r => setTimeout(r, 300));
      }
      calculatePosition();
  }

  async function calculatePosition() {
    if (!steps || steps.length === 0) return;
    if (currentStepIndex >= steps.length) {
        completeTour(); return;
    }

    const step = steps[currentStepIndex];
    const el = document.querySelector(step.target);
    if (!el) {
        if (retryCount < MAX_RETRIES) {
            retryCount++;
            setTimeout(calculatePosition, 200); 
            return;
        } else {
            console.warn('TourGuide: Target not found:', step.target);
            // Fallback an to√†n: Hi·ªán gi·ªØa m√†n h√¨nh n·∫øu kh√¥ng t√¨m th·∫•y ƒë√≠ch (tr√°nh ƒë∆°)
            styleString = 'display: none;';
            tooltipStyle = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; z-index: 100000;`;
            return;
        }
    }
    
    retryCount = 0;
    const rect = el.getBoundingClientRect();
    isMobile = window.innerWidth < 640;

    styleString = `
        position: fixed;
        top: ${rect.top}px;
        left: ${rect.left}px;
        width: ${rect.width}px;
        height: ${rect.height}px;
        transition: all 0.3s ease-out;
        opacity: 1;
        z-index: 99999; /* ƒê·∫£m b·∫£o khung s√°ng n·∫±m tr√™n c√πng */
    `;
    if (isMobile) {
        const isTargetInBottomHalf = rect.top > (window.innerHeight / 2);
        tooltipStyle = `
            position: fixed;
            ${isTargetInBottomHalf ? 'top: 20px;' : 'bottom: 20px;'}
            left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 350px;
            opacity: 1;
            z-index: 100000;
        `;
        arrowClass = 'hidden';
    } else {
        const isBottom = rect.bottom + 250 < window.innerHeight;
        let topPos = isBottom ? (rect.bottom + 15) : (rect.top - 15);
        let transformY = isBottom ? '' : 'translateY(-100%)';
        let leftPos = rect.left + (rect.width / 2) - 150;
        
        if (leftPos < 10) leftPos = 10;
        if (leftPos + 300 > window.innerWidth) leftPos = window.innerWidth - 310;
        tooltipStyle = `
            position: fixed;
            top: ${topPos}px;
            left: ${leftPos}px;
            transform: ${transformY};
            width: 300px;
            opacity: 1;
            z-index: 100000; /* Tooltip n·∫±m tr√™n c·∫£ khung s√°ng */
        `;
        
        arrowClass = isBottom 
            ? 'top-[-6px] left-1/2 -translate-x-1/2 border-t border-l' 
            : 'bottom-[-6px] left-1/2 -translate-x-1/2 border-b border-r';
    }
        
    el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
}

  function nextStep() { currentStepIndex++; retryCount=0; runStepAction(); }
  function prevStep() { if (currentStepIndex > 0) { currentStepIndex--; retryCount=0; runStepAction(); } }
  function completeTour() { dispatch('complete'); }
  function skipTour() { dispatch('complete'); }

  onMount(() => {
    runStepAction(); 
    window.addEventListener('resize', calculatePosition);
    window.addEventListener('scroll', calculatePosition, { capture: true });
  });
  onDestroy(() => {
    window.removeEventListener('resize', calculatePosition);
    window.removeEventListener('scroll', calculatePosition, { capture: true });
  });
</script>

<div class="fixed inset-0 z-[99998] overflow-hidden pointer-events-none">
    <div class="box-content rounded-lg border-2 border-yellow-400 shadow-[0_0_0_9999px_rgba(0,0,0,0.75)] pointer-events-none" style={styleString}></div>

    <div class="bg-white p-5 rounded-xl shadow-2xl border border-gray-100 pointer-events-auto flex flex-col" style={tooltipStyle}>
        <div class="flex justify-between items-start mb-3">
            <h4 class="font-bold text-gray-800 text-lg">{steps[currentStepIndex]?.title}</h4>
            <button class="text-gray-400 hover:text-gray-600 p-1" on:click={skipTour} aria-label="ƒê√≥ng">
                <span class="material-icons-round text-sm">close</span>
            </button>
        </div>
        
        <p class="text-sm text-gray-600 mb-5 leading-relaxed">
            {@html steps[currentStepIndex]?.content} 
        </p>

        <div class="flex justify-between items-center pt-3 border-t border-gray-100 mt-auto">
            <span class="text-xs font-bold text-indigo-400 bg-indigo-50 px-2 py-1 rounded">
                {currentStepIndex + 1} / {steps.length}
            </span>
            <div class="flex gap-2">
                {#if currentStepIndex > 0}
                    <button class="px-3 py-2 rounded-lg bg-gray-100 text-gray-600 text-xs font-bold hover:bg-gray-200 transition-colors" on:click={prevStep}>
                        L√πi l·∫°i
                    </button>
                {/if}
                <button class="px-5 py-2 rounded-lg bg-indigo-600 text-white text-xs font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-colors" on:click={nextStep}>
                    {currentStepIndex === steps.length - 1 ? 'Ho√†n t·∫•t' : 'Ti·∫øp theo'}
                </button>
            </div>
        </div>
        
        {#if !isMobile && arrowClass}
            <div class={`absolute w-3 h-3 bg-white transform rotate-45 border-gray-100 ${arrowClass}`}></div>
        {/if}
    </div>
</div>
--- END FILE: ./src/components/TourGuide.svelte ---

--- START FILE: ./src/components/admin/AdminAccounts.svelte ---
<script>
  // Version 5.0 - Allow Create New Store via Add User
  import { db } from '../../lib/firebase';
  import { doc, deleteDoc, updateDoc, setDoc, writeBatch, query, collection, where, getDocs, serverTimestamp } from 'firebase/firestore';
  import { read, utils, writeFile } from 'xlsx';
  import { safeString } from '../../lib/utils';
  import { onMount } from 'svelte';
  import TourGuide from '../TourGuide.svelte'; 
  
  export let targetStore = ''; 
  export let isSuperAdmin = false;
  
  let storeList = []; 
  let selectedStoreId = '';
  let accountList = [];
  let isLoading = false;
  
  // Form State
  let newAdminUser = ''; let newAdminPass = ''; 
  let singleUsername = ''; let singlePass = '123456'; let singleRole = 'admin'; // M·∫∑c ƒë·ªãnh l√† admin cho kho m·ªõi
  let targetStoreInput = ''; // Bi·∫øn m·ªõi: ƒê·ªÉ nh·∫≠p m√£ kho t√πy √Ω
  let showAddUserModal = false;
  
  // --- TOUR GUIDE CONFIG ---
  let showTour = false;
  const tourSteps = [
      { target: '#btn-add-user', title: '1. T·∫°o Admin Kho M·ªõi', content: 'B·∫•m v√†o ƒë√¢y. N·∫øu l√† t√†i kho·∫£n Setup, b·∫°n c√≥ th·ªÉ nh·∫≠p M√£ Kho M·ªõi ƒë·ªÉ t·∫°o kho.' },
      { target: '#btn-upload-acc', title: '2. Upload Nhanh', content: 'T·∫£i danh s√°ch Excel ƒë·ªÉ t·∫°o h√†ng lo·∫°t t√†i kho·∫£n c√πng l√∫c.' },
      { target: '#accounts-table', title: '3. Ph√¢n Quy·ªÅn', content: 'Danh s√°ch t√†i kho·∫£n hi·ªán c√≥. B·∫°n c√≥ th·ªÉ x√≥a ho·∫∑c ƒë·ªïi m·∫≠t kh·∫©u t·∫°i ƒë√¢y.' }
  ];
  // -------------------------

  $: isDemoMode = (selectedStoreId || targetStore)?.includes('DEMO');

  onMount(async () => {
      if (isSuperAdmin) {
          await fetchAllStores();
      } else {
          selectedStoreId = targetStore;
          loadAccountList(targetStore);
      }
  });

  $: if (targetStore && targetStore !== selectedStoreId) {
      selectedStoreId = targetStore;
      loadAccountList(targetStore);
  }

  function checkDemoAndBlock(e) {
      if (isDemoMode) {
          e && e.preventDefault();
          e && e.stopPropagation();
          alert("T√†i kho·∫£n demo kh√¥ng c√≥ t√≠nh nƒÉng n√†y!");
          return true;
      }
      return false;
  }

  function openAddUserModal() {
      // Khi m·ªü modal, n·∫øu l√† Super Admin th√¨ cho ph√©p s·ª≠a m√£ kho, m·∫∑c ƒë·ªãnh l·∫•y kho ƒëang ch·ªçn
      targetStoreInput = selectedStoreId || '';
      showAddUserModal = true;
  }

  async function fetchAllStores() {
      try {
          const q = query(collection(db, 'stores'));
          const snap = await getDocs(q);
          storeList = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.id.localeCompare(b.id));
          
          // N·∫øu ch∆∞a ch·ªçn kho n√†o, ch·ªçn c√°i ƒë·∫ßu ti√™n
          if (storeList.length > 0 && !selectedStoreId) {
              selectedStoreId = storeList[0].id;
              loadAccountList(selectedStoreId);
          }
      } catch (e) { console.error("L·ªói t·∫£i danh s√°ch kho:", e); }
  }

  function selectStore(sid) {
      selectedStoreId = sid;
      loadAccountList(sid);
  }

  async function loadAccountList(sid) {
      if (!sid) return;
      isLoading = true;
      accountList = [];
      try {
          const q = query(collection(db, 'users'), where('storeIds', 'array-contains', sid));
          const snap = await getDocs(q);
          const list = [];
          snap.forEach(d => list.push({ id: d.id, ...d.data() }));
          const roleOrder = { 'super_admin': 0, 'admin': 1, 'staff': 2 };
          list.sort((a, b) => {
              const rA = roleOrder[a.role] ?? 99;
              const rB = roleOrder[b.role] ?? 99;
              if (rA !== rB) return rA - rB;
              return a.username.localeCompare(b.username);
          });
          accountList = list;
      } catch (e) { console.error("Load accounts failed:", e); } 
      finally { isLoading = false; }
  }

  async function handleCreateSingleUser() {
      if (checkDemoAndBlock()) return;
      if (!singleUsername || !singlePass) return alert("Thi·∫øu th√¥ng tin!");
      
      // N·∫øu l√† Super Admin th√¨ l·∫•y t·ª´ √¥ nh·∫≠p li·ªáu, n·∫øu kh√¥ng th√¨ l·∫•y kho ƒëang ch·ªçn
      const storeToAssign = isSuperAdmin ? safeString(targetStoreInput) : selectedStoreId;
      
      if (!storeToAssign) return alert("Ch∆∞a nh·∫≠p M√£ Kho!");

      const uid = safeString(singleUsername).toLowerCase();
      isLoading = true;
      const batch = writeBatch(db);
      try {
          // 1. T·∫°o User
          batch.set(doc(db, 'users', uid), {
              username: uid, username_idx: uid,
              pass: singlePass,
              name: uid,
              role: singleRole,
              storeId: storeToAssign,
              storeIds: [storeToAssign],
              createdAt: serverTimestamp()
          });

          // 2. T·ª± ƒë·ªông t·∫°o Kho m·ªõi v√†o danh s√°ch 'stores' n·∫øu ch∆∞a c√≥ (Ch·ªâ d√†nh cho Super Admin)
          if (isSuperAdmin) {
              const storeRef = doc(db, 'stores', storeToAssign);
              // D√πng set v·ªõi merge: true ƒë·ªÉ kh√¥ng ghi ƒë√® n·∫øu kho ƒë√£ t·ªìn t·∫°i
              batch.set(storeRef, { 
                  id: storeToAssign,
                  name: `Kho ${storeToAssign}`,
                  createdAt: serverTimestamp() 
              }, { merge: true });
          }

          await batch.commit();
          
          alert(`‚úÖ ƒê√£ th√™m ${uid} v√†o kho ${storeToAssign}!`);
          showAddUserModal = false;
          
          // Reset v√† Reload
          singleUsername = '';
          if (isSuperAdmin) {
              await fetchAllStores(); // Load l·∫°i danh s√°ch kho ƒë·ªÉ th·∫•y kho m·ªõi
              selectStore(storeToAssign); // Chuy·ªÉn ngay sang kho m·ªõi
          } else {
              await loadAccountList(selectedStoreId);
          }

      } catch (e) { alert(e.message); }
      finally { isLoading = false; }
  }

  async function deleteAccount(uid) {
      if (checkDemoAndBlock()) return;
      if (!confirm(`X√≥a t√†i kho·∫£n ${uid}?`)) return;
      try {
          await deleteDoc(doc(db, 'users', uid));
          await loadAccountList(selectedStoreId);
      } catch (e) { alert("L·ªói x√≥a: " + e.message); }
  }

  async function changeRole(uid, newRole) {
      if (checkDemoAndBlock()) return;
      if (!confirm(`ƒê·ªïi quy·ªÅn t√†i kho·∫£n ${uid} th√†nh ${newRole}?`)) return;
      try {
          await updateDoc(doc(db, 'users', uid), { role: newRole });
          await loadAccountList(selectedStoreId);
      } catch (e) { alert("L·ªói ƒë·ªïi quy·ªÅn: " + e.message); }
  }

  async function resetPassword(uid) {
      if (checkDemoAndBlock()) return;
      if (!confirm(`Reset m·∫≠t kh·∫©u cho ${uid} v·ªÅ 123456?`)) return;
      try {
          await updateDoc(doc(db, 'users', uid), { pass: '123456' });
          alert("OK");
      } catch (e) { alert("L·ªói: " + e.message); }
  }

  function downloadAccountSample() {
      const wb = utils.book_new();
      const wsData = [
          ["username", "pass", "ma_kho", "role"],
          [`nv1_${selectedStoreId||'kho'}`, "123456", selectedStoreId||'kho', "staff"],
          [`quanly_${selectedStoreId||'kho'}`, "123456", selectedStoreId||'kho', "admin"]
      ];
      const ws = utils.aoa_to_sheet(wsData);
      utils.book_append_sheet(wb, ws, "DS_Cap_Quyen");
      writeFile(wb, `Mau_Tai_Khoan_${selectedStoreId}.xlsx`);
  }

  async function handleAccountUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      isLoading = true;
      setTimeout(async () => {
          try {
              const data = await file.arrayBuffer();
              const wb = read(data);
              const json = utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
              const batch = writeBatch(db);
              let c = 0;
              json.forEach(row => {
                  const u = row['username']; const p = row['pass']; const s = row['ma_kho']; const r = row['role'];
                  if (u && p && s && r) {
                      const uid = safeString(u).toLowerCase();
                      batch.set(doc(db, 'users', uid), {
                          username: uid, username_idx: uid,
                          pass: String(p), name: uid,
                          role: safeString(r).toLowerCase(),
                          storeId: String(s), storeIds: [String(s)],
                          createdAt: serverTimestamp()
                      });
                      
                      // N·∫øu upload file c√≥ m√£ kho m·ªõi, c≈©ng t·ª± t·∫°o kho lu√¥n
                      if (isSuperAdmin) {
                          const sId = String(s);
                          batch.set(doc(db, 'stores', sId), { id: sId, name: `Kho ${sId}` }, { merge: true });
                      }
                      c++;
                  }
              });
              if (c > 0) {
                  await batch.commit();
                  alert(`ƒê√£ import ${c} t√†i kho·∫£n.`);
                  if(isSuperAdmin) await fetchAllStores();
                  await loadAccountList(selectedStoreId);
              }
          } catch (e) { alert(e.message); }
          finally { isLoading = false; e.target.value = null; }
      }, 100);
  }
</script>

<div class="h-full flex flex-col md:flex-row gap-4 animate-fadeIn overflow-hidden" style="height: calc(100vh - 140px);">
  
  {#if isSuperAdmin}
      <div class="w-full md:w-64 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col shrink-0">
          <div class="p-3 border-b border-slate-100 bg-slate-50">
              <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                  <span class="material-icons-round text-indigo-500 text-base">store</span> 
                  Danh S√°ch Kho ({storeList.length})
              </h3>
          </div>
          <div class="flex-1 overflow-y-auto p-2 space-y-1">
              {#each storeList as store}
                  <button 
                      class="w-full text-left px-3 py-2 rounded-lg text-sm font-bold transition-all flex justify-between items-center
                      {selectedStoreId === store.id 
                          ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' 
                          : 'text-slate-600 hover:bg-slate-100 hover:text-indigo-600'}"
                      on:click={() => selectStore(store.id)}
                  >
                      <span>{store.id}</span>
                      {#if selectedStoreId === store.id}
                          <span class="material-icons-round text-xs">chevron_right</span>
                      {/if}
                  </button>
              {/each}
              {#if storeList.length === 0}
                  <div class="text-center p-4 text-xs text-gray-400">ƒêang t·∫£i ho·∫∑c ch∆∞a c√≥ kho n√†o.</div>
              {/if}
          </div>
      </div>
  {/if}

  <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
      <div class="p-4 border-b border-slate-100 flex flex-wrap justify-between items-center gap-3 shrink-0 bg-white z-10">
          <div class="flex items-center gap-2">
              <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold">
                  {selectedStoreId ? selectedStoreId.substring(0,2).toUpperCase() : '?'}
              </div>
              <div>
                  <h3 class="font-bold text-slate-800">Nh√¢n s·ª± Kho {selectedStoreId || '...'}</h3>
                  <p class="text-xs text-gray-500">T·ªïng: {accountList.length} t√†i kho·∫£n</p>
              </div>
          </div>

          <div class="flex gap-2 items-center">
              <button 
                  id="btn-add-user"
                  class="text-xs font-bold text-green-600 bg-green-50 px-3 py-2.5 rounded-lg hover:bg-green-100 flex items-center gap-1 transition-colors border border-green-100 mr-2" 
                  on:click={(e) => checkDemoAndBlock(e) || openAddUserModal()}
              >
                  <span class="material-icons-round text-sm">person_add</span> Th√™m M·ªõi
              </button>
              
              <button class="bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-2 px-3 rounded-lg text-xs transition-colors border border-blue-100" on:click={(e) => checkDemoAndBlock(e) || downloadAccountSample()}>
                  T·∫£i M·∫´u
              </button>
              
              <label id="btn-upload-acc" class="bg-blue-600 text-white hover:bg-blue-700 font-bold py-2 px-3 rounded-lg text-xs cursor-pointer flex items-center gap-1 transition-colors shadow-sm">
                  <span class="material-icons-round text-sm">upload</span> Upload
                  <input type="file" hidden accept=".xlsx" disabled={isDemoMode} on:change={handleAccountUpload}>
              </label>

              <button id="btn-help-accounts" class="text-gray-400 hover:text-indigo-600 ml-2" on:click={() => showTour = true}><span class="material-icons-round">help_outline</span></button>
          </div>
      </div>
      
      <div id="accounts-table" class="flex-1 overflow-auto relative">
          <table class="w-full text-sm text-left border-collapse">
              <thead class="bg-slate-50 text-slate-500 font-bold sticky top-0 z-10 shadow-sm">
                  <tr>
                      <th class="p-3 border-b border-slate-200">T√™n ƒêƒÉng Nh·∫≠p</th>
                      <th class="p-3 border-b border-slate-200">Quy·ªÅn H·∫°n</th>
                      <th class="p-3 border-b border-slate-200 text-center">Thao T√°c</th>
                  </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                  {#each accountList as acc}
                      <tr class="hover:bg-indigo-50/30 transition-colors group">
                          <td class="p-3">
                              <div class="font-bold text-slate-700">{acc.username}</div>
                              {#if acc.name && acc.name !== acc.username}
                                  <div class="text-[10px] text-gray-400">{acc.name}</div>
                              {/if}
                          </td>
                          <td class="p-3">
                              <select 
                                  class="bg-transparent text-xs font-bold outline-none cursor-pointer py-1 px-2 rounded border border-transparent hover:border-slate-300 transition-colors
                                  {acc.role==='admin'?'text-purple-600 bg-purple-50':(acc.role==='super_admin'?'text-red-600 bg-red-50':'text-slate-600 bg-slate-100')}" 
                                  value={acc.role} 
                                  on:change={(e) => changeRole(acc.id, e.target.value)}
                              >
                                  <option value="staff">Nh√¢n vi√™n</option>
                                  <option value="admin">Qu·∫£n l√Ω</option>
                                  {#if isSuperAdmin}<option value="super_admin">Super Admin</option>{/if}
                              </select>
                          </td>
                          <td class="p-3 text-center">
                              <div class="flex justify-center gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                                  <button class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-yellow-50 text-slate-400 hover:text-yellow-600 transition-colors" on:click={() => resetPassword(acc.id)} title="Reset M·∫≠t kh·∫©u v·ªÅ 123456">
                                       <span class="material-icons-round text-sm">lock_reset</span>
                                  </button>
                                  <button class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-50 text-slate-400 hover:text-red-600 transition-colors" on:click={() => deleteAccount(acc.id)} title="X√≥a t√†i kho·∫£n">
                                      <span class="material-icons-round text-sm">delete</span>
                                  </button>
                              </div>
                          </td>
                      </tr>
                  {/each}
                  {#if accountList.length === 0}
                      <tr>
                          <td colspan="3" class="p-8 text-center text-gray-400 flex flex-col items-center">
                              <span class="material-icons-round text-4xl mb-2 opacity-20">no_accounts</span>
                              <span class="text-xs">Ch∆∞a c√≥ nh√¢n s·ª± n√†o trong kho {selectedStoreId}.</span>
                          </td>
                      </tr>
                  {/if}
              </tbody>
          </table>
      </div>
  </div>
</div>

{#if showAddUserModal}
  <div class="fixed inset-0 z-[70] bg-slate-900/50 flex items-center justify-center p-4 backdrop-blur-sm" on:click={() => showAddUserModal = false}>
      <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl animate-popIn" on:click|stopPropagation>
          <h3 class="font-bold text-lg text-slate-800 mb-1">Th√™m Nh√¢n S·ª±</h3>
          
          {#if isSuperAdmin}
              <div class="mb-4">
                  <label for="store-input" class="text-[10px] font-bold text-slate-400 uppercase">Th√™m v√†o Kho (T·∫°o m·ªõi n·∫øu ch∆∞a c√≥)</label>
                  <input id="store-input" type="text" bind:value={targetStoreInput} class="w-full mt-1 p-2.5 bg-indigo-50 border border-indigo-200 rounded-lg text-sm font-bold text-indigo-700 outline-none focus:ring-2 focus:ring-indigo-200 uppercase" placeholder="NH·∫¨P M√É KHO (VD: KHO_01)">
              </div>
          {:else}
              <p class="text-xs text-gray-500 mb-4">Th√™m v√†o kho: <b class="text-indigo-600">{selectedStoreId}</b></p>
          {/if}
          
          <div class="space-y-3">
              <div>
                  <label for="single-role" class="text-[10px] font-bold text-slate-400 uppercase">Quy·ªÅn h·∫°n</label>
                  <select id="single-role" bind:value={singleRole} class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none focus:border-indigo-500">
                      <option value="staff">Nh√¢n vi√™n</option>
                      <option value="admin">Qu·∫£n l√Ω</option>
                  </select>
              </div>
              
              <div>
                  <label for="single-user" class="text-[10px] font-bold text-slate-400 uppercase">T√™n ƒëƒÉng nh·∫≠p</label>
                  <div class="relative mt-1">
                      <span class="material-icons-round absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">person</span>
                      <input id="single-user" type="text" bind:value={singleUsername} class="w-full pl-9 p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200" placeholder="VD: nv_moi">
                  </div>
              </div>
              
              <div>
                  <label for="single-pass" class="text-[10px] font-bold text-slate-400 uppercase">M·∫≠t kh·∫©u</label>
                  <div class="relative mt-1">
                      <span class="material-icons-round absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">lock</span>
                      <input id="single-pass" type="text" bind:value={singlePass} class="w-full pl-9 p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-gray-500 outline-none focus:border-indigo-500" placeholder="123456">
                  </div>
              </div>

              <div class="flex gap-3 pt-3 mt-2">
                  <button class="flex-1 py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold text-sm hover:bg-gray-200 transition-colors" on:click={() => showAddUserModal = false}>H·ªßy</button>
                  <button class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-bold text-sm shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:-translate-y-0.5 transition-all" on:click={handleCreateSingleUser}>L∆∞u L·∫°i</button>
              </div>
          </div>
      </div>
  </div>
{/if}

{#if showTour} <TourGuide steps={tourSteps} on:complete={() => showTour = false} /> {/if}

{#if isLoading}
  <div class="absolute inset-0 bg-white/50 backdrop-blur-[1px] flex items-center justify-center z-[60]">
      <div class="animate-spin text-indigo-600"><span class="material-icons-round text-3xl">sync</span></div>
  </div>
{/if}
--- END FILE: ./src/components/admin/AdminAccounts.svelte ---

--- START FILE: ./src/components/admin/AdminSchedule.svelte ---
<script>
  // Version 37.7 - Fix History Modal Loading (Added missing props)
  import { createEventDispatcher, onMount, tick } from 'svelte';
  import { db } from '../../lib/firebase';
  import { doc, getDoc, setDoc, serverTimestamp } from 'firebase/firestore';
  import { read, utils, writeFile } from 'xlsx';
  import { safeString } from '../../lib/utils';
  import { currentUser } from '../../lib/stores';
  import { calculateCombosFromMatrix, generateMonthlySchedule, SHIFT_DEFINITIONS, suggestPeakCombos } from '../../lib/scheduleLogic';
  import { optimizeSchedule, autoFixRotation, autoFixWeekendFairness, autoFixGenderBalance, manualBalanceGender } from '../../lib/optimization';
  import TourGuide from '../TourGuide.svelte'; 
  
  import ScheduleMatrix from './schedule/ScheduleMatrix.svelte';
  import SchedulePreview from './schedule/SchedulePreview.svelte';
  import StoreConfig from '../StoreConfig.svelte';
  export let targetStore = '';
  
  const dispatch = createEventDispatcher();
  let isLoading = false;
  let scheduleStaffList = [];
  let staffStats = { total: 0, male: 0, female: 0 };
  let scheduleMonth = new Date().getMonth() + 1;
  let scheduleYear = new Date().getFullYear();
  let showStoreConfig = false; 

  let showTour = false;
  const tourSteps = [
      { target: '#toolbar-actions', title: '1. C√¥ng C·ª• ƒê·∫ßu V√†o', content: 'N∆°i t·∫£i danh s√°ch nh√¢n vi√™n t·ª´ Excel v√† C·∫•u h√¨nh khung gi·ªù ho·∫°t ƒë·ªông.' },
      { target: '#month-navigator', title: '2. Ch·ªçn Th√°ng & Ch·∫ø ƒê·ªô', content: 'Ch·ªçn th√°ng c·∫ßn l√†m l·ªãch. Chuy·ªÉn ƒë·ªïi qua l·∫°i gi·ªØa <b>Th·ª© 2-6</b> v√† <b>T7-CN</b> ƒë·ªÉ nh·∫≠p ƒë·ªãnh m·ª©c ri√™ng.' },
      { target: '#matrix-header-target', title: '3. Nh·∫≠p ƒê·ªãnh M·ª©c', content: 'Nh·∫≠p s·ªë l∆∞·ª£ng nh√¢n vi√™n c·∫ßn thi·∫øt cho t·ª´ng b·ªô ph·∫≠n (Kho, Thu Ng√¢n...) t·∫°i c√°c khung gi·ªù b√™n d∆∞·ªõi.' },
      { target: '#btn-calculate', title: '4. T√≠nh To√°n T·ª± ƒê·ªông', content: 'B·∫•m n√∫t n√†y ƒë·ªÉ h·ªá th·ªëng quy ƒë·ªïi nhu c·∫ßu l·∫ª th√†nh c√°c Combo ca l√†m vi·ªác.' },
      { target: '#combo-header-target', title: '5. Tinh Ch·ªânh Combo', content: 'Xem k·∫øt qu·∫£ quy ƒë·ªïi b√™n d∆∞·ªõi. B·∫°n c√≥ th·ªÉ s·ª≠a tr·ª±c ti·∫øp s·ªë l∆∞·ª£ng ho·∫∑c Th√™m c·ªôt ca m·ªõi.' },
      { target: '#btn-preview-schedule', title: '6. T·∫°o & Xem Tr∆∞·ªõc', content: 'B∆∞·ªõc cu·ªëi: T·∫°o b·∫£ng ph√¢n ca chi ti·∫øt ƒë·ªÉ ki·ªÉm tra v√† √°p d·ª•ng.' }
  ];

  const defaultMatrix = { c1: { kho: 0, tn: 0, tv: 0, gh: 0 }, c2: { kho: 0, tn: 0, tv: 0, gh: 0 }, c3: { kho: 0, tn: 0, tv: 0, gh: 0 }, c4: { kho: 0, tn: 0, tv: 0, gh: 0 }, c5: { kho: 0, tn: 0, tv: 0, gh: 0 }, c6: { kho: 0, tn: 0, tv: 0, gh: 0 } };
  let shiftMatrix = JSON.parse(JSON.stringify(defaultMatrix)); 
  let weekendMatrix = JSON.parse(JSON.stringify(defaultMatrix));
  let suggestedCombos = []; 
  let suggestedWeekendCombos = [];
  let activeMatrixMode = 'weekday';
  let genderConfig = { kho: 'none', tn: 'none' };
  
  // Dynamic Columns State
  const DEFAULT_COLS = ['123', '456', '23', '45', '2-5', '2345', '123456', '12-56'];
  let customComboCols = [...DEFAULT_COLS]; 

  let showShortageAlert = false;
  let shortageCount = 0;
  let previewScheduleData = null;
  let previewStats = [];
  let originalResult = null;
  let optimizationLogs = [];
  let inspectionMode = 'none';
  const shiftCols = [ { id: 'c1', label: 'C1 (08-09h)' }, { id: 'c2', label: 'C2 (09-12h)' }, { id: 'c3', label: 'C3 (12-15h)' }, { id: 'c4', label: 'C4 (15-18h)' }, { id: 'c5', label: 'C5 (18-21h)' }, { id: 'c6', label: 'C6 (21-21h30)' } ];
  const roleRows = [ { id: 'kho', label: 'Kho', color: 'text-orange-600 bg-orange-50 border-orange-100' }, { id: 'tn', label: 'Thu Ng√¢n', color: 'text-purple-600 bg-purple-50 border-purple-100' }, { id: 'gh', label: 'Giao H√†ng', color: 'text-blue-600 bg-blue-50 border-blue-100' }, { id: 'tv', label: 'T∆∞ V·∫•n', color: 'text-gray-600 bg-gray-50 border-gray-200' } ];
  const QUICK_SHIFTS = ['OFF', '123', '456', '23', '45', '2345'];
  const INSPECTION_OPTIONS = [ { val: 'none', label: 'T·∫Øt soi l·ªói', icon: 'visibility_off', color: 'text-gray-400' }, { val: 'gender', label: 'Soi Gi·ªõi T√≠nh', icon: 'wc', color: 'text-pink-500' }, { val: 'weekend', label: 'C√¥ng B·∫±ng Cu·ªëi Tu·∫ßn', icon: 'balance', color: 'text-indigo-600' }, { val: 'rotation', label: 'Soi Nh·ªãp S√°ng/Chi·ªÅu', icon: 'sync_problem', color: 'text-orange-500' }, { val: 'fatigue', label: 'Soi Tr√πng Nghi·ªáp V·ª•', icon: 'battery_alert', color: 'text-red-600' } ];
  let editingShift = null; 
  let tempEditingShift = null;
  let selectedStaff = null;
  let selectedDayStats = null;
  $: isDemoMode = targetStore?.includes('DEMO');
  $: activeSuggestedCombos = activeMatrixMode === 'weekday' ? suggestedCombos : suggestedWeekendCombos;
  $: totalCombos = activeSuggestedCombos.reduce((sum, c) => sum + (parseInt(c.qty)||0), 0);
  let comboTotalsMap = {};
  $: { 
      const map = {};
      customComboCols.forEach(code => { 
          const items = activeSuggestedCombos.filter(c => c.code === code); 
          map[code] = items.reduce((sum, c) => sum + (parseInt(c.qty) || 0), 0); 
      });
      comboTotalsMap = map; 
  }

  $: if (scheduleStaffList) { try { staffStats = { total: scheduleStaffList.length, male: scheduleStaffList.filter(s => String(s.gender || '').trim().toLowerCase() === 'nam').length, female: scheduleStaffList.filter(s => String(s.gender || '').trim().toLowerCase() !== 'nam').length };
  } catch (e) { staffStats = { total: 0, male: 0, female: 0 };
  } }
  
  $: if (targetStore) loadStoreData();
  
  function checkDemoAndBlock(e) { if (isDemoMode) { e && e.preventDefault();
  alert("T√†i kho·∫£n demo kh√¥ng c√≥ t√≠nh nƒÉng n√†y!"); return true; } return false;
  }
  
  async function loadStoreData() { 
      if (!targetStore) return; 
      scheduleStaffList = [];
      shiftMatrix = JSON.parse(JSON.stringify(defaultMatrix)); 
      weekendMatrix = JSON.parse(JSON.stringify(defaultMatrix));
      suggestedCombos = []; 
      suggestedWeekendCombos = []; 
      previewScheduleData = null;
      try { 
          const staffSnap = await getDoc(doc(db, 'settings', `staff_list_${targetStore}`));
          if (staffSnap.exists()) scheduleStaffList = staffSnap.data().staffList || []; 
          
          const configSnap = await getDoc(doc(db, 'settings', `shift_matrix_${targetStore}`));
          if (configSnap.exists()) { 
              const data = configSnap.data();
              if (data.matrix) shiftMatrix = { ...defaultMatrix, ...data.matrix }; 
              if (data.approvedCombos) suggestedCombos = data.approvedCombos;
              if (data.weekendMatrix) weekendMatrix = { ...defaultMatrix, ...data.weekendMatrix }; 
              if (data.weekendCombos) suggestedWeekendCombos = data.weekendCombos; 
              if (data.genderConfig) genderConfig = data.genderConfig;
              if (data.comboCols && Array.isArray(data.comboCols)) {
                  customComboCols = data.comboCols;
              } else {
                  customComboCols = [...DEFAULT_COLS];
              }
          } 
      } catch (e) { console.error(e);
      } 
  }
  
  function downloadScheduleSample() { const wb = utils.book_new();
  const wsData = [["Ho_Ten", "Gioi_Tinh"], ["Nguy·ªÖn VƒÉn A", "Nam"], ["Tr·∫ßn Th·ªã B", "N·ªØ"]]; const ws = utils.aoa_to_sheet(wsData); utils.book_append_sheet(wb, ws, "DS_Nhan_Vien");
  writeFile(wb, `Mau_Phan_Ca_${targetStore}.xlsx`); }
  
  async function handleStaffUpload(e) { const file = e.target.files[0]; if(!file) return; isLoading = true;
  setTimeout(async () => { try { const data = await file.arrayBuffer(); const wb = read(data); const json = utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); let newStaff = []; for(let i=0; i<json.length; i++) { const row = json[i]; let name = row['Ho_Ten'] || row['H·ªç T√™n'] || ''; let gender = row['Gioi_Tinh'] || row['Gi·ªõi T√≠nh'] || 'N·ªØ'; if(name) { newStaff.push({ id: String(newStaff.length+1), name: safeString(name), gender: String(gender).toLowerCase().includes('nam') ? 'Nam' : 'N·ªØ' }); } } if(newStaff.length > 0) { scheduleStaffList = newStaff; await setDoc(doc(db, 'settings', `staff_list_${targetStore}`), { staffList: scheduleStaffList, updatedAt: serverTimestamp() }); alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t danh s√°ch: ${newStaff.length} nh√¢n vi√™n v√†o kho ${targetStore}.`); } else { alert(`‚ö†Ô∏è File kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!`); } } catch(e) { alert("L·ªói file: " + e.message); } finally { isLoading=false; e.target.value=null; } }, 100);
  }
  
  function updateComboQty(roleLabel, comboCode, newQty) { const qtyVal = parseInt(newQty) || 0;
  let currentList = activeMatrixMode === 'weekday' ?
  [...suggestedCombos] : [...suggestedWeekendCombos]; const targetRoles = [roleLabel];
  if (roleLabel === 'Thu Ng√¢n') targetRoles.push('TN', 'tn');
  if (roleLabel === 'Giao H√†ng') targetRoles.push('GH', 'gh');
  if (roleLabel === 'T∆∞ V·∫•n') targetRoles.push('TV', 'tv');
  const idx = currentList.findIndex(c => { const cRole = c.role || 'TV'; return c.code === comboCode && targetRoles.includes(cRole); });
  if (idx >= 0) { currentList[idx].qty = qtyVal; currentList[idx].role = roleLabel;
  } else if (qtyVal > 0) { currentList.push({ code: comboCode, role: roleLabel, label: `${roleLabel} ${comboCode}`, qty: qtyVal });
  } if (activeMatrixMode === 'weekday') suggestedCombos = currentList; else suggestedWeekendCombos = currentList;
  }
  
  async function saveGenderConfig(newConfig) { if (!targetStore) return; genderConfig = newConfig;
  try { await setDoc(doc(db, 'settings', `shift_matrix_${targetStore}`), { genderConfig }, { merge: true }); } catch (e) { console.error(e);
  } }
  
  function handleAddColumn() {
      customComboCols = [...customComboCols, ''];
  }

  function handleUpdateColumns(newCols) {
      customComboCols = newCols;
  }

  async function handleCalculateCombos(save = true) { if(save) isLoading = true;
  try { const clean = (m) => { const c = JSON.parse(JSON.stringify(m));
  Object.keys(c).forEach(key => { if(c[key]) ['kho', 'tn', 'tv', 'gh'].forEach(role => { let val = parseInt(c[key][role]); if (isNaN(val)) val = 0; c[key][role] = val; }); });
  return c; }; shiftMatrix = clean(shiftMatrix); weekendMatrix = clean(weekendMatrix); await tick(); showShortageAlert = false; shortageCount = 0;
  let tempWeekday = calculateCombosFromMatrix(shiftMatrix); let tempWeekend = calculateCombosFromMatrix(weekendMatrix); const checkShortage = (combos) => { const totalDemand = combos.reduce((sum, c) => sum + (parseInt(c.qty)||0), 0);
  return totalDemand > staffStats.total ? (totalDemand - staffStats.total) : 0; }; const s1 = checkShortage(tempWeekday); const s2 = checkShortage(tempWeekend);
  suggestedCombos = tempWeekday; 
  suggestedWeekendCombos = tempWeekend;
  
  if (s1 > 0 || s2 > 0) { shortageCount = Math.max(s1, s2);
  showShortageAlert = true; } 
  
  if(save) { 
      await setDoc(doc(db, 'settings', `shift_matrix_${targetStore}`), { 
          matrix: shiftMatrix, 
          approvedCombos: suggestedCombos, 
          weekendMatrix: weekendMatrix, 
          weekendCombos: suggestedWeekendCombos, 
          genderConfig, 
          comboCols: customComboCols, 
          updatedAt: serverTimestamp(), 
          updatedBy: $currentUser.username 
      });
  } } catch (e) { alert("L·ªói t√≠nh to√°n: " + e.message); } finally { if(save) isLoading = false;
  } }
  
  async function handleGeneratePreview() { if (totalCombos > staffStats.total) { 
    alert(`‚õî KH√îNG TH·ªÇ T·∫†O L·ªäCH!\n\nNhu c·∫ßu ƒëang c·∫ßn ${totalCombos} v·ªã tr√≠, nh∆∞ng ch·ªâ c√≥ ${staffStats.total} nh√¢n vi√™n.`);
  return; } if (suggestedCombos.length === 0 && suggestedWeekendCombos.length === 0) return alert("Ch∆∞a c√≥ combo n√†o!"); isLoading = true;
  try { let prevMonth = scheduleMonth - 1, prevYear = scheduleYear; if(prevMonth === 0) { prevMonth = 12; prevYear--;
  } let prevScheduleData = null; const prevSnap = await getDoc(doc(db, 'stores', targetStore, 'schedules', `${prevYear}-${String(prevMonth).padStart(2,'0')}`)); if(prevSnap.exists()) prevScheduleData = prevSnap.data();
  const comboPayload = { weekday: suggestedCombos, weekend: suggestedWeekendCombos }; const result = generateMonthlySchedule(scheduleStaffList, comboPayload, scheduleMonth, scheduleYear, prevScheduleData, genderConfig);
  originalResult = JSON.parse(JSON.stringify(result)); previewScheduleData = result.schedule; previewStats = result.staffStats; optimizationLogs = []; await tick();
  setTimeout(() => { const previewEl = document.getElementById('preview-schedule-container'); if(previewEl) previewEl.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
  } catch (e) { alert("L·ªói: " + e.message); } finally { isLoading = false;
  } }
  
  function handleManualBalance(e) {
    const config = e.detail;
    if (!previewScheduleData) return;
    const params = {
        fromGender: config.direction === 'male_to_female' ? 'Nam' : 'N·ªØ',
        toGender: config.direction === 'male_to_female' ? 'N·ªØ' : 'Nam',
        role: config.role,
        qty: parseInt(config.qty) || 1
    };

    isLoading = true;
    setTimeout(() => {
        const result = manualBalanceGender(previewScheduleData, scheduleStaffList, scheduleMonth, scheduleYear, params);
        
        if (result.count > 0) {
            previewScheduleData = result.schedule;
            optimizationLogs = [...optimizationLogs, ...result.logs];
            
            const newRoleStats = {};
            scheduleStaffList.forEach(s => {
                let h=0, tn=0, kho=0, gh=0;
                Object.values(previewScheduleData).forEach(dayList => {
                    const assign = dayList.find(a => a.staffId === s.id);
                    
                    if(assign && assign.shift !== 'OFF') {
                        if(assign.role==='Thu Ng√¢n' || assign.role==='TN') tn++;
                        if(assign.role==='Kho' || assign.role==='K') kho++;
                        if(assign.role==='Giao H√†ng' || assign.role==='GH') gh++;
                    }
                });
                newRoleStats[s.id] = { tn, kho, gh };
            });

            previewStats = previewStats.map(s => {
                if (newRoleStats[s.id]) return { ...s, ...newRoleStats[s.id] };
                return s;
            });
            alert(`‚úÖ ƒê√£ ƒë·ªïi th√†nh c√¥ng ${result.count} ca!`);
        } else {
            alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ca n√†o ph√π h·ª£p ƒë·ªÉ ƒë·ªïi (ho·∫∑c ƒë√£ vi ph·∫°m h·∫øt c√°c ƒëi·ªÅu ki·ªán ∆∞u ti√™n).");
        }
        isLoading = false;
    }, 200);
  }

  function getShiftColor(code) { if (code === 'OFF') return 'bg-slate-100 text-slate-400 border-slate-200 font-bold tracking-wider text-[10px]';
  const map = { '123': 'bg-green-50 text-green-700 border-green-100', '456': 'bg-orange-50 text-orange-700 border-orange-100', '23': 'bg-cyan-50 text-cyan-700 border-cyan-100', '45': 'bg-blue-50 text-blue-700 border-blue-100', '2-5': 'bg-pink-50 text-pink-700 border-pink-100', '2345': 'bg-red-50 text-red-700 border-red-100', '12-56': 'bg-purple-100 text-purple-700 border-purple-200' };
  return map[code] || 'bg-white text-gray-800 border-gray-200'; }
  function getRoleBadge(role) { if (!role || role === 'TV') return null;
  if (role === 'GH' || role === 'Giao H√†ng') return { text: 'GH', class: 'bg-blue-600 text-white' };
  if (role === 'Thu Ng√¢n' || role === 'TN') return { text: 'TN', class: 'bg-purple-600 text-white' };
  if (role === 'Kho') return { text: 'K', class: 'bg-orange-500 text-white' }; return { text: role.charAt(0), class: 'bg-gray-500 text-white' };
  }
  function isWeekendDay(d) { const date = new Date(scheduleYear, scheduleMonth - 1, d); const dayOfWeek = date.getDay();
  return (dayOfWeek === 0 || dayOfWeek === 6); }
  function getShiftGroup(code) { 
      return 'OFF';
  }
  function isHardRole(roleName) { return ['Kho', 'Thu Ng√¢n', 'Giao H√†ng', 'GH', 'TN', 'K'].includes(roleName);
  }
  function getWeekday(day) { const date = new Date(scheduleYear, scheduleMonth - 1, day);
  return ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][date.getDay()]; }
  function getWeekendFairnessStatus(staffId) { if (inspectionMode !== 'weekend' || !previewScheduleData) return 0;
  const allStats = previewStats.map(s => { let count = 0; Object.keys(previewScheduleData).forEach(d => { if (isWeekendDay(d)) { const assign = previewScheduleData[d].find(a => a.staffId === s.id); if (assign && isHardRole(assign.role)) count++; } }); return { id: s.id, count }; });
  const counts = allStats.map(x => x.count); const max = Math.max(...counts); const min = Math.min(...counts);
  const myStat = allStats.find(x => x.id === staffId); if (!myStat) return 0; if (max - min <= 1) return 0;
  if (myStat.count === max) return 1; if (myStat.count === min) return -1; return 0;
  }
  function getWeekendHardRoleCount(staffId) { if (!previewScheduleData) return 0; let count = 0;
  Object.keys(previewScheduleData).forEach(d => { if (isWeekendDay(d)) { const assign = previewScheduleData[d].find(a => a.staffId === staffId); if (assign && isHardRole(assign.role)) count++; } });
  return count; }
  function checkInspectionError(d, assign, currentMode) { const mode = currentMode || inspectionMode;
  if (mode === 'none') return false; if (!assign || assign.shift === 'OFF') return false;
  if (mode === 'gender') { if (genderConfig.kho === 'none' && genderConfig.tn === 'none') return false; const dayAssignments = previewScheduleData[d] || []; 
  const sameShiftRole = dayAssignments.filter(a => a.shift === assign.shift && a.role === assign.role && a.shift !== 'OFF');
  if (assign.role === 'Kho') { if (genderConfig.kho === 'male_only' && !assign.gender.toLowerCase().includes('nam')) return `Kho ca ${assign.shift} y√™u c·∫ßu Nam`;
  if (genderConfig.kho === 'mixed') { const hasMale = sameShiftRole.some(a => a.gender === 'Nam');
  if (!hasMale) return `Kho ca ${assign.shift} thi·∫øu Nam`; } } if (assign.role === 'Thu Ng√¢n') { if (genderConfig.tn === 'female_only' && assign.gender === 'Nam') return `TN ca ${assign.shift} y√™u c·∫ßu N·ªØ`;
  if (genderConfig.tn === 'mixed') { const hasMale = sameShiftRole.some(a => a.gender === 'Nam');
  const hasFemale = sameShiftRole.some(a => a.gender !== 'Nam'); if (!hasMale || !hasFemale) return `TN ca ${assign.shift} thi·∫øu c·∫∑p ƒë√¥i`;
  } } return false; } if (mode === 'weekend') { if (!isWeekendDay(d) || !isHardRole(assign.role)) return false; const rowStatus = getWeekendFairnessStatus(assign.staffId);
  if (rowStatus === 1) return "D∆∞ ca nghi·ªáp v·ª• cu·ªëi tu·∫ßn"; return false;
  } if (mode === 'rotation') { if (d == 1) return false; const prevAssign = previewScheduleData[d-1]?.find(a => a.staffId === assign.staffId);
  if (!prevAssign || prevAssign.shift === 'OFF') return false; 
  return false;
  } if (mode === 'fatigue') { if (d == 1) return false;
  const prevAssign = previewScheduleData[d-1]?.find(a => a.staffId === assign.staffId);
  if (!prevAssign || !prevAssign.role) return false;
  if (isHardRole(prevAssign.role) && isHardRole(assign.role)) { return `L√†m nghi·ªáp v·ª• li√™n ti·∫øp 2 ng√†y`;
  } return false; } return false;
  }
  function isCellRelevant(d, assign, currentMode) { const mode = currentMode || inspectionMode;
  if (mode === 'none') return true;
  if (checkInspectionError(d, assign, mode)) return true; if (mode === 'weekend' && isWeekendDay(d)) return true;
  if (mode === 'rotation') return true;
  return false; }
  
  function handleAutoFixRotation() { if (!previewScheduleData) return;
  isLoading = true;
  setTimeout(() => { const result = autoFixRotation(previewScheduleData, scheduleMonth, scheduleYear); if (result.success) { previewScheduleData = result.schedule; optimizationLogs = [...optimizationLogs, ...result.logs]; alert(`‚úÖ ƒê√£ s·ª≠a th√†nh c√¥ng ${result.count} l·ªói!`); } else { alert("‚úÖ H·ªá th·ªëng ƒë√£ t·ªëi ∆∞u."); } isLoading = false; }, 300);
  }
  function handleAutoFixWeekend() { if (!previewScheduleData) return; isLoading = true;
  setTimeout(() => { const result = autoFixWeekendFairness(previewScheduleData, scheduleMonth, scheduleYear, scheduleStaffList); if (result.success) { previewScheduleData = result.schedule; optimizationLogs = [...optimizationLogs, ...result.logs]; previewStats = [...previewStats]; alert(`‚úÖ ƒê√£ c√¢n b·∫±ng l·∫°i ${result.count} ca cu·ªëi tu·∫ßn!`); } else { alert("‚úÖ H·ªá th·ªëng ƒë√£ t·ªëi ∆∞u."); } isLoading = false; }, 300);
  }
  function handleAutoFixGender() { if (!previewScheduleData) return; const dryRun = autoFixGenderBalance(previewScheduleData, scheduleMonth, scheduleYear, false);
  if (!dryRun.success && !dryRun.hasConflict) { alert("‚úÖ Kh√¥ng t√¨m th·∫•y l·ªói gi·ªõi t√≠nh c√≥ th·ªÉ s·ª≠a."); return;
  } if (dryRun.hasConflict) { if (confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO XUNG ƒê·ªòT!\n\nC√¢n b·∫±ng gi·ªõi t√≠nh s·∫Ω g√¢y l·ªói Xoay Ca. B·ªé QUA lu·∫≠t xoay ca?`)) { const forceFix = autoFixGenderBalance(previewScheduleData, scheduleMonth, scheduleYear, true);
  previewScheduleData = forceFix.schedule; optimizationLogs = [...optimizationLogs, ...forceFix.logs]; alert(`‚úÖ ƒê√£ s·ª≠a ${forceFix.count} l·ªói (Ch·∫•p nh·∫≠n g√£y nh·ªãp)!`);
  } } else { previewScheduleData = dryRun.schedule; optimizationLogs = [...optimizationLogs, ...dryRun.logs]; alert(`‚úÖ ƒê√£ s·ª≠a th√†nh c√¥ng ${dryRun.count} l·ªói!`);
  } }
  function handleOptimize() { if (!previewScheduleData) return; const beforeOptimizeJSON = JSON.stringify(previewScheduleData); isLoading = true;
  setTimeout(() => { const optResult = optimizeSchedule(previewScheduleData, scheduleStaffList); const afterOptimizeJSON = JSON.stringify(optResult.optimizedSchedule); if (beforeOptimizeJSON === afterOptimizeJSON) { alert("‚úÖ L·ªãch hi·ªán t·∫°i ƒë√£ t·ªëi ∆∞u!"); isLoading = false; return; } previewScheduleData = optResult.optimizedSchedule; const newRoleStats = {}; optResult.finalStats.forEach(s => newRoleStats[s.id] = s.roles); previewStats = previewStats.map(s => { if (newRoleStats[s.id]) { return { ...s, ...newRoleStats[s.id] }; } return s; }); optimizationLogs = optResult.changesLog; isLoading = false; }, 200);
  }
  
  async function handleApplySchedule() { 
      if (!previewScheduleData) return;
      if (!confirm(`‚ö†Ô∏è X√ÅC NH·∫¨N √ÅP D·ª§NG L·ªäCH TH√ÅNG ${scheduleMonth}/${scheduleYear}?`)) return;
      
      isLoading = true;
      try { 
          const scheduleId = `${scheduleYear}-${String(scheduleMonth).padStart(2,'0')}`;
          const mainRef = doc(db, 'stores', targetStore, 'schedules', scheduleId);
          
          const currentSnap = await getDoc(mainRef);
          if (currentSnap.exists()) {
              const backupRef = doc(db, 'stores', targetStore, 'schedules', `${scheduleId}_backup`);
              await setDoc(backupRef, currentSnap.data());
              console.log("‚úÖ ƒê√£ t·∫°o backup b·∫£n l·ªãch c≈©.");
          }

          await setDoc(mainRef, { 
              config: { matrix: shiftMatrix, approvedCombos: suggestedCombos, genderConfig, comboCols: customComboCols }, 
              data: previewScheduleData, 
              stats: previewStats, 
              endOffset: originalResult.endOffset, 
              updatedAt: serverTimestamp(), 
              updatedBy: $currentUser.username 
          });
          alert("‚úÖ ƒê√£ √°p d·ª•ng l·ªãch th√†nh c√¥ng!"); 
          dispatch('switchTab', 'schedule'); 
      } catch (e) { 
          alert("L·ªói: " + e.message);
      } finally { 
          isLoading = false;
      } 
  }

  async function handleRestoreBackup() {
      if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√¥i ph·ª•c l·∫°i phi√™n b·∫£n l·ªãch tr∆∞·ªõc ƒë√≥?")) return;
      isLoading = true;
      try {
          const scheduleId = `${scheduleYear}-${String(scheduleMonth).padStart(2,'0')}`;
          const backupRef = doc(db, 'stores', targetStore, 'schedules', `${scheduleId}_backup`);
          const backupSnap = await getDoc(backupRef);
          if (!backupSnap.exists()) {
              alert("‚ùå Kh√¥ng t√¨m th·∫•y b·∫£n sao l∆∞u n√†o ƒë·ªÉ kh√¥i ph·ª•c.");
              isLoading = false;
              return;
          }

          const mainRef = doc(db, 'stores', targetStore, 'schedules', scheduleId);
          await setDoc(mainRef, backupSnap.data());

          alert("‚úÖ ƒê√£ kh√¥i ph·ª•c th√†nh c√¥ng l·ªãch c≈©!");
          dispatch('switchTab', 'schedule');
      } catch (e) {
          alert("L·ªói kh√¥i ph·ª•c: " + e.message);
      } finally {
          isLoading = false;
      }
  }

  function openEditPreviewShift(day, staffId, assign) { const staffInfo = previewStats.find(s => s.id === staffId);
  tempEditingShift = { day, staffId, name: assign.name, shift: assign.shift, role: assign.role || 'TV', isOFF: assign.shift === 'OFF', gender: staffInfo ?
  staffInfo.gender : 'N·ªØ', originalRole: assign.originalRole !== undefined ? assign.originalRole : (assign.role || 'TV'), originalShift: assign.originalShift !== undefined ?
  assign.originalShift : assign.shift }; editingShift = JSON.parse(JSON.stringify(tempEditingShift)); }
  function resetEditPreviewShift() { if (!editingShift) return; editingShift.shift = editingShift.originalShift;
  editingShift.role = editingShift.originalRole; editingShift.isOFF = editingShift.shift === 'OFF'; }
  function savePreviewShiftChange() { if (!editingShift || !previewScheduleData) return;
  const dayKey = String(editingShift.day); const dayList = [...previewScheduleData[dayKey]]; const idx = dayList.findIndex(x => x.staffId === editingShift.staffId);
  if (idx !== -1) { const oldRole = dayList[idx].role || 'TV'; const newRole = editingShift.isOFF ?
  '' : (editingShift.role === 'TV' ? '' : editingShift.role); dayList[idx] = { ...dayList[idx], shift: editingShift.isOFF ?
  'OFF' : editingShift.shift, role: newRole, isChanged: true }; previewScheduleData[dayKey] = dayList; const newStats = [...previewStats];
  const statIdx = newStats.findIndex(s => s.id === editingShift.staffId); if (statIdx !== -1) { const s = newStats[statIdx];
  let rOld = oldRole === 'Giao H√†ng' ? 'gh' : (oldRole === 'Thu Ng√¢n' ? 'tn' : (oldRole === 'Kho' ? 'kho' : ''));
  if(rOld) s[rOld] = Math.max(0, (s[rOld]||0) - 1); let rNew = newRole === 'Giao H√†ng' ?
  'gh' : (newRole === 'Thu Ng√¢n' ? 'tn' : (newRole === 'Kho' ? 'kho' : ''));
  if(rNew) s[rNew] = (s[rNew]||0) + 1; previewStats = newStats; } editingShift = null;
  } }
  function viewPersonalSchedule(staffId, staffName) { if(!previewScheduleData) return; let days = Object.keys(previewScheduleData).sort((a,b)=>Number(a)-Number(b)).map(d => { const assign = previewScheduleData[d].find(x => x.staffId === staffId); if(assign) return { day: d, weekday: getWeekday(d), ...assign }; return null; }).filter(x=>x);
  const firstDayDate = new Date(scheduleYear, scheduleMonth - 1, 1); let startDayIdx = firstDayDate.getDay(); if (startDayIdx === 0) startDayIdx = 6;
  else startDayIdx = startDayIdx - 1; let blankCells = Array(startDayIdx).fill(null); const stat = previewStats.find(s => s.id === staffId) ||
  { totalHours:0, gh:0, tn:0, kho:0 }; selectedStaff = { id: staffId, name: staffName, days, blankCells, stats: stat };
  }
  function showDayStats(day) { if (!previewScheduleData || !previewScheduleData[day]) return; const dayData = previewScheduleData[day];
  const roles = ['Kho', 'Thu Ng√¢n', 'GH', 'TV']; const matrix = { 'Kho': {}, 'Thu Ng√¢n': {}, 'GH': {}, 'TV': {} };
  const activeShifts = new Set(); let totalHours = 0; dayData.forEach(assign => { if (assign.shift !== 'OFF') { activeShifts.add(assign.shift); } });
  const cols = Array.from(activeShifts).sort(); roles.forEach(r => { cols.forEach(c => matrix[r][c] = 0); matrix[r]['Total'] = 0; });
  dayData.forEach(assign => { if (assign.shift === 'OFF') return; let r = assign.role || 'TV'; if (r === 'TN') r = 'Thu Ng√¢n'; if (matrix[r]) { matrix[r][assign.shift] = (matrix[r][assign.shift] || 0) + 1; matrix[r]['Total']++; } });
  selectedDayStats = { day, weekday: getWeekday(day), cols, matrix, roles, totalHours }; }
  function getDayColTotal(col) { return selectedDayStats ?
  selectedDayStats.roles.reduce((sum, r) => sum + (selectedDayStats.matrix[r][col]||0), 0) : 0; }
  function getDayGrandTotal() { return selectedDayStats ?
  selectedDayStats.roles.reduce((sum, r) => sum + selectedDayStats.matrix[r]['Total'], 0) : 0; }
  function handleResetPreview() { previewScheduleData = null; previewStats = [];
  optimizationLogs = []; }
  function handleDayHeaderClick(d) { showDayStats(d); }
</script>

<div class="flex flex-col gap-6 w-full pb-20 animate-fadeIn">
    <div class="flex flex-wrap items-center justify-between gap-4 border-b border-slate-200 pb-4">
        <div class="flex items-center gap-2">
            <div id="toolbar-actions" class="flex items-center gap-2">
                <button class="bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-2 px-3 rounded-lg text-xs transition-colors flex items-center gap-1 border border-blue-100" on:click={(e) => checkDemoAndBlock(e) ||
                downloadScheduleSample()}>T·∫£i M·∫´u</button>
                <label class="bg-blue-600 text-white hover:bg-blue-700 font-bold py-2 px-3 rounded-lg text-xs cursor-pointer flex items-center gap-1 shadow-lg shadow-blue-200 transition-all active:scale-95">
                    <span class="material-icons-round text-sm">upload</span> Upload
                    <input type="file" hidden accept=".xlsx" disabled={isDemoMode} on:change={(e) => handleStaffUpload(e)}>
                </label>
                <div class="w-px h-8 bg-slate-200 mx-1"></div>
                <button class="bg-gray-100 text-gray-600 hover:bg-gray-200 font-bold py-2 px-3 rounded-lg text-xs transition-colors flex items-center gap-1 border border-gray-200" on:click={()=>showStoreConfig=true}>
                    <span class="material-icons-round text-sm">settings</span> Khai b√°o gi·ªù c√¥ng
                </button>
            </div>
        </div>
        <div class="flex items-center gap-2">
             <button id="btn-help-schedule" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400" on:click={() => showTour = true}><span class="material-icons-round">help_outline</span></button>
        </div>
    </div>

    <div id="matrix-input-area">
        <ScheduleMatrix 
            bind:staffStats
            bind:shiftMatrix
            bind:weekendMatrix
            bind:activeMatrixMode
            bind:scheduleMonth
            bind:scheduleYear
            {shiftCols}
            {roleRows}
            comboCols={customComboCols}
            {activeSuggestedCombos}
            {comboTotalsMap}
            {genderConfig}
            on:modeChange={(e) => activeMatrixMode = e.detail}
            on:monthChange={(e) => {
                if(e.detail === 1) { if(scheduleMonth==12){scheduleMonth=1;scheduleYear++}else{scheduleMonth++} }
                else { if(scheduleMonth==1){scheduleMonth=12;scheduleYear--}else{scheduleMonth--} }
            }}
            on:calculate={() => handleCalculateCombos(true)}
            on:updateCombo={(e) => updateComboQty(e.detail.role, e.detail.code, e.detail.qty)}
            on:configChange={(e) => { const newConf = {...genderConfig};
            newConf[e.detail.type] = e.detail.val; saveGenderConfig(newConf); }}
            on:preview={handleGeneratePreview}
            on:addCol={handleAddColumn}
            on:updateCols={(e) => handleUpdateColumns(e.detail)}
        />
    </div>

    <div id="combo-table-area">
        <SchedulePreview 
            storeId={targetStore}          
            viewMonth={scheduleMonth}      
            viewYear={scheduleYear}        

            bind:inspectionMode
            {previewScheduleData}
            {previewStats}
            {optimizationLogs}
            {INSPECTION_OPTIONS}
            {checkInspectionError}
            {getWeekendFairnessStatus}
            {getWeekendHardRoleCount}
            {getWeekday}
            {getShiftColor}
            {getRoleBadge}
            {isCellRelevant}
            on:inspectionChange={(e) => inspectionMode = e.detail}
            on:fixRotation={handleAutoFixRotation}
            on:fixWeekend={handleAutoFixWeekend}
            on:fixGender={handleAutoFixGender}
            on:optimize={handleOptimize}
            on:reset={handleResetPreview}
            on:apply={handleApplySchedule}
            on:restore={handleRestoreBackup} 
            on:cellClick={(e) => openEditPreviewShift(e.detail.day, e.detail.staffId, e.detail.assign)}
            on:staffClick={(e) => viewPersonalSchedule(e.detail.id, e.detail.name)}
            on:headerClick={(e) => handleDayHeaderClick(e.detail)}
            on:balanceGender={handleManualBalance}
        />
    </div>
</div>

{#if showStoreConfig} <StoreConfig storeId={targetStore} on:close={()=>showStoreConfig=false} /> {/if}
{#if isLoading}<div class="absolute inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center z-[60]"><div class="animate-bounce font-bold text-indigo-900 text-lg">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</div></div>{/if}

{#if editingShift} 
    <div class="fixed inset-0 z-[80] bg-slate-900/60 flex items-center justify-center p-4 backdrop-blur-sm" on:click={()=>editingShift=null}> 
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl" on:click|stopPropagation> 
            <div class="flex justify-between items-start mb-4"> 
                <div>
                    <h3 class="font-bold text-lg text-slate-800">S·ª≠a Ca: {editingShift.name}</h3>
                    <p class="text-xs text-gray-500">Ng√†y {editingShift.day} - Hi·ªán t·∫°i: <span class="font-bold">{tempEditingShift.shift}</span></p>
                </div> 
                {#if editingShift.shift !== editingShift.originalShift ||
                editingShift.role !== editingShift.originalRole} 
                    <button class="text-xs text-red-600 hover:underline font-bold bg-red-50 px-2 py-1 rounded" on:click={resetEditPreviewShift}>Reset v·ªÅ g·ªëc</button> 
                {/if} 
            </div> 
            <div class="space-y-4"> 
                <div> 
                    <label class="block text-xs font-bold text-gray-500 mb-2">Ch·ªçn Ca Nhanh</label> 
                    <div class="grid grid-cols-3 gap-2 mb-2"> 
                        {#each QUICK_SHIFTS as s} 
                            <button class="py-2 border rounded-lg font-bold text-xs transition-all shadow-sm {editingShift.isOFF && s==='OFF' ? 'bg-red-600 text-yellow-300 border-red-600 ring-2 ring-red-200' : (!editingShift.isOFF && editingShift.shift === s ? 'bg-indigo-600 text-white border-indigo-600 ring-2 ring-indigo-200' : 'bg-white hover:bg-gray-50 text-gray-600 border-gray-200')}" on:click={() => { if(s === 'OFF') { editingShift.isOFF = true;
                            editingShift.shift = 'OFF'; } else { editingShift.isOFF = false; editingShift.shift = s;
                            } }}>{s}</button> 
                        {/each} 
                    </div> 
                    <label class="block text-xs font-bold text-gray-500 mb-1 mt-3">Ca T√πy Ch·ªânh</label> 
                    <input type="text" value={editingShift.isOFF 
                    ? 'OFF' : editingShift.shift} on:input={(e) => { if(!editingShift.isOFF) editingShift.shift = e.target.value;
                    }} disabled={editingShift.isOFF} class="w-full p-2.5 border rounded-lg text-center font-bold text-sm transition-colors {editingShift.isOFF ? 'bg-red-600 text-yellow-300 border-red-600 cursor-not-allowed opacity-100' : 'bg-white text-slate-800 border-gray-300 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200'}" placeholder="Nh·∫≠p m√£ ca (vd: 12-56)"> 
                </div> 
                {#if !editingShift.isOFF} 
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 animate-fadeIn"> 
                        <label class="block text-xs font-bold text-gray-500 mb-2">Vai Tr√≤ M·ªõi</label> 
                        <div class="grid grid-cols-2 gap-2"> 
                            {#each ['TV', 'Thu Ng√¢n', 'Kho', 'GH'] as r} 
                                <label class="flex items-center gap-2 cursor-pointer bg-white p-2 rounded border border-gray-200 hover:border-indigo-300 transition-colors"> 
                                    <input type="radio" bind:group={editingShift.role} value={r} class="accent-indigo-600 w-4 h-4"> 
                                    <span class="text-xs font-bold {r==='GH'?'text-blue-600':(r==='Thu Ng√¢n'?'text-purple-600':(r==='Kho'?'text-orange-600':'text-gray-600'))}">{r}</span> 
                                </label> 
                            {/each} 
                        </div> 
                    </div> 
                {/if} 
            </div> 
            <div class="flex gap-3 mt-6"> 
                <button class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold text-sm hover:bg-slate-200 transition-colors" on:click={()=>editingShift=null}>H·ªßy B·ªè</button> 
                <button class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold text-sm shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:-translate-y-0.5 transition-all" on:click={savePreviewShiftChange}>L∆∞u Thay ƒê·ªïi</button> 
            </div> 
        </div> 
    </div> 
{/if}

{#if selectedStaff} 
    <div class="fixed inset-0 z-[90] bg-slate-900/60 flex items-center justify-center p-4 backdrop-blur-sm" on:click={()=>selectedStaff=null}> 
        <div class="bg-white w-full max-w-sm rounded-xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]" on:click|stopPropagation> 
            <div class="p-4 bg-indigo-500 text-white shrink-0"> 
                <h3 class="font-bold text-lg">{selectedStaff.name}</h3> 
                <div class="flex justify-between mt-2 text-xs font-bold bg-indigo-600/50 p-2 rounded"> 
                    <span>{Math.round(selectedStaff.stats.totalHours) ||
                    0} Gi·ªù</span> 
                    <span class="text-blue-100">GH: {selectedStaff.stats.gh ||
                    0}</span> 
                    <span class="text-purple-100">TN: {selectedStaff.stats.tn ||
                    0}</span> 
                    <span class="text-orange-100">K: {selectedStaff.stats.kho ||
                    0}</span> 
                </div> 
            </div> 
            <div class="flex-1 overflow-y-auto p-3 bg-slate-100"> 
                <div class="grid grid-cols-7 gap-1 mb-1 text-center text-[10px] font-bold text-gray-400 uppercase"> 
                    {#each ['T2','T3','T4','T5','T6','T7','CN'] as day}<div>{day}</div>{/each} 
                </div> 
                <div class="grid grid-cols-7 gap-1"> 
                    {#each selectedStaff.blankCells as _}<div class="bg-transparent"></div>{/each} 
                    {#each selectedStaff.days as d} 
                        <div class="bg-white rounded border shadow-sm p-1 flex flex-col items-center justify-center aspect-square {d.shift==='OFF'?'opacity-60 bg-slate-100':''}"> 
                            <div class="text-[10px] text-gray-400 font-bold mb-1">{d.day}</div> 
                            <div class="font-black text-slate-800 text-xs {d.shift==='OFF'?'text-slate-400':''}">{d.shift}</div> 
                            {#if d.shift !== 'OFF'} 
                                {@const badge = getRoleBadge(d.role)} 
                                {#if badge}<span class="text-[9px] font-bold px-1 rounded mt-0.5 leading-tight {badge.class}">{badge.text}</span>{/if} 
                            {/if} 
                        </div> 
                    {/each} 
                </div> 
            </div> 
            <div class="p-3 border-t bg-white text-center"><button class="w-full py-2 bg-gray-100 rounded text-gray-600 font-bold text-sm" on:click={()=>selectedStaff=null}>ƒê√≥ng</button></div> 
        </div> 
    </div> 
{/if}

{#if selectedDayStats} 
    <div class="fixed inset-0 z-[90] bg-slate-900/60 flex items-center justify-center p-4 backdrop-blur-sm" on:click={()=>selectedDayStats=null}> 
        <div class="bg-white w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl" on:click|stopPropagation> 
            <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"> 
                <h3 class="font-bold text-lg text-slate-800"> Chi Ti·∫øt Ng√†y {selectedDayStats.day} ({selectedDayStats.weekday}) <span class="ml-2 text-sm text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg">T·ªïng c√¥ng: {selectedDayStats.totalHours} gi·ªù</span> </h3> 
                <button on:click={()=>selectedDayStats=null} class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center"><span class="material-icons-round text-slate-500">close</span></button> 
            </div> 
            <div class="p-5 overflow-x-auto"> 
                <table class="w-full text-sm border-separate border-spacing-0 rounded-xl overflow-hidden border border-slate-200"> 
                    <thead class="bg-slate-50 text-slate-500"><tr><th class="p-3 text-left font-bold border-b border-r border-slate-200">B·ªô Ph·∫≠n</th>{#each selectedDayStats.cols as col}<th class="p-2 text-center border-b border-slate-200 border-l border-white min-w-[50px]"><div class="font-black text-slate-700">{col}</div></th>{/each}<th class="p-3 text-center font-bold bg-slate-100 border-b border-l border-slate-200 text-slate-700">T·ªïng</th></tr></thead> 
                    <tbody> 
                        {#each selectedDayStats.roles as role} 
                            <tr class="hover:bg-slate-50 transition-colors"> 
                                <td class="p-3 font-bold border-r border-slate-100 {role==='GH'?'text-blue-600':(role==='Thu Ng√¢n'?'text-purple-600':(role==='Kho'?'text-orange-600':'text-gray-600'))}">{role}</td> 
                                {#each selectedDayStats.cols as col}<td class="p-2 border-r border-slate-100 text-center font-mono {selectedDayStats.matrix[role][col]>0?'font-bold text-slate-800':'text-gray-300'}">{selectedDayStats.matrix[role][col] || '-'}</td>{/each} 
                                <td class="p-3 text-center font-black text-slate-700 bg-slate-50 border-l border-slate-100">{selectedDayStats.matrix[role]['Total']}</td> 
                            </tr> 
                        {/each} 
                    </tbody> 
                    <tfoot class="bg-slate-800 text-slate-300 font-bold"><tr><td class="p-3 text-right text-xs uppercase tracking-wider">T·ªïng C·ªông</td>{#each selectedDayStats.cols as col}<td class="p-3 text-center text-yellow-400 font-mono text-lg">{getDayColTotal(col)}</td>{/each}<td class="p-3 text-center text-white text-xl bg-slate-900">{getDayGrandTotal()}</td></tr></tfoot> 
                </table> 
            </div> 
        </div> 
    </div> 
{/if}

{#if showTour} <TourGuide steps={tourSteps} on:complete={() => showTour = false} /> {/if}
--- END FILE: ./src/components/admin/AdminSchedule.svelte ---

--- START FILE: ./src/components/admin/AdminTemplate.svelte ---
<script>
  // Version 6.1 - Auto-Create Always & User Tracking + Tour Guide
  import { onMount } from 'svelte';
  import { db } from '../../lib/firebase';
  import { doc, setDoc, addDoc, collection, serverTimestamp, onSnapshot } from 'firebase/firestore';
  import { getTodayStr } from '../../lib/utils';
  import { currentUser } from '../../lib/stores';
  import TourGuide from '../TourGuide.svelte'; // Import TourGuide

  export let targetStore = ''; 

  let activeTemplateType = 'warehouse';
  let newTemplateTime = '08:00';
  let newTemplateTitle = '';
  let newTemplateImportant = false;
  let selectedDays = [0, 1, 2, 3, 4, 5, 6];
  let editingTemplateIndex = -1;
  
  let localTemplateData = {};
  let unsub = () => {};

  // --- TOUR GUIDE CONFIG ---
  let showTour = false;
  const tourSteps = [
      { target: '#dept-select-container', title: '1. Ch·ªçn B·ªô Ph·∫≠n', content: 'Ch·ªçn tab m√† c√¥ng vi·ªác n√†y s·∫Ω xu·∫•t hi·ªán (Kho, Thu Ng√¢n hay B√†n Giao).' },
      { target: '#time-input', title: '2. Ch·ªçn Gi·ªù', content: 'C√¥ng vi·ªác s·∫Ω ƒë∆∞·ª£c s·∫Øp x·∫øp theo th·ªùi gian n√†y trong ng√†y.' },
      { target: '#weekdays-container', title: '3. Ch·ªçn Ng√†y L·∫∑p', content: 'Ch·ªçn c√°c th·ª© trong tu·∫ßn m√† c√¥ng vi·ªác n√†y c·∫ßn l√†m (M√†u xanh l√† ƒë∆∞·ª£c ch·ªçn).' },
      { target: '#btn-save-template', title: '4. Th√™m/L∆∞u', content: 'B·∫•m v√†o ƒë√¢y ƒë·ªÉ l∆∞u m·∫´u. N·∫øu ng√†y l·∫∑p tr√πng h√¥m nay, c√¥ng vi·ªác s·∫Ω t·ª± ƒë·ªông hi·ªán ra ngo√†i trang ch·ªß.' }
  ];
  // -------------------------

  const weekDays = [
      { val: 1, label: 'T2' }, { val: 2, label: 'T3' }, { val: 3, label: 'T4' },
      { val: 4, label: 'T5' }, { val: 5, label: 'T6' }, { val: 6, label: 'T7' }, { val: 0, label: 'CN' }
  ];

  $: if (targetStore) loadTemplateForStore(targetStore);

  function loadTemplateForStore(sid) {
      if (unsub) unsub();
      localTemplateData = {};
      unsub = onSnapshot(doc(db, 'settings', `template_${sid}`), (docSnap) => {
          if (docSnap.exists()) localTemplateData = docSnap.data();
          else localTemplateData = {};
      });
  }

  function toggleDay(d) {
      if (selectedDays.includes(d)) {
          if (selectedDays.length > 1) selectedDays = selectedDays.filter(x => x !== d);
      } else selectedDays = [...selectedDays, d];
  }

  function editTemplate(idx, item) {
      editingTemplateIndex = idx;
      newTemplateTitle = item.title;
      newTemplateTime = item.time;
      newTemplateImportant = item.isImportant || false;
      selectedDays = item.days || [0, 1, 2, 3, 4, 5, 6];
  }

  async function deleteTemplate(idx) {
      if (!confirm("X√≥a m·∫´u n√†y?")) return;
      const up = { ...localTemplateData };
      if (!up[activeTemplateType]) return;
      up[activeTemplateType].splice(idx, 1);
      try {
          await setDoc(doc(db, 'settings', `template_${targetStore}`), up);
          if (editingTemplateIndex === idx) { editingTemplateIndex = -1; newTemplateTitle = ''; }
      } catch (e) { alert(e.message); }
  }

  async function saveTemplate() {
      if (!targetStore) return alert("Ch∆∞a ch·ªçn kho!");
      if (!newTemplateTitle.trim()) return alert("Nh·∫≠p t√™n c√¥ng vi·ªác!");
      
      const up = { ...localTemplateData };
      if (!up[activeTemplateType]) up[activeTemplateType] = [];
      
      const newItem = { 
          title: newTemplateTitle, 
          time: newTemplateTime, 
          isImportant: newTemplateImportant, 
          days: selectedDays 
      };

      if (editingTemplateIndex >= 0) up[activeTemplateType][editingTemplateIndex] = newItem;
      else up[activeTemplateType].push(newItem);

      up[activeTemplateType].sort((a, b) => (a.time || "00:00").localeCompare(b.time || "00:00"));

      try {
          await setDoc(doc(db, 'settings', `template_${targetStore}`), up);
          
          const today = new Date().getDay();
          if (selectedDays.includes(today)) {
              const creatorName = $currentUser?.name || $currentUser?.username || 'Qu·∫£n l√Ω';
              await addDoc(collection(db, 'tasks'), {
                  type: activeTemplateType,
                  title: newTemplateTitle,
                  timeSlot: newTemplateTime,
                  isImportant: newTemplateImportant,
                  completed: false, 
                  completedBy: null, 
                  time: null, 
                  note: '',
                  createdBy: creatorName,
                  date: getTodayStr(),
                  storeId: targetStore,
                  timestamp: serverTimestamp()
              });
          }

          newTemplateTitle = ''; 
          newTemplateImportant = false; 
          editingTemplateIndex = -1; 
          selectedDays = [0, 1, 2, 3, 4, 5, 6];
          
      } catch (e) { alert(e.message); }
  }
</script>

<div class="flex flex-col lg:flex-row gap-6 h-full animate-fadeIn">
  <div class="w-full lg:w-[35%] bg-white p-5 rounded-2xl shadow-sm border border-slate-200 h-fit">
      <div class="flex justify-between items-center mb-4 border-b pb-2">
          <h4 class="font-bold text-slate-700 flex items-center gap-2 text-lg">
              <span class="material-icons-round text-orange-500 bg-orange-50 p-1 rounded-lg">edit_note</span>
              {editingTemplateIndex >= 0 ? 'Ch·ªânh S·ª≠a' : 'Th√™m M·ªõi'}
          </h4>
          <button class="text-gray-400 hover:text-indigo-600" on:click={() => showTour = true} title="H∆∞·ªõng d·∫´n"><span class="material-icons-round">help_outline</span></button>
      </div>

      <div class="text-xs font-bold text-gray-400 mb-2">Kho: <b class="text-indigo-600 text-sm">{targetStore}</b> | Ng∆∞·ªùi t·∫°o: <b class="text-green-600">{$currentUser?.name}</b></div>
      
      <div class="space-y-4">
          <div id="dept-select-container">
              <label for="dept-select" class="text-xs font-bold text-slate-500 uppercase">B·ªô ph·∫≠n</label>
              <select id="dept-select" bind:value={activeTemplateType} class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg font-bold text-slate-700 outline-none">
                  <option value="warehouse">Kho</option>
                  <option value="cashier">Thu Ng√¢n</option>
                  <option value="handover">B√†n Giao</option>
              </select>
          </div>
          
          <div class="flex gap-3">
              <div class="w-24">
                  <label for="time-input" class="text-xs font-bold text-slate-500 uppercase">Gi·ªù</label>
                  <input id="time-input" type="time" bind:value={newTemplateTime} class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-center font-bold">
              </div>
              <div class="flex-1">
                  <label for="title-input" class="text-xs font-bold text-slate-500 uppercase">T√™n c√¥ng vi·ªác</label>
                  <input id="title-input" type="text" bind:value={newTemplateTitle} class="w-full mt-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none" placeholder="Nh·∫≠p t√™n vi·ªác...">
              </div>
          </div>

          <div id="weekdays-container">
              <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">L·∫∑p l·∫°i</label>
              <div class="flex gap-1 flex-wrap">
                  {#each weekDays as d}
                      <button class="w-8 h-8 rounded-lg text-xs font-bold border transition-all {selectedDays.includes(d.val)?'bg-indigo-600 text-white border-indigo-600 shadow-md':'bg-white text-slate-400 border-slate-200 hover:border-indigo-300'}" on:click={() => toggleDay(d.val)}>{d.label}</button>
                  {/each}
              </div>
          </div>

          <label class="flex items-center gap-3 p-3 rounded-lg border border-red-100 bg-red-50 cursor-pointer hover:bg-red-100 transition-colors mt-1">
              <input type="checkbox" bind:checked={newTemplateImportant} class="w-5 h-5 accent-red-600 rounded">
              <span class="text-sm font-bold text-red-700">Quan Tr·ªçng</span>
          </label>

          <div class="flex gap-2 pt-2 border-t">
              {#if editingTemplateIndex >= 0}
                  <button class="flex-1 py-2.5 bg-slate-100 text-slate-600 font-bold rounded-xl" on:click={() => { editingTemplateIndex = -1; newTemplateTitle = ''; }}>H·ªßy</button>
              {/if}
              <button id="btn-save-template" class="flex-[2] py-2.5 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700" on:click={saveTemplate}>
                  {editingTemplateIndex >= 0 ? 'L∆∞u & √Åp D·ª•ng Ngay' : 'Th√™m & √Åp D·ª•ng Ngay'}
              </button>
          </div>
      </div>
  </div>

  <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden h-full max-h-[600px]">
      <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex flex-col gap-2 shrink-0">
          <span class="font-bold text-slate-700">Danh s√°ch m·∫´u kho {targetStore} ({localTemplateData[activeTemplateType]?.length || 0})</span>
      </div>
      
      <div class="flex-1 overflow-y-auto p-3 space-y-2">
          {#each (localTemplateData[activeTemplateType] || []) as item, i}
              <div class="flex items-start gap-4 p-4 rounded-xl border border-slate-100 bg-white group relative">
                  <div class="font-mono font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg text-sm">{item.time}</div>
                  <div class="flex-1">
                      <div class="font-bold text-slate-800 text-base mb-1 {item.isImportant?'text-red-600':''}">{item.isImportant ? '‚òÖ ' : ''}{item.title}</div>
                      <div class="flex gap-1 flex-wrap">
                          {#each weekDays as d}
                              {#if item.days && item.days.includes(d.val)}
                                  <span class="text-[10px] font-bold border border-slate-200 text-slate-500 px-1.5 py-0.5 rounded">{d.label}</span>
                              {/if}
                          {/each}
                      </div>
                  </div>
                  <div class="flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity absolute right-2 top-2">
                      <button class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 flex items-center justify-center" on:click={() => editTemplate(i, item)}><span class="material-icons-round text-sm">edit</span></button>
                      <button class="w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 flex items-center justify-center" on:click={() => deleteTemplate(i)}><span class="material-icons-round text-sm">delete</span></button>
                  </div>
              </div>
          {/each}
      </div>
  </div>
</div>

{#if showTour} <TourGuide steps={tourSteps} on:complete={() => showTour = false} /> {/if}
--- END FILE: ./src/components/admin/AdminTemplate.svelte ---

--- START FILE: ./src/components/admin/schedule/ScheduleMatrix.svelte ---

<script>
  // Version 55.0 - Remove Debugger & Resize Edit Icon
  import { createEventDispatcher, tick } from 'svelte';
  export let staffStats = {};
  export let shiftMatrix = {};
  export let weekendMatrix = {};
  export let activeMatrixMode = 'weekday';
  export let shiftCols = [];
  export let roleRows = [];
  export let comboCols = []; 
  export let activeSuggestedCombos = [];
  export let comboTotalsMap = {};
  export let scheduleMonth;
  export let scheduleYear;
  export let genderConfig = { kho: 'none', tn: 'none' };

  const dispatch = createEventDispatcher();
  let showConfigDropdown = false;
  let configDropdownNode;
  
  const getRoleTotal = (roleId, matrix) => Object.values(matrix).reduce((sum, s) => sum + (parseInt(s[roleId])||0), 0);
  const getShiftTotal = (shiftId, matrix) => { const s = matrix[shiftId] || {};
  return (parseInt(s.kho)||0) + (parseInt(s.tn)||0) + (parseInt(s.tv)||0) + (parseInt(s.gh)||0); };
  const getGrandTotal = (matrix) => Object.values(matrix).reduce((sum, s) => sum + (parseInt(s.kho)||0) + (parseInt(s.tn)||0) + (parseInt(s.tv)||0) + (parseInt(s.gh)||0), 0);
  
  function standardizeRole(val) {
      const s = String(val || '').toLowerCase().trim();
      if (s === 'kho' || s === 'k') return 'kho';
      if (s.includes('thu ng√¢n') || s.includes('tn')) return 'tn';
      if (s.includes('giao') || s.includes('gh')) return 'gh';
      if (s.includes('t∆∞ v·∫•n') || s === 'tv') return 'tv';
      return 'tv';
  }

  let displayGrid = {};
  $: {
      const grid = {};
      roleRows.forEach(r => {
          grid[r.id] = {};
          comboCols.forEach(code => {
              grid[r.id][code] = 0;
          });
      });
      if (Array.isArray(activeSuggestedCombos)) {
          activeSuggestedCombos.forEach(c => {
              const rId = standardizeRole(c.role);
              const code = String(c.code).trim();
              const qty = parseInt(c.qty) || 0;

              if (grid[rId] && grid[rId][code] !== undefined) {
                  grid[rId][code] = qty;
              }
          });
      }
      displayGrid = grid;
  }

  function handleWindowClick(e) {
      if (showConfigDropdown && configDropdownNode && !configDropdownNode.contains(e.target)) {
          showConfigDropdown = false;
      }
  }

  // --- LOGIC: KI·ªÇM TRA TR√ôNG L·∫∂P ---
  let tempColValue = '';

  function handleColFocus(e) {
      tempColValue = e.target.value;
  }

  function handleColInput(e, index) {
      let val = e.target.value;
      val = val.replace(/[^0-9]/g, '');
      e.target.value = val;
      const newCols = [...comboCols];
      newCols[index] = val;
      dispatch('updateCols', newCols);
  }

  function handleColChange(e, index) {
      const val = e.target.value;
      if (!val) return; 

      const isDuplicate = comboCols.some((code, idx) => code === val && idx !== index);

      if (isDuplicate) {
          alert(`‚ö†Ô∏è M√£ c·ªôt "${val}" ƒë√£ t·ªìn t·∫°i! Vui l√≤ng ch·ªçn m√£ kh√°c.`);
          e.target.value = tempColValue;
          const newCols = [...comboCols];
          newCols[index] = tempColValue;
          dispatch('updateCols', newCols);
      }
  }

  function handleQtyFocus(e) {
      e.target.select();
  }
  
  function formatQtyDisplay(val) {
      return (val === 0 || val === '0') ? '-' : val;
  }
</script>

<svelte:window on:click={handleWindowClick} />

<div class="grid grid-cols-1 xl:grid-cols-2 gap-6 shrink-0 h-auto">
  
  <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden h-full">
      <div class="p-4 border-b border-slate-100 bg-slate-50/50 shrink-0">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
              <div class="flex flex-col items-start gap-1">
                  <h3 class="font-bold text-slate-800 text-lg leading-tight">ƒê·ªãnh M·ª©c Nh√¢n S·ª±</h3>
                  {#if staffStats.total > 0}
                      <div class="flex items-center gap-2 text-[10px] font-bold text-slate-500 opacity-80 select-none">
                          <div class="flex items-center gap-1"><span class="material-icons-round text-[10px]">groups</span> <span>{staffStats.total}</span></div>
                          <div class="w-px h-2 bg-slate-300"></div>
                          <div class="flex items-center gap-1 text-blue-600"><span class="material-icons-round text-[10px]">male</span> <span>{staffStats.male}</span></div>
                          <div class="w-px h-2 bg-slate-300"></div>
                          <div class="flex items-center gap-1 text-pink-600"><span class="material-icons-round text-[10px]">female</span> <span>{staffStats.female}</span></div>
                      </div>
                  {/if}
              </div>

              <div class="flex items-center gap-2">
                  <div class="bg-slate-200 p-1 rounded-lg flex">
                      <button class="px-3 py-1.5 rounded-md text-xs font-bold transition-all {activeMatrixMode==='weekday'?'bg-white text-indigo-600 shadow-sm':'text-slate-500 hover:text-slate-700'}" on:click={() => dispatch('modeChange', 'weekday')}>
                          Th·ª© 2 - 6
                      </button>
                      <button class="px-3 py-1.5 rounded-md text-xs font-bold transition-all {activeMatrixMode==='weekend'?'bg-orange-100 text-orange-600 shadow-sm':'text-slate-500 hover:text-slate-700'}" on:click={() => dispatch('modeChange', 'weekend')}>
                          T7 & CN üî•
                      </button>
                  </div>
                  <div class="flex items-center bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                      <button class="w-7 h-7 flex items-center justify-center hover:bg-slate-100 rounded text-slate-500" on:click={() => dispatch('monthChange', -1)}>
                          <span class="material-icons-round text-sm">chevron_left</span>
                      </button>
                      <span class="font-bold text-slate-800 text-sm px-2 min-w-[70px] text-center">
                          T{scheduleMonth}/{scheduleYear}
                      </span>
                      <button class="w-7 h-7 flex items-center justify-center hover:bg-slate-100 rounded text-slate-500" on:click={() => dispatch('monthChange', 1)}>
                          <span class="material-icons-round text-sm">chevron_right</span>
                      </button>
                  </div>
              </div>
          </div>
      </div>
      
      <div class="flex-1 overflow-auto p-4 relative h-[500px] {activeMatrixMode==='weekend'?'bg-orange-50/30':''}">
           <table class="w-full text-sm border-separate border-spacing-0 rounded-xl border border-slate-200">
              <thead id="table-left-head" class="bg-slate-50 text-slate-500 sticky top-0 z-10">
                  <tr>
                    <th class="p-3 text-left font-bold border-b border-r border-slate-200 bg-slate-50 h-12 box-border min-w-[100px] whitespace-nowrap">B·ªô Ph·∫≠n</th>
                    {#each shiftCols as col}
                        <th class="p-2 text-center border-b border-slate-200 border-l border-white min-w-[60px] bg-slate-50 h-12 box-border">
                            <div class="flex items-center justify-center h-8 font-black text-slate-700">{col.id.toUpperCase()}</div>
                        </th>
                    {/each}
                    <th class="p-3 text-center font-bold bg-slate-100 border-b border-l border-slate-200 text-slate-700 sticky right-0 h-12 box-border whitespace-nowrap">T·ªïng</th>
                  </tr>
              </thead>
              <tbody id="table-left-body">
                  {#each roleRows as role}
                      <tr class="group hover:bg-slate-50/50 transition-colors">
                          <td class="p-3 font-bold border-r border-slate-100 {role.color} border-l-4 h-12 box-border whitespace-nowrap">{role.label}</td>
                          {#each shiftCols as shift}
                              <td class="p-1 border-r border-slate-100 text-center h-12 box-border">
                                  {#if activeMatrixMode === 'weekday'}
                                      <input type="number" min="0" bind:value={shiftMatrix[shift.id][role.id]} class="w-full h-8 text-center font-bold outline-none rounded focus:bg-indigo-50 hover:bg-white text-slate-700 bg-transparent transition-all border border-transparent focus:border-indigo-200">
                                   {:else}
                                      <input type="number" min="0" bind:value={weekendMatrix[shift.id][role.id]} class="w-full h-8 text-center font-bold outline-none rounded focus:bg-orange-100 hover:bg-white text-orange-800 bg-transparent transition-all border border-transparent focus:border-orange-200">
                                  {/if}
                              </td>
                          {/each}
                          <td class="p-3 text-center font-black text-slate-700 bg-slate-50 border-l border-slate-100 sticky right-0 h-12 box-border">{getRoleTotal(role.id, activeMatrixMode==='weekday'?shiftMatrix:weekendMatrix)}</td>
                      </tr>
                  {/each}
              </tbody>
              <tfoot class="bg-slate-800 text-slate-300 font-bold sticky bottom-0 z-10 shadow-lg">
                  <tr>
                      <td class="p-3 text-right text-xs uppercase tracking-wider bg-slate-800 h-12 box-border whitespace-nowrap">T·ªïng</td>
                      {#each shiftCols as shift}
                          <td class="p-3 text-center text-yellow-400 font-mono text-sm font-bold bg-slate-800 h-12 box-border">{getShiftTotal(shift.id, activeMatrixMode==='weekday'?shiftMatrix:weekendMatrix)}</td>
                      {/each}
                      <td class="p-3 text-center text-white text-sm font-bold bg-slate-900 sticky right-0 h-12 box-border">{getGrandTotal(activeMatrixMode==='weekday'?shiftMatrix:weekendMatrix)}</td>
                  </tr>
              </tfoot>
          </table>
      </div>
      <div class="p-4 border-t bg-white shrink-0">
          <button id="btn-calculate" class="w-full h-12 bg-green-600 text-white font-bold rounded-xl shadow hover:bg-green-700 flex justify-center items-center gap-2 transition-transform active:scale-[0.98]" on:click={() => dispatch('calculate')}>
              <span class="material-icons-round">calculate</span> T√çNH TO√ÅN & QUY ƒê·ªîI
          </button>
      </div>
  </div>

  <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-full relative">
      <div class="p-4 border-b border-slate-100 bg-slate-50/50 shrink-0 flex items-center"> 
           <div class="flex justify-between items-center w-full">
               <div class="flex flex-col justify-center">
                   <h3 class="font-bold text-slate-800 text-lg">Combo G·ª£i √ù</h3>
                   <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wide mt-0.5">T√πy ch·ªânh c·ªôt & s·ªë l∆∞·ª£ng</span>
               </div>
               
               <div class="flex items-center gap-2">
                   <button class="flex items-center gap-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-xs font-bold border border-indigo-100 transition-colors" on:click={() => dispatch('addCol')}>
                      <span class="material-icons-round text-sm">add</span> Th√™m C·ªôt
                  </button>
               </div>
           </div>
      </div>
       
      <div class="flex-1 overflow-auto p-4 relative h-[500px] {activeMatrixMode==='weekend'?'bg-orange-50/30':''}">
           <table class="w-full text-sm border-separate border-spacing-0 rounded-xl border border-slate-200">
               <thead id="table-right-head" class="bg-slate-50 text-slate-500 sticky top-0 z-10">
                   <tr>
                       <th class="p-3 text-left font-bold border-b border-r border-slate-200 bg-slate-50 min-w-[100px] h-12 box-border whitespace-nowrap">B·ªô Ph·∫≠n</th>
                       {#each comboCols as code, i}
                           <th class="p-2 text-center border-b border-slate-200 border-l border-white min-w-[70px] bg-slate-50 group relative h-12 box-border">
                               <div class="flex items-center justify-center relative h-8">
                                   <input 
                                       type="text" 
                                       value={code} 
                                       on:focus={handleColFocus} 
                                       on:input={(e) => handleColInput(e, i)}
                                       on:change={(e) => handleColChange(e, i)}
                                       class="w-full h-full bg-transparent text-center font-black text-slate-700 outline-none border-b border-transparent focus:border-indigo-500 focus:bg-white text-xs py-1"
                                       placeholder="..."
                                   />
                                   <span class="material-icons-round text-[8px] text-slate-300 absolute right-0 pointer-events-none opacity-50">edit</span>
                               </div>
                           </th>
                       {/each}
                   </tr>
               </thead>
              <tbody id="table-right-body">
                  {#each roleRows as role}
                      <tr class="group hover:bg-slate-50/50 transition-colors">
                          <td class="p-3 font-bold border-r border-slate-100 {role.color} border-l-4 h-12 box-border whitespace-nowrap">{role.label}</td>
                          {#each comboCols as code}
                              <td class="p-1 border-r border-slate-100 text-center h-12 box-border">
                                  <input 
                                      type="text" 
                                      inputmode="numeric"
                                      value={formatQtyDisplay(displayGrid[role.id] ? displayGrid[role.id][code] : 0)}
                                      on:focus={handleQtyFocus}
                                      on:change={(e) => dispatch('updateCombo', { role: role.label, code, qty: e.target.value === '-' ? 0 : e.target.value })} 
                                      class="w-full h-8 text-center font-bold outline-none rounded focus:bg-indigo-50 hover:bg-white text-indigo-600 bg-transparent transition-all border border-transparent focus:border-indigo-200"
                                  >
                              </td>
                          {/each}
                      </tr>
                  {/each}
              </tbody>
              
              <tfoot class="bg-slate-800 text-slate-300 font-bold sticky bottom-0 z-10 shadow-lg">
                  <tr>
                      <td class="p-3 text-right text-xs uppercase tracking-wider bg-slate-800 h-12 box-border whitespace-nowrap">T·ªïng</td>
                      {#each comboCols as code}
                          <td class="p-3 text-center text-white text-sm font-bold bg-slate-900 border-l border-slate-700 h-12 box-border">{comboTotalsMap[code] || 0}</td>
                      {/each}
                  </tr>
              </tfoot>
          </table>
      </div>

      <div class="p-4 bg-white border-t border-slate-100 flex gap-2 shrink-0 relative items-center">
            <div class="relative" bind:this={configDropdownNode}>
              <button class="h-12 px-4 flex items-center justify-center bg-slate-100 text-slate-600 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition-colors border border-slate-200 gap-2 font-bold text-xs" on:click={()=>showConfigDropdown=!showConfigDropdown}>
                  <span class="material-icons-round">wc</span> <span>Gi·ªõi t√≠nh</span>
              </button>
              {#if showConfigDropdown}
                  <div class="absolute bottom-full left-0 mb-3 w-72 bg-white rounded-xl shadow-2xl border border-slate-200 p-4 z-50 animate-fadeIn arrow-bottom">
                      <h4 class="text-xs font-bold text-slate-800 mb-3 border-b pb-2">T√ôY CH·ªåN GI·ªöI T√çNH</h4>
                      <div class="space-y-4">
                          <div>
                              <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Y√™u c·∫ßu Kho</label>
                              <div class="flex bg-slate-50 rounded-lg border border-slate-200 p-1">
                                  {#each ['none', 'male_only', 'mixed'] as opt}
                                      <button class="flex-1 py-1.5 text-[10px] font-bold rounded capitalize {genderConfig.kho===opt?'bg-white shadow text-indigo-700':'text-slate-400 hover:text-slate-600'}" on:click={()=>dispatch('configChange', {type:'kho', val: opt})}>
                                          {opt==='none'?'Tho·∫£i m√°i':(opt==='male_only'?'Ch·ªâ Nam':'C·∫∑p ƒê√¥i')}
                                      </button>
                                  {/each}
                              </div>
                          </div>
                          <div>
                              <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Y√™u c·∫ßu Thu Ng√¢n</label>
                              <div class="flex bg-slate-50 rounded-lg border border-slate-200 p-1">
                                  {#each ['none', 'female_only', 'mixed'] as opt}
                                      <button class="flex-1 py-1.5 text-[10px] font-bold rounded capitalize {genderConfig.tn===opt?'bg-white shadow text-purple-700':'text-slate-400 hover:text-slate-600'}" on:click={()=>dispatch('configChange', {type:'tn', val: opt})}>
                                          {opt==='none'?'Tho·∫£i m√°i':(opt==='female_only'?'Ch·ªâ N·ªØ':'C·∫∑p ƒê√¥i')}
                                      </button>
                                  {/each}
                              </div>
                          </div>
                      </div>
                  </div>
              {/if}
           </div>

           <button id="btn-preview-schedule" class="flex-1 h-12 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:-translate-y-0.5 transition-all flex justify-center items-center gap-2 active:scale-[0.98]" on:click={() => dispatch('preview')}>
               <span class="material-icons-round">calendar_view_month</span><span>XEM TR∆Ø·ªöC L·ªäCH</span>
           </button>
      </div>
  </div>
</div>
--- END FILE: ./src/components/admin/schedule/ScheduleMatrix.svelte ---

--- START FILE: ./src/components/admin/schedule/SchedulePreview.svelte ---
<script>
  // Version 55.0 - Add Cumulative History Modal
  import { createEventDispatcher } from 'svelte';
  import { utils, writeFile } from 'xlsx';
  import CumulativeHistoryModal from '../../CumulativeHistoryModal.svelte'; // [GEM IMPORT]

  export let previewScheduleData = null;
  export let previewStats = [];
  export let optimizationLogs = [];
  export let inspectionMode = 'none';
  export let INSPECTION_OPTIONS = [];
  export let checkInspectionError = (d, assign, mode) => false;
  export let getWeekendFairnessStatus = (staffId) => 0;
  export let getWeekendHardRoleCount = (staffId) => 0;
  export let getWeekday = (day) => '';
  export let getShiftColor = (code) => '';
  export let getRoleBadge = (role) => null;
  export let isCellRelevant = (d, assign, mode) => true;

  // C·∫ßn truy·ªÅn th√™m storeId, month, year t·ª´ cha ƒë·ªÉ Modal ho·∫°t ƒë·ªông
  export let storeId = ''; 
  export let viewMonth;
  export let viewYear;

  const dispatch = createEventDispatcher();
  
  let showBalanceModal = false;
  let showHistoryModal = false; // [GEM STATE]
  let balanceConfig = { direction: 'male_to_female', role: 'tn', qty: 1 };

  function onInspectionChange(e) { dispatch('inspectionChange', e.target.value); }
  function handleBalance() { showBalanceModal = false; dispatch('balanceGender', balanceConfig); }

  function exportPreviewToExcel() {
      if (!previewScheduleData) return;
      const wb = utils.book_new();
      const days = Object.keys(previewScheduleData).sort((a,b)=>Number(a)-Number(b));
      const wsData = [];
      const row1 = ["NH√ÇN S·ª∞"];
      days.forEach(d => row1.push(d));
      row1.push("T·ªïng Gi·ªù", "GH", "TN", "K", "Ca cu·ªëi tu·∫ßn");
      wsData.push(row1);
      const row2 = [""];
      days.forEach(d => row2.push(getWeekday(d)));
      row2.push("", "", "", "", "");
      wsData.push(row2);
      previewStats.forEach(staff => {
          const row = [staff.name];
          days.forEach(d => {
              const assign = previewScheduleData[d].find(x => x.staffId === staff.id);
              if (assign) {
                  let cell = assign.shift;
                  if (assign.role && assign.role !== 'TV') cell += ` (${assign.role})`;
                  row.push(cell);
              } else { row.push(""); }
          });
          row.push(Math.round(staff.totalHours || 0), staff.gh || 0, staff.tn || 0, staff.kho || 0, getWeekendHardRoleCount(staff.id));
          wsData.push(row);
      });
      const ws = utils.aoa_to_sheet(wsData);
      utils.book_append_sheet(wb, ws, `Preview_Lich`);
      writeFile(wb, `Xem_Truoc_Lich_Lam_Viec.xlsx`);
  }
</script>

<div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden animate-fadeIn scroll-mt-20 min-h-[500px]">
  <div class="p-4 border-b border-slate-100 flex flex-wrap justify-between items-center bg-slate-50/50 gap-4 relative">
      <div class="flex items-center gap-4">
           <div><h3 class="font-bold text-slate-800 text-lg">Xem Tr∆∞·ªõc & T·ªëi ∆Øu L·ªãch</h3><p class="text-xs text-slate-400">Ki·ªÉm tra k·ªπ tr∆∞·ªõc khi √Åp d·ª•ng</p></div>
          
          <div class="relative group">
              <label for="inspection-select" class="sr-only">Ch·∫ø ƒë·ªô soi l·ªói</label>
              <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm cursor-pointer hover:bg-slate-50 transition-colors select-none">
                  <span class="material-icons-round text-sm {inspectionMode!=='none' ? 'animate-pulse' : 'text-slate-400'} {INSPECTION_OPTIONS.find(o=>o.val===inspectionMode)?.color}">
                      {INSPECTION_OPTIONS.find(o=>o.val===inspectionMode)?.icon}
                  </span>
                  <select id="inspection-select" value={inspectionMode} on:change={onInspectionChange} class="bg-transparent font-bold text-xs text-slate-700 outline-none cursor-pointer appearance-none pr-4">
                      {#each INSPECTION_OPTIONS as opt}
                          <option value={opt.val}>{opt.label}</option>
                      {/each}
                  </select>
                  <span class="material-icons-round text-xs text-slate-400 absolute right-2 pointer-events-none">expand_more</span>
              </div>
          </div>

          {#if inspectionMode === 'rotation'} <button class="px-3 py-1.5 bg-orange-100 text-orange-700 font-bold rounded-lg hover:bg-orange-200 text-xs flex items-center gap-1 animate-pulse" on:click={() => dispatch('fixRotation')}><span class="material-icons-round text-sm">build</span> S·ª≠a Nh·ªãp</button> {/if}
          {#if inspectionMode === 'weekend'} <button class="px-3 py-1.5 bg-indigo-100 text-indigo-700 font-bold rounded-lg hover:bg-indigo-200 text-xs flex items-center gap-1 animate-pulse" on:click={() => dispatch('fixWeekend')}><span class="material-icons-round text-sm">balance</span> C√¢n B·∫±ng CT</button> {/if}
          {#if inspectionMode === 'gender'} <button class="px-3 py-1.5 bg-pink-100 text-pink-700 font-bold rounded-lg hover:bg-pink-200 text-xs flex items-center gap-1 animate-pulse" on:click={() => dispatch('fixGender')}><span class="material-icons-round text-sm">wc</span> Fix Gi·ªõi T√≠nh</button> {/if}
      </div>

      <div class="flex gap-2">
          <button class="px-4 py-2 bg-indigo-50 text-indigo-700 font-bold rounded-lg shadow hover:bg-indigo-100 flex items-center gap-2 border border-indigo-100" on:click={() => showHistoryModal = true}>
             <span class="material-icons-round text-sm">history</span> L≈©y K·∫ø
          </button>

          <button id="btn-optimize" disabled={!previewScheduleData} class="px-4 py-2 bg-yellow-500 text-white font-bold rounded-lg shadow hover:bg-yellow-600 flex items-center gap-2 disabled:opacity-50" on:click={() => dispatch('optimize')}>
              <span class="material-icons-round text-sm">auto_fix_high</span> T·ªëi ∆Øu
          </button>

          <button class="px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow hover:bg-purple-700 flex items-center gap-2" on:click={() => showBalanceModal = true}>
              <span class="material-icons-round text-sm">swap_horiz</span> C√¢n B·∫±ng Ca
          </button>

          <button id="btn-reset" disabled={!previewScheduleData} class="px-4 py-2 bg-gray-500 text-white font-bold rounded-lg shadow hover:bg-gray-600 flex items-center gap-2 disabled:opacity-50" on:click={() => dispatch('reset')}><span class="material-icons-round text-sm">restart_alt</span> Reset</button>
          
          <button disabled={!previewScheduleData} class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 flex items-center gap-2 disabled:opacity-50" on:click={exportPreviewToExcel}>
              <span class="material-icons-round text-sm">download</span> Excel
          </button>

          <button id="btn-apply" disabled={!previewScheduleData} class="px-6 py-2 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 flex items-center gap-2 disabled:opacity-50" on:click={() => dispatch('apply')}><span class="material-icons-round text-sm">check_circle</span> √ÅP D·ª§NG</button>
      </div>
  </div>

  {#if !previewScheduleData}
      <div class="p-10 text-center text-gray-400 flex flex-col items-center">
          <span class="material-icons-round text-4xl mb-2 opacity-30">visibility_off</span>
          <p class="text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu xem tr∆∞·ªõc.</p>
      </div>
  {:else}
      {#if optimizationLogs.length > 0} <div class="bg-yellow-50 p-3 text-xs text-yellow-800 border-b border-yellow-100 max-h-32 overflow-y-auto"> <div class="font-bold mb-1">Nh·∫≠t k√Ω thay ƒë·ªïi:</div> {#each optimizationLogs as log}<div>‚Ä¢ {log}</div>{/each} </div> {/if}
      <div class="flex-1 overflow-x-auto p-4 max-h-[600px] relative scroll-smooth"> 
          <table class="w-full text-xs text-center border-collapse min-w-[1500px]"> 
              <thead class="bg-amber-400 text-slate-900 sticky top-0 z-[60] shadow-md"> 
                  <tr> 
                      <th rowspan="2" class="p-2 sticky left-0 bg-white border-r border-amber-200 z-[70] min-w-[140px] text-left pl-3 shadow">NH√ÇN S·ª∞</th> 
                      {#each Object.keys(previewScheduleData).sort((a,b)=>Number(a)-Number(b)) as d} 
                          <th class="p-1 border-l border-amber-500/30 min-w-[40px] text-xs font-black cursor-pointer hover:bg-amber-500 transition-colors select-none bg-amber-400 {['T7','CN'].includes(getWeekday(d))?'bg-amber-300':''} relative group" on:click={()=>dispatch('headerClick', d)}>
                              {d}
                              {#if inspectionMode !== 'none'}
                                  {@const hasError = previewScheduleData[d].some(assign => checkInspectionError(d, assign, inspectionMode))}
                                  {#if hasError}
                                      <span class="absolute top-0 right-0 w-2 h-2 bg-red-600 rounded-full animate-ping"></span>
                                      <span class="absolute top-0 right-0 w-2 h-2 bg-red-600 rounded-full"></span>
                                  {/if}
                              {/if}
                              <div class="absolute bottom-full mb-1 hidden group-hover:flex bg-black text-white text-[9px] p-1 rounded whitespace-nowrap z-50 left-1/2 -translate-x-1/2">
                                  {inspectionMode!=='none'?'Xem l·ªói':'Chi ti·∫øt'}
                              </div>
                          </th> 
                      {/each} 
                      <th rowspan="2" class="p-2 w-12 bg-white border-l border-amber-300 z-[70] font-bold text-[10px] text-slate-600">GI·ªú</th>
                      <th rowspan="2" class="p-2 w-10 bg-blue-100 text-[10px] border-l border-amber-300 font-bold text-blue-800">GH</th> 
                      <th rowspan="2" class="p-2 w-10 bg-purple-100 text-[10px] border-l border-amber-300 font-bold text-purple-800">TN</th> 
                      <th rowspan="2" class="p-2 w-10 bg-orange-100 text-[10px] border-l border-amber-300 font-bold text-orange-800">K</th> 
                      <th rowspan="2" class="p-2 w-14 bg-indigo-100 text-[10px] border-l border-amber-300 font-bold text-indigo-800" title="S·ªë ca nghi·ªáp v·ª• T7/CN">Ca<br>cu·ªëi tu·∫ßn</th>
                  </tr> 
                  <tr>
                      {#each Object.keys(previewScheduleData).sort((a,b)=>Number(a)-Number(b)) as d}
                          <th class="p-0.5 border-l border-amber-500/30 text-[9px] bg-amber-200 {['T7','CN'].includes(getWeekday(d))?'bg-amber-300/80 text-amber-900':'text-slate-700'}">{getWeekday(d)}</th>
                      {/each}
                  </tr>
              </thead> 
              <tbody class="divide-y text-xs"> 
                  {#each previewStats as staff} 
                      {@const weekendStatus = getWeekendFairnessStatus(staff.id)}
                      {@const weCount = getWeekendHardRoleCount(staff.id)}
                      <tr class="transition-colors"> 
                          <td class="p-2 border font-bold text-left sticky left-0 z-[50] shadow-r cursor-pointer hover:text-indigo-600 transition-all {staff.gender==='Nam'?'text-blue-700':'text-pink-600'} {weekendStatus !== 0 && inspectionMode==='weekend' ? (weekendStatus===1?'bg-red-100 ring-inset ring-2 ring-red-400 z-[60]':'bg-green-100 ring-inset ring-2 ring-green-400 z-[60]') : 'bg-white'}" on:click={() => dispatch('staffClick', {id: staff.id, name: staff.name})}>
                              {staff.name}
                              {#if weekendStatus === 1}<span class="block text-[8px] text-red-500 font-normal animate-pulse">Qu√° t·∫£i cu·ªëi tu·∫ßn</span>{/if}
                              {#if weekendStatus === -1}<span class="block text-[8px] text-green-600 font-normal animate-pulse">Thi·∫øu ca cu·ªëi tu·∫ßn</span>{/if}
                          </td> 
                          {#each Object.keys(previewScheduleData).sort((a,b)=>Number(a)-Number(b)) as d} 
                              {@const assign = previewScheduleData[d].find(x => x.staffId === staff.id)} 
                              {@const errorMsg = checkInspectionError(d, assign, inspectionMode)}
                              {@const isError = !!errorMsg}
                              {@const relevant = isCellRelevant(d, assign, inspectionMode)}

                              <td class="p-0.5 border-l border-gray-100 h-10 align-middle transition-all duration-300 {assign?.isChanged ? 'bg-yellow-100' : ''} {['T7','CN'].includes(getWeekday(d))?'bg-amber-50/50':''} cursor-pointer {isError ? 'opacity-100 bg-white ring-4 ring-red-500 z-[60] scale-110 shadow-lg font-black' : (inspectionMode !== 'none' && !relevant ? 'opacity-25 grayscale blur-[0.5px]' : 'opacity-100 hover:bg-gray-100')}" on:click={()=>dispatch('cellClick', {day: d, staffId: staff.id, assign})} title={isError ? errorMsg : ''}> 
                                  {#if assign && assign.shift !== 'OFF'} 
                                      {@const badge = getRoleBadge(assign.role)}
                                      <div class="w-full h-full rounded py-1 font-bold text-[10px] flex flex-col items-center justify-center shadow-sm {getShiftColor(assign.shift)}">
                                          <span>{assign.shift}</span>
                                          {#if badge}<span class="text-[8px] leading-none px-1 py-0.5 rounded mt-0.5 {badge.class}">{badge.text}</span>{/if}
                                      </div> 
                                  {/if} 
                              </td> 
                          {/each} 
                          <td class="p-2 border font-bold text-center bg-white text-slate-700 border-l {inspectionMode!=='none'?'opacity-100':''}">{Math.round(staff.totalHours)||0}</td>
                          <td class="p-2 border font-bold text-center bg-blue-50 text-blue-600 {inspectionMode!=='none'?'opacity-100':''}">{staff.gh||'-'}</td> 
                          <td class="p-2 border font-bold text-center bg-purple-50 text-purple-600 {inspectionMode!=='none'?'opacity-100':''}">{staff.tn||0}</td> 
                          <td class="p-2 border font-bold text-center bg-orange-50 text-orange-600 {inspectionMode!=='none'?'opacity-100':''}">{staff.kho||0}</td> 
                          <td class="p-2 border font-bold text-center border-l {inspectionMode==='weekend' ? 'opacity-100' : 'opacity-100'} {weekendStatus===1?'text-red-600 bg-red-50':(weekendStatus===-1?'text-green-600 bg-green-50':'text-slate-600')}">
                              {weCount}
                          </td>
                      </tr> 
                  {/each} 
              </tbody> 
          </table> 
      </div>
  {/if}
</div>

{#if showHistoryModal}
    <CumulativeHistoryModal 
        {storeId}
        currentMonth={viewMonth}
        currentYear={viewYear}
        currentStats={previewStats}
        on:close={() => showHistoryModal = false}
    />
{/if}

{#if showBalanceModal}
    <div class="fixed inset-0 z-[100] bg-slate-900/60 flex items-center justify-center p-4 backdrop-blur-sm" on:click={() => showBalanceModal = false}>
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl animate-popIn" on:click|stopPropagation>
            <h3 class="text-base font-bold text-slate-800 mb-4 border-b pb-2 flex items-center gap-2">
                <span class="material-icons-round text-purple-600">swap_horiz</span> C√¢n B·∫±ng Ca Th·ªß C√¥ng
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[11px] font-bold text-slate-400 block mb-1 uppercase">H∆∞·ªõng ƒê·ªïi</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" bind:group={balanceConfig.direction} value="male_to_female" class="peer sr-only">
                            <div class="p-3 border rounded-lg text-center text-xs font-bold peer-checked:bg-blue-50 peer-checked:text-blue-700 peer-checked:border-blue-300 transition-all hover:bg-slate-50">
                                <span class="block text-lg mb-1">üë® ‚ûî üë©</span>
                                Nam sang N·ªØ
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" bind:group={balanceConfig.direction} value="female_to_male" class="peer sr-only">
                             <div class="p-3 border rounded-lg text-center text-xs font-bold peer-checked:bg-pink-50 peer-checked:text-pink-700 peer-checked:border-pink-300 transition-all hover:bg-slate-50">
                                <span class="block text-lg mb-1">üë© ‚ûî üë®</span>
                                N·ªØ sang Nam
                            </div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="text-[11px] font-bold text-slate-400 block mb-1 uppercase">B·ªô Ph·∫≠n</label>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" bind:group={balanceConfig.role} value="tn" class="peer sr-only">
                            <div class="p-2 border rounded-lg text-center text-xs font-bold peer-checked:bg-purple-100 peer-checked:text-purple-700 peer-checked:border-purple-300 transition-all">Thu Ng√¢n</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" bind:group={balanceConfig.role} value="kho" class="peer sr-only">
                            <div class="p-2 border rounded-lg text-center text-xs font-bold peer-checked:bg-orange-100 peer-checked:text-orange-700 peer-checked:border-orange-300 transition-all">Kho</div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="text-[11px] font-bold text-slate-400 block mb-1 uppercase">S·ªë l∆∞·ª£ng (Ca/Ng∆∞·ªùi)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 material-icons-round text-slate-400 text-sm">layers</span>
                        <input type="number" min="1" max="10" bind:value={balanceConfig.qty} class="w-full pl-9 p-2.5 border rounded-lg text-sm font-bold outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-200">
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button class="flex-1 py-3 bg-slate-100 rounded-xl text-slate-600 font-bold text-sm hover:bg-slate-200 transition-colors" on:click={() => showBalanceModal = false}>H·ªßy</button>
                    <button class="flex-1 py-3 bg-purple-600 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-purple-700 hover:-translate-y-0.5 transition-all" on:click={handleBalance}>
                        Th·ª±c Hi·ªán
                    </button>
                </div>
            </div>
        </div>
    </div>
{/if}
--- END FILE: ./src/components/admin/schedule/SchedulePreview.svelte ---

--- START FILE: ./src/lib/Counter.svelte ---
<script>
  let count = $state(0)
  const increment = () => {
    count += 1
  }
</script>

<button onclick={increment}>
  count is {count}
</button>

--- END FILE: ./src/lib/Counter.svelte ---

--- START FILE: ./src/lib/firebase.js ---
// src/lib/firebase.js
import { initializeApp, getApps, getApp } from "firebase/app";
import { getFirestore } from "firebase/firestore";

const firebaseConfig = {
  apiKey: "AIzaSyDqNsRClI9_ygv-FLn1MeFWxa8DTscu8lI",
  authDomain: "taskflow-company-41ab3.firebaseapp.com",
  projectId: "taskflow-company-41ab3",
  storageBucket: "taskflow-company-41ab3.firebasestorage.app",
  messagingSenderId: "360187172258",
  appId: "1:360187172258:web:2a304a34c222c202d64efb"
};

// Kh·ªüi t·∫°o Firebase (Singleton Pattern ƒë·ªÉ tr√°nh l·ªói kh·ªüi t·∫°o nhi·ªÅu l·∫ßn)
const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
const db = getFirestore(app);

export { db };
--- END FILE: ./src/lib/firebase.js ---

--- START FILE: ./src/lib/optimization.js ---
// src/lib/optimization.js
// Version 37.0 - FIX: Manual Balance respects Weekend Load

const SHIFT_GROUPS = {
    '123': 'SANG', '23': 'SANG', '12-56': 'SANG', '123-56': 'SANG', '12345': 'SANG',
    '456': 'CHIEU', '45': 'CHIEU', '23456': 'CHIEU',
    '2-5': 'GAY', '2345': 'FULL', 'OFF': 'OFF'
};

function getGroup(code) { return SHIFT_GROUPS[code] || 'OFF'; }

function isHardRole(r) { return ['Kho', 'Thu Ng√¢n', 'Giao H√†ng', 'GH', 'TN', 'K'].includes(r); }

function isWeekend(d, month, year) { 
    const date = new Date(year, month - 1, d);
    const day = date.getDay();
    return day === 0 || day === 6;
}

function hasRotationConflict(shift1, shift2) {
    const g1 = getGroup(shift1);
    const g2 = getGroup(shift2);
    if (g1 !== 'OFF' && g1 !== 'GAY' && g1 !== 'FULL' && g1 === g2) return true;
    return false;
}

// 1. AUTO FIX ROTATION
export function autoFixRotation(scheduleData, month, year) {
    let schedule = JSON.parse(JSON.stringify(scheduleData));
    let logs = [];
    let fixedCount = 0;
    const days = Object.keys(schedule).sort((a, b) => Number(a) - Number(b));

    for (let i = 1; i < days.length - 1; i++) {
        const todayKey = days[i];
        const prevKey = days[i-1];
        const nextKey = days[i+1];
        const todayAssigns = schedule[todayKey];
        const prevAssigns = schedule[prevKey];
        const nextAssigns = schedule[nextKey];

        let violators = [];
        todayAssigns.forEach(curr => {
            const prev = prevAssigns.find(p => p.staffId === curr.staffId);
            if (prev && hasRotationConflict(prev.shift, curr.shift)) {
                violators.push({ ...curr, group: getGroup(curr.shift) });
            }
        });

        let handledIds = [];
        violators.forEach(personA => {
            if (handledIds.includes(personA.staffId)) return;
            const personB = violators.find(v => !handledIds.includes(v.staffId) && v.staffId !== personA.staffId && v.group !== personA.group);

            if (personB) {
                const nextA = nextAssigns.find(n => n.staffId === personA.staffId);
                const nextB = nextAssigns.find(n => n.staffId === personB.staffId);
                const conflictA = nextA ? hasRotationConflict(personB.shift, nextA.shift) : false;
                const conflictB = nextB ? hasRotationConflict(personA.shift, nextB.shift) : false;

                if (!conflictA && !conflictB) {
                    const idxA = schedule[todayKey].findIndex(x => x.staffId === personA.staffId);
                    const idxB = schedule[todayKey].findIndex(x => x.staffId === personB.staffId);
                    if (idxA > -1 && idxB > -1) {
                        const tempShift = schedule[todayKey][idxA].shift;
                        const tempRole = schedule[todayKey][idxA].role;
                        schedule[todayKey][idxA].shift = schedule[todayKey][idxB].shift;
                        schedule[todayKey][idxA].role = schedule[todayKey][idxB].role;
                        schedule[todayKey][idxA].isChanged = true;
                        schedule[todayKey][idxB].shift = tempShift;
                        schedule[todayKey][idxB].role = tempRole;
                        schedule[todayKey][idxB].isChanged = true;
                        logs.push(`Ng√†y ${todayKey}: Tr√°o ca ${personA.name} (<->) ${personB.name} (S·ª≠a l·ªói nh·ªãp).`);
                        fixedCount++;
                        handledIds.push(personA.staffId);
                        handledIds.push(personB.staffId);
                    }
                }
            }
        });
    }
    return { success: fixedCount > 0, count: fixedCount, schedule, logs };
}

// 2. AUTO FIX WEEKEND FAIRNESS
export function autoFixWeekendFairness(scheduleData, month, year, staffList) {
    let schedule = JSON.parse(JSON.stringify(scheduleData));
    let logs = [];
    let fixedCount = 0;
    
    const getStats = () => {
        const map = {};
        staffList.forEach(s => map[s.id] = { ...s, count: 0, isMale: s.gender === 'Nam' });
        Object.keys(schedule).forEach(d => {
            if (isWeekend(parseInt(d), month, year)) {
                schedule[d].forEach(a => { if (isHardRole(a.role)) map[a.staffId].count++; });
            }
        });
        return Object.values(map);
    };

    for(let loop=0; loop<100; loop++) {
        let stats = getStats();
        let maxVal = Math.max(...stats.map(s => s.count));
        let minVal = Math.min(...stats.map(s => s.count));
        
        if (maxVal - minVal <= 1) break;

        const donor = stats.find(s => s.count === maxVal);
        let receiver = stats.find(s => s.count === minVal && s.isMale === donor.isMale);
        if (!receiver) receiver = stats.find(s => s.count === minVal);

        if (!donor || !receiver) break;

        let swapDay = null;
        const days = Object.keys(schedule);
        
        for (const d of days) {
            if (isWeekend(parseInt(d), month, year)) {
                const assignD = schedule[d].find(a => a.staffId === donor.id);
                const assignR = schedule[d].find(a => a.staffId === receiver.id);
                
                if (assignD && isHardRole(assignD.role) && assignR && !isHardRole(assignR.role)) {
                    if ((assignD.role === 'GH' || assignD.role === 'Giao H√†ng') && !receiver.isMale) continue;
                    swapDay = d; 
                    break;
                }
            }
        }

        if (swapDay) {
            const idxD = schedule[swapDay].findIndex(x => x.staffId === donor.id);
            const idxR = schedule[swapDay].findIndex(x => x.staffId === receiver.id);
            const tempShift = schedule[swapDay][idxD].shift;
            const tempRole = schedule[swapDay][idxD].role;
            schedule[swapDay][idxD].shift = schedule[swapDay][idxR].shift;
            schedule[swapDay][idxD].role = schedule[swapDay][idxR].role;
            schedule[swapDay][idxD].isChanged = true;
            schedule[swapDay][idxR].shift = tempShift;
            schedule[swapDay][idxR].role = tempRole;
            schedule[swapDay][idxR].isChanged = true;
            logs.push(`Ng√†y ${swapDay}: Chuy·ªÉn ${tempRole} t·ª´ ${donor.name} sang ${receiver.name}.`);
            fixedCount++;
        } else {
            receiver.count += 999;
        }
    }
    return { success: fixedCount > 0, count: fixedCount, schedule, logs };
}

// 3. AUTO FIX GENDER (Basic)
export function autoFixGenderBalance(scheduleData, month, year, forceFix = false) {
    let schedule = JSON.parse(JSON.stringify(scheduleData));
    let logs = [];
    let conflictWarnings = [];
    let fixedCount = 0;
    const days = Object.keys(schedule).sort((a, b) => Number(a) - Number(b));

    for (let i = 1; i < days.length; i++) {
        const todayKey = days[i];
        const prevKey = days[i-1];
        const todayAssigns = schedule[todayKey];
        const prevAssigns = schedule[prevKey] || [];

        const shiftGroups = {};
        todayAssigns.forEach((assign, idx) => {
            if (assign.shift === 'OFF') return;
            if (!shiftGroups[assign.shift]) shiftGroups[assign.shift] = { males: [], females: [], code: assign.shift };
            
            if (assign.role === 'Kho') {
                if (assign.gender === 'Nam') shiftGroups[assign.shift].males.push({ ...assign, idx });
                else shiftGroups[assign.shift].females.push({ ...assign, idx });
            }
        });

        let lackMaleShifts = Object.values(shiftGroups).filter(g => g.males.length === 0 && g.females.length >= 1);
        let richMaleShifts = Object.values(shiftGroups).filter(g => g.males.length >= 1);

        lackMaleShifts.forEach(badShift => {
            let fixed = false;
            for (let targetRich of richMaleShifts) {
                if (targetRich.code === badShift.code || fixed) continue;
                for (let maleCandidate of targetRich.males) {
                    if (fixed) break;
                    const femaleCandidate = badShift.females[0];
                    const prevMale = prevAssigns.find(p => p.staffId === maleCandidate.staffId);
                    const prevFemale = prevAssigns.find(p => p.staffId === femaleCandidate.staffId);

                    let conflictM = prevMale ? hasRotationConflict(prevMale.shift, badShift.code) : false;
                    let conflictF = prevFemale ? hasRotationConflict(prevFemale.shift, targetRich.code) : false;

                    if ((conflictM || conflictF) && !forceFix) {
                        conflictWarnings.push(`Ng√†y ${todayKey}: ƒê·ªïi ${maleCandidate.name} (Kho) g√¢y l·ªói xoay ca.`);
                        continue;
                    }

                    const idxM = maleCandidate.idx;
                    const idxF = femaleCandidate.idx;
                    const shiftM = schedule[todayKey][idxM].shift;
                    
                    schedule[todayKey][idxM].shift = schedule[todayKey][idxF].shift;
                    schedule[todayKey][idxM].isChanged = true;
                    schedule[todayKey][idxF].shift = shiftM;
                    schedule[todayKey][idxF].isChanged = true;
                    logs.push(`Ng√†y ${todayKey}: ƒê·ªïi n·ªôi b·ªô Kho: ${maleCandidate.name} qua ca ${badShift.code}.`);
                    fixedCount++;
                    fixed = true;
                    targetRich.males = targetRich.males.filter(m => m.staffId !== maleCandidate.staffId);
                }
            }
        });
    }

    return { 
        success: fixedCount > 0, 
        count: fixedCount, 
        schedule, 
        logs,
        hasConflict: conflictWarnings.length > 0,
        conflicts: conflictWarnings
    };
}

// 4. MANUAL BALANCE GENDER (UPDATED LOGIC)
export function manualBalanceGender(scheduleData, staffList, month, year, config) {
    let schedule = JSON.parse(JSON.stringify(scheduleData));
    let logs = [];
    let successCount = 0;
    
    const targetRoleLabel = config.role === 'tn' ? 'Thu Ng√¢n' : 'Kho';
    const targetRoleKey = config.role; 

    const donors = staffList.filter(s => s.gender === config.fromGender);
    const receivers = staffList.filter(s => s.gender === config.toGender);

    // Helper: ƒê·∫øm s·ªë l∆∞·ª£ng ca cu·ªëi tu·∫ßn hi·ªán t·∫°i c·ªßa m·ªôt nh√¢n vi√™n
    const getWeekendLoad = (staffId) => {
        let count = 0;
        Object.keys(schedule).forEach(d => {
            if (isWeekend(parseInt(d), month, year)) {
                const assign = schedule[d].find(a => a.staffId === staffId);
                if (assign && isHardRole(assign.role)) count++;
            }
        });
        return count;
    };

    // Helper: ƒê·∫øm t·ªïng s·ªë nghi·ªáp v·ª• (ƒë·ªÉ ∆∞u ti√™n ng∆∞·ªùi √≠t vi·ªác)
    const getRoleCount = (staffId) => {
        let count = 0;
        Object.values(schedule).forEach(dayList => {
            const assign = dayList.find(a => a.staffId === staffId);
            if (assign && (assign.role === targetRoleLabel || assign.role === targetRoleKey)) count++;
        });
        return count;
    };

    const days = Object.keys(schedule).sort((a, b) => Number(a) - Number(b));
    const lockedStaffOnDay = {}; 
    days.forEach(d => lockedStaffOnDay[d] = new Set());

    donors.forEach(donor => {
        let swappedCount = 0;

        for (const d of days) {
            if (swappedCount >= config.qty) break; 
            if (lockedStaffOnDay[d].has(donor.id)) continue;

            const dayList = schedule[d];
            const donorIdx = dayList.findIndex(a => a.staffId === donor.id);
            const donorAssign = dayList[donorIdx];

            if (donorAssign && (donorAssign.role === targetRoleLabel || donorAssign.role === targetRoleKey)) {
                
                let bestCandidate = null;
                let bestScore = -Infinity;

                const sortedReceivers = [...receivers].sort((a, b) => getRoleCount(a.id) - getRoleCount(b.id));

                for (const receiver of sortedReceivers) {
                    if (lockedStaffOnDay[d].has(receiver.id)) continue;

                    const receiverIdx = dayList.findIndex(a => a.staffId === receiver.id);
                    const receiverAssign = dayList[receiverIdx];

                    if (isHardRole(receiverAssign.role)) continue; 

                    let score = 0;
                    let isViable = true;
                    
                    const isDayWeekend = isWeekend(d, month, year);

                    // --- LOGIC M·ªöI: KI·ªÇM TRA T·∫¢I TR·ªåNG CU·ªêI TU·∫¶N ---
                    if (isDayWeekend) {
                        const currentWeekendLoad = getWeekendLoad(receiver.id);
                        // Ph·∫°t c·ª±c n·∫∑ng n·∫øu ng∆∞·ªùi n√†y ƒë√£ c√≥ nhi·ªÅu ca cu·ªëi tu·∫ßn (>=2)
                        // C√¥ng th·ª©c: M·ªói ca cu·ªëi tu·∫ßn ƒëang c√≥ s·∫Ω tr·ª´ 5000 ƒëi·ªÉm
                        score -= (currentWeekendLoad * 5000);
                        score -= 1000; // Ph·∫°t chung v√¨ l√† ng√†y cu·ªëi tu·∫ßn
                    } else {
                        score += 100;
                    }

                    // P2: Li√™n ti·∫øp 2 ng√†y
                    if (d > 1) {
                        const prevDay = schedule[d-1];
                        const prevAssign = prevDay.find(a => a.staffId === receiver.id);
                        if (prevAssign && isHardRole(prevAssign.role)) { score -= 2000; isViable = false; }
                    }
                    if (d < days.length) {
                        const nextDay = schedule[Number(d)+1];
                        if (nextDay) {
                            const nextAssign = nextDay.find(a => a.staffId === receiver.id);
                            if (nextAssign && isHardRole(nextAssign.role)) { score -= 2000; isViable = false; }
                        }
                    }

                    // P3: Xoay ca
                    if (d > 1) {
                        const prevDay = schedule[d-1];
                        const prevAssign = prevDay.find(a => a.staffId === receiver.id);
                        if (prevAssign && hasRotationConflict(prevAssign.shift, donorAssign.shift)) score -= 500;
                        else score += 50;
                    }

                    if (score > bestScore) {
                        bestScore = score;
                        bestCandidate = { ...receiver, idx: receiverIdx, currentShift: receiverAssign.shift, currentRole: receiverAssign.role };
                    }
                }

                if (bestCandidate) {
                    schedule[d][donorIdx].shift = bestCandidate.currentShift;
                    schedule[d][donorIdx].role = bestCandidate.currentRole;
                    schedule[d][donorIdx].isChanged = true;

                    schedule[d][bestCandidate.idx].shift = donorAssign.shift;
                    schedule[d][bestCandidate.idx].role = donorAssign.role;
                    schedule[d][bestCandidate.idx].isChanged = true;

                    lockedStaffOnDay[d].add(donor.id);
                    lockedStaffOnDay[d].add(bestCandidate.id);

                    logs.push(`Ng√†y ${d}: ƒê·ªïi ${donorAssign.role} t·ª´ ${donor.name} -> ${bestCandidate.name}.`);
                    successCount++;
                    swappedCount++;
                }
            }
        }
    });

    return { schedule, logs, count: successCount };
}

// 5. OPTIMIZE SCHEDULE
export function optimizeSchedule(scheduleData, staffList) { 
    let schedule = JSON.parse(JSON.stringify(scheduleData));
    let allLogs = [];
    
    const today = new Date();
    const month = today.getMonth() + 1;
    const year = today.getFullYear();

    const fixRot = autoFixRotation(schedule, month, year);
    if (fixRot.success) {
        schedule = fixRot.schedule;
        allLogs = [...allLogs, ...fixRot.logs];
    }

    const fixWeek = autoFixWeekendFairness(schedule, month, year, staffList);
    if (fixWeek.success) {
        schedule = fixWeek.schedule;
        allLogs = [...allLogs, ...fixWeek.logs];
    }

    const finalStats = staffList.map(s => {
        let roles = { tn: 0, tv: 0, kho: 0, gh: 0 };
        let totalH = 0;
        Object.values(schedule).forEach(dayList => {
            const assign = dayList.find(a => a.staffId === s.id);
            if (assign && assign.shift !== 'OFF') {
                if (assign.role === 'tn' || assign.role === 'TN' || assign.role === 'Thu Ng√¢n') roles.tn++;
                else if (assign.role === 'kho' || assign.role === 'K' || assign.role === 'Kho') roles.kho++;
                else if (assign.role === 'gh' || assign.role === 'GH' || assign.role === 'Giao H√†ng') roles.gh++;
                else roles.tv++;
            }
        });
        return { id: s.id, roles };
    });

    return { 
        optimizedSchedule: schedule, 
        changesLog: allLogs, 
        finalStats: finalStats 
    };
}
--- END FILE: ./src/lib/optimization.js ---

--- START FILE: ./src/lib/scheduleLogic.js ---
// src/lib/scheduleLogic.js
// Version 37.1 - Emergency Rollback: Disable Cross-Month Injection to Fix Current Skew

export const SHIFT_DEFINITIONS = [
    // Ca Chu·∫©n
    { code: '123', label: 'Ca S√°ng (1+2+3)', time: '08:00 - 15:00', hours: 7, group: 'SANG' },
    { code: '456', label: 'Ca Chi·ªÅu (4+5+6)', time: '15:00 - 22:00', hours: 6.5, group: 'CHIEU' },
    { code: '23', label: 'Ca Tr∆∞a (2+3)', time: '09:00 - 15:00', hours: 6, group: 'SANG' },
    { code: '45', label: 'Ca Chi·ªÅu L·ª≠ng (4+5)', time: '15:00 - 21:00', hours: 6, group: 'CHIEU' },
    { code: '2-5', label: 'Ca G√£y (2+5)', time: '09:00-12:00 & 18:00-21:00', hours: 6, group: 'GAY' },
    { code: '2345', label: 'Giao H√†ng Full', time: '09:00 - 21:00', hours: 12, group: 'FULL' },
    
    // Ca Si√™u C∆∞·ªùng & ƒê·∫∑c Bi·ªát
    { code: '123456', label: 'Full Ng√†y ƒê√™m', time: '08:00 - 22:00', hours: 13.5, group: 'EXTREME' },
    { code: '12-56', label: 'S√°ng S·ªõm + T·ªëi Mu·ªôn', time: '08:00-12:00 & 18:00-22:00', hours: 8, group: 'EXTREME' },
    { code: '12-456', label: 'S√°ng S·ªõm + Chi·ªÅu Full', time: '08:00-12:00 & 15:00-22:00', hours: 11, group: 'EXTREME' },
    { code: '123-56', label: 'S√°ng Full + T·ªëi Mu·ªôn', time: '08:00-15:00 & 18:00-22:00', hours: 11, group: 'EXTREME' },
    { code: '12345', label: 'S√°ng C∆∞·ªùng L·ª±c', time: '08:00 - 21:00', hours: 13, group: 'EXTREME' },
    { code: '23456', label: 'Chi·ªÅu C∆∞·ªùng L·ª±c', time: '09:00 - 22:00', hours: 13, group: 'EXTREME' }
];

const BASE_HOURS = { '1': 1, '2': 3, '3': 3, '4': 3, '5': 3, '6': 0.5 };
const SHIFT_INFO = {};
SHIFT_DEFINITIONS.forEach(s => SHIFT_INFO[s.code] = { h: s.hours, group: s.group });
SHIFT_INFO['OFF'] = { h: 0, group: 'OFF' };

const ROLE_MAP = { 'Thu Ng√¢n': 'tn', 'TN': 'tn', 'Kho': 'kho', 'K': 'kho', 'Giao H√†ng': 'gh', 'GH': 'gh', 'T∆∞ V·∫•n': 'tv', 'TV': 'tv', '': 'tv' };
const DISPLAY_ROLE_MAP = { 'tn': 'Thu Ng√¢n', 'kho': 'Kho', 'gh': 'Giao H√†ng', 'tv': '' };
const HARD_ROLES = ['gh', 'kho', 'tn'];

export function getDynamicShiftInfo(code) {
    if (!code || code === 'OFF') return { h: 0, group: 'OFF' };
    if (SHIFT_INFO[code]) return SHIFT_INFO[code];

    let totalHours = 0;
    let foundParts = [];
    for (let char of String(code)) {
        if (BASE_HOURS[char] !== undefined) {
            totalHours += BASE_HOURS[char];
            foundParts.push(parseInt(char));
        }
    }
    
    let group = 'OFF';
    const hasMorning = foundParts.some(p => [1, 2, 3].includes(p));
    const hasAfternoon = foundParts.some(p => [4, 5, 6].includes(p));

    if (hasMorning && hasAfternoon) {
        if (foundParts.length >= 4) group = 'FULL';
        else group = 'GAY';
        if (totalHours >= 10) group = 'EXTREME';
    } else if (hasMorning) {
        group = 'SANG';
    } else if (hasAfternoon) {
        group = 'CHIEU';
    }
    return { h: totalHours, group };
}

function isShiftConflict(yesterdayCode, todayCode) {
    if (!yesterdayCode || !todayCode || yesterdayCode === 'OFF' || todayCode === 'OFF') return false;
    const infoA = getDynamicShiftInfo(yesterdayCode);
    const infoB = getDynamicShiftInfo(todayCode);
    const gA = infoA.group;
    const gB = infoB.group;
    if (gA === gB && gA !== 'EXTREME' && gA !== 'GAY' && gA !== 'FULL') return true;
    return false;
}

function interleaveShifts(shiftList) {
    if (!shiftList || shiftList.length === 0) return [];
    const buckets = {};
    shiftList.forEach(s => { if (!buckets[s]) buckets[s] = []; buckets[s].push(s); });
    const PRIORITY_ORDER = ['123456', '12345', '23456', '2345', '12-456', '123-56', '12-56', '2-5', '123', '456', '23', '45'];
    Object.keys(buckets).forEach(k => { if (!PRIORITY_ORDER.includes(k)) PRIORITY_ORDER.push(k); });
    
    let result = [];
    let hasItems = true;
    while (hasItems) {
        hasItems = false;
        PRIORITY_ORDER.forEach(code => {
            if (buckets[code] && buckets[code].length > 0) { result.push(buckets[code].shift()); hasItems = true; }
        });
    }
    return result;
}

export function calculateCombosFromMatrix(matrix) {
    let remain = JSON.parse(JSON.stringify(matrix));
    let combos = [];
    const subtract = (shiftCodes, role, qty) => {
        shiftCodes.forEach(code => { if (remain[code] && remain[code][role] >= qty) remain[code][role] -= qty; });
    };
    const findMaxCap = (shiftCodes, role) => {
        let min = 999;
        shiftCodes.forEach(code => { let val = remain[code] ? remain[code][role] : 0; if (val < min) min = val; });
        return min;
    };

    let ghFullQty = findMaxCap(['c2', 'c3', 'c4', 'c5'], 'gh');
    if (ghFullQty > 0) { combos.push({ code: '2345', role: 'GH', qty: ghFullQty }); subtract(['c2', 'c3', 'c4', 'c5'], 'gh', ghFullQty); }
    let gh23 = findMaxCap(['c2', 'c3'], 'gh');
    if (gh23 > 0) { combos.push({ code: '23', role: 'GH', qty: gh23 }); subtract(['c2', 'c3'], 'gh', gh23); }
    let gh45 = findMaxCap(['c4', 'c5'], 'gh');
    if (gh45 > 0) { combos.push({ code: '45', role: 'GH', qty: gh45 }); subtract(['c4', 'c5'], 'gh', gh45); }

    ['kho', 'tn', 'tv'].forEach(role => {
        let labelRole = role === 'kho' ? 'Kho' : (role === 'tn' ? 'Thu Ng√¢n' : 'TV');
        let q123 = findMaxCap(['c1', 'c2', 'c3'], role);
        if (q123 > 0) { combos.push({ code: '123', role: labelRole, qty: q123 }); subtract(['c1', 'c2', 'c3'], role, q123); }
        let q456 = findMaxCap(['c4', 'c5', 'c6'], role);
        if (q456 > 0) { combos.push({ code: '456', role: labelRole, qty: q456 }); subtract(['c4', 'c5', 'c6'], role, q456); }
        let q23 = findMaxCap(['c2', 'c3'], role);
        if (q23 > 0) { combos.push({ code: '23', role: labelRole, qty: q23 }); subtract(['c2', 'c3'], role, q23); }
        let q45 = findMaxCap(['c4', 'c5'], role);
        if (q45 > 0) { combos.push({ code: '45', role: labelRole, qty: q45 }); subtract(['c4', 'c5'], role, q45); }
        let q25 = findMaxCap(['c2', 'c5'], role);
        if (q25 > 0) { combos.push({ code: '2-5', role: labelRole, qty: q25 }); subtract(['c2', 'c5'], role, q25); }
    });
    return combos;
}

export function suggestPeakCombos(baseCombos, deficit) {
    if (deficit <= 0) return baseCombos;
    let newCombos = JSON.parse(JSON.stringify(baseCombos));
    let savedSlots = 0;
    ['TV', 'Thu Ng√¢n', 'Kho'].forEach(role => {
        if (savedSlots >= deficit) return;
        let idx123 = newCombos.findIndex(c => c.code === '123' && c.role === role);
        let idx456 = newCombos.findIndex(c => c.code === '456' && c.role === role);
        if (idx123 > -1 && idx456 > -1) {
            let qty123 = newCombos[idx123].qty;
            let qty456 = newCombos[idx456].qty;
            let mergeQty = Math.min(qty123, qty456);
            let needToSave = deficit - savedSlots;
            if (mergeQty > needToSave) mergeQty = needToSave;
            if (mergeQty > 0) {
                newCombos[idx123].qty -= mergeQty;
                newCombos[idx456].qty -= mergeQty;
                let idxNew = newCombos.findIndex(c => c.code === '12-56' && c.role === role);
                if (idxNew > -1) newCombos[idxNew].qty += mergeQty;
                else newCombos.push({ code: '12-56', role: role, qty: mergeQty });
                savedSlots += mergeQty;
            }
        }
    });
    return newCombos;
}

export function generateMonthlySchedule(originalStaffList, comboData, month, year, prevScheduleData = null, genderConfig = { kho: 'none', tn: 'none' }) {
    const daysInMonth = new Date(year, month, 0).getDate();
    let warnings = [];

    let weekdayCombos = Array.isArray(comboData) ? comboData : (comboData.weekday || []);
    let weekendCombos = Array.isArray(comboData) ? comboData : (comboData.weekend || []);

    // [EMERGENCY ROLLBACK] T·∫Øt t√≠nh nƒÉng n·∫°p d·ªØ li·ªáu c≈© ƒë·ªÉ tr√°nh l·ªách ca
    let staffList = originalStaffList.map(s => {
        return {
            id: s.id, name: s.name, gender: s.gender,
            isMale: (s.gender || '').trim().toLowerCase() === 'nam',
            lastShiftCode: 'OFF', lastRole: 'tv', lastHardRoleDay: -10,
            weekendHardRoleCount: 0, // Reset v·ªÅ 0
            stats: { hours: 0, roles: { tn: 0, tv: 0, kho: 0, gh: 0 } } // Reset v·ªÅ 0
        };
    });

    if (prevScheduleData && prevScheduleData.data) {
        const lastDayKey = Object.keys(prevScheduleData.data).sort((a,b)=>Number(b)-Number(a))[0];
        if (lastDayKey) {
            prevScheduleData.data[lastDayKey].forEach(assign => {
                const staff = staffList.find(s => s.id === assign.staffId);
                if (staff) {
                    staff.lastShiftCode = assign.shift;
                    const rCode = ROLE_MAP[assign.role] || 'tv';
                    staff.lastRole = rCode;
                    if (HARD_ROLES.includes(rCode)) staff.lastHardRoleDay = 0;
                }
            });
        }
    }

    const buildPool = (combos) => {
        let raw = [];
        combos.forEach(c => {
            let rId = ROLE_MAP[c.role] || 'tv';
            let qty = parseInt(c.qty) || 0;
            for (let i = 0; i < qty; i++) raw.push(c.code);
        });
        let pool = interleaveShifts(raw);
        while (pool.length < staffList.length) pool.push('OFF');
        return pool.slice(0, staffList.length);
    };

    const weekdayPool = buildPool(weekdayCombos);
    const weekendPool = buildPool(weekendCombos);

    const getDemands = (combos) => {
        let demand = {};
        combos.forEach(c => {
            let rId = ROLE_MAP[c.role] || 'tv';
            let qty = parseInt(c.qty) || 0;
            for (let i = 0; i < qty; i++) {
                if (!demand[c.code]) demand[c.code] = [];
                demand[c.code].push(rId);
            }
        });
        return demand;
    };

    const weekdayDemands = getDemands(weekdayCombos);
    const weekendDemands = getDemands(weekendCombos);

    let schedule = {};
    for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(year, month - 1, d);
        const dayOfWeek = dateObj.getDay(); 
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);

        const currentPool = isWeekend ? weekendPool : weekdayPool;
        const currentDemands = JSON.parse(JSON.stringify(isWeekend ? weekendDemands : weekdayDemands));

        let currentDayAssignments = staffList.map((staff, index) => {
            let poolIndex = (index + d) % staffList.length;
            let assignedShift = currentPool[poolIndex];
            return {
                staffId: staff.id, name: staff.name, isMale: staff.isMale,
                shift: assignedShift, role: 'tv', fixed: false, originalIndex: index
            };
        });

        const ROLE_PRIORITY = ['gh', 'kho', 'tn'];

        ROLE_PRIORITY.forEach(targetRole => {
            let shiftsNeedingRole = [];
            Object.keys(currentDemands).forEach(shiftCode => {
                let count = currentDemands[shiftCode].filter(r => r === targetRole).length;
                for(let k=0; k<count; k++) shiftsNeedingRole.push(shiftCode);
            });

            if (shiftsNeedingRole.length === 0) return;

            let allCandidates = currentDayAssignments.filter(a => !a.fixed);

            allCandidates.forEach(cand => {
                const staff = staffList.find(s => s.id === cand.staffId);
                let score = 0;
                if (targetRole === 'gh' && !cand.isMale) { cand.score = -99999999; return; }
                const gap = d - staff.lastHardRoleDay;
                if (gap <= 1) score -= 5000000; 
                else score += gap * 10; 
                
                // Tr·ªçng s·ªë ph·∫°t s·ªë l∆∞·ª£ng: Gi·ªØ nguy√™n ƒë·ªÉ chia ƒë·ªÅu trong th√°ng hi·ªán t·∫°i
                score -= staff.stats.roles[targetRole] * 100000;

                // Tr·ªçng s·ªë ph·∫°t cu·ªëi tu·∫ßn: Gi·ªØ nguy√™n
                if (isWeekend) score -= staff.weekendHardRoleCount * 50000;
                
                // [GEM FIXED] Weekend Protection: Ch·ªâ check gi·ªõi t√≠nh v√†o ng√†y th∆∞·ªùng
                if (!isWeekend) { 
                    if (targetRole === 'kho' && genderConfig.kho === 'mixed') {
                        const existingInShift = currentDayAssignments.filter(a => a.fixed && a.role === 'kho' && a.shift === cand.shift);
                        const hasMale = existingInShift.some(a => a.isMale);
                        if (existingInShift.length > 0 && !hasMale && !cand.isMale) score -= 500;
                    }
                    if (targetRole === 'tn' && genderConfig.tn === 'mixed') {
                        const existingInShift = currentDayAssignments.filter(a => a.fixed && a.role === 'tn' && a.shift === cand.shift);
                        const hasMale = existingInShift.some(a => a.isMale);
                        const hasFemale = existingInShift.some(a => !a.isMale);
                        if (existingInShift.length > 0) {
                            if (!hasMale && !cand.isMale) score -= 500;
                            if (!hasFemale && cand.isMale) score -= 500;
                        }
                    }
                }

                let nextPoolIndex = (cand.originalIndex + d + 1) % staffList.length;
                let nextShift = currentPool[nextPoolIndex];
                if (['2345', '123', '12-56'].includes(nextShift)) score -= 50;

                cand.score = score;
            });

            allCandidates.sort((a, b) => b.score - a.score);

            for (let i = 0; i < shiftsNeedingRole.length; i++) {
                let targetShiftCode = shiftsNeedingRole[i];
                let isAssigned = false;

                const trySwap = (candidate, potentialHolders, debug = false) => {
                    for (let k = 0; k < potentialHolders.length; k++) {
                        let holder = potentialHolders[k];
                        let staffHolder = staffList.find(s => s.id === holder.staffId);
                        
                        if (isShiftConflict(staffHolder.lastShiftCode, candidate.shift)) {
                            if (debug) console.log(`[FAIL_SWAP] ${holder.name} Conflict`);
                            continue;
                        }

                        let tempShift = holder.shift;
                        holder.shift = candidate.shift;
                        candidate.shift = tempShift;
                        candidate.role = targetRole;
                        candidate.fixed = true;
                        return true;
                    }
                    return false;
                };

                for (let j = 0; j < allCandidates.length; j++) {
                    let cand = allCandidates[j];
                    if (cand.fixed) continue;
                    
                    const staffCand = staffList.find(s => s.id === cand.staffId);
                    
                    if (cand.shift === targetShiftCode) {
                        if (isShiftConflict(staffCand.lastShiftCode, targetShiftCode)) {
                            if (j < 5) console.log(`[SKIP_CONFLICT] ${cand.name}`);
                            continue;
                        }
                        cand.role = targetRole;
                        cand.fixed = true; 
                        isAssigned = true;
                        break;
                    } 
                    
                    if (isShiftConflict(staffCand.lastShiftCode, targetShiftCode)) {
                        if (j < 5) console.log(`[SKIP_CONFLICT_TARGET] ${cand.name}`);
                        continue;
                    }

                    let potentialSeatHolders = currentDayAssignments.filter(a => a.shift === targetShiftCode && !a.fixed);
                    
                    if (trySwap(cand, potentialSeatHolders, j < 5)) {
                        isAssigned = true;
                        break;
                    } else if (j < 5) {
                         console.log(`[FAIL_DIRECT] ${cand.name}`);
                    }

                    if (j < 5 && !isAssigned) {
                        let offHolders = currentDayAssignments.filter(a => a.shift === 'OFF' && !a.fixed);
                        let bridgeFound = false;
                        
                        for(let b=0; b < offHolders.length; b++) {
                            let bridge = offHolders[b];
                            let staffBridge = staffList.find(s => s.id === bridge.staffId);
                            
                            if (isShiftConflict(staffBridge.lastShiftCode, cand.shift)) continue;

                            let oldCandShift = cand.shift;
                            cand.shift = 'OFF';
                            
                            if (trySwap(cand, potentialSeatHolders, false)) {
                                bridge.shift = oldCandShift;
                                bridgeFound = true;
                                isAssigned = true;
                                console.log(`[RESCUE_SUCCESS] Ng√†y ${d}: C·ª©u ${cand.name} qua c·∫ßu ${bridge.name}`);
                                break; 
                            } else {
                                cand.shift = oldCandShift;
                            }
                        }
                        if (bridgeFound) break;
                    }
                }
            }
        });

        schedule[d] = currentDayAssignments.map(a => {
            const staff = staffList.find(s => s.id === a.staffId);
            staff.lastShiftCode = a.shift;
            staff.lastRole = a.role;
            
            if (a.shift !== 'OFF') {
                staff.stats.hours += getDynamicShiftInfo(a.shift).h;
                if (HARD_ROLES.includes(a.role)) {
                    staff.stats.roles[a.role]++;
                    staff.lastHardRoleDay = d;
                    if (isWeekend) staff.weekendHardRoleCount++;
                } else {
                    staff.stats.roles.tv++;
                }
            }
            
            return {
                staffId: a.staffId, name: a.name, gender: staff.gender,
                shift: a.shift, role: DISPLAY_ROLE_MAP[a.role] || '',
                originalShift: a.shift, originalRole: DISPLAY_ROLE_MAP[a.role] || ''
            };
        });
    }

    const finalStaffStats = staffList.map(s => ({
        id: s.id, name: s.name, gender: s.gender,
        totalHours: Math.round(s.stats.hours),
        gh: s.stats.roles.gh, tn: s.stats.roles.tn, kho: s.stats.roles.kho,
        weekendHardRoles: s.weekendHardRoleCount
    }));

    ['gh', 'tn', 'kho'].forEach(role => {
        let eligibleStaff = finalStaffStats;
        if (role === 'gh') eligibleStaff = finalStaffStats.filter(s => (s.gender || '').toLowerCase() === 'nam');
        
        if (eligibleStaff.length > 0) {
            let counts = eligibleStaff.map(s => s[role]);
            let min = Math.min(...counts);
            let max = Math.max(...counts);
            
            if (max - min > 2) {
                let maxNames = eligibleStaff.filter(s => s[role] === max).map(s => `${s.name}(${max})`).join(', ');
                let minNames = eligibleStaff.filter(s => s[role] === min).map(s => `${s.name}(${min})`).join(', ');
                warnings.push(`C·∫¢NH B√ÅO L·ªÜCH ${role.toUpperCase()}: Max=${max}, Min=${min}. [Th·ª´a: ${maxNames}] - [Thi·∫øu: ${minNames}]`);
            }
        }
    });

    return { schedule, staffStats: finalStaffStats, endOffset: 0, warnings };
}
--- END FILE: ./src/lib/scheduleLogic.js ---

--- START FILE: ./src/lib/stores.js ---
// Version 41.0 - Optimize Store: Add User Cache
import { writable } from 'svelte/store';

// User hi·ªán t·∫°i
const storedUser = localStorage.getItem('taskflow_user');
export const currentUser = writable(storedUser ? JSON.parse(storedUser) : null);

// Danh s√°ch c√¥ng vi·ªác
export const currentTasks = writable([]);

// M·∫´u Checklist
export const taskTemplate = writable({});

// Danh s√°ch kho
export const storeList = writable([]);

// CACHE M·ªöI: Danh s√°ch nh√¢n vi√™n theo Kho
// C·∫•u tr√∫c: { 'storeId': [ {username, name}, ... ] }
export const storeUsersCache = writable({});

// Tr·∫°ng th√°i Loading
export const isLoading = writable(false);

export const setUser = (user) => {
    if (user && !user.storeIds) {
        user.storeIds = user.storeId ? [user.storeId] : [];
    }
    currentUser.set(user);
    if (user) {
        localStorage.setItem('taskflow_user', JSON.stringify(user));
    } else {
        localStorage.removeItem('taskflow_user');
    }
};

// (Gi·ªØ nguy√™n DEFAULT_TEMPLATE...)
export const DEFAULT_TEMPLATE = {
    warehouse: [
        { time: "08:00", title: "Ki·ªÉm tra h√†ng nh·∫≠p ƒë·∫ßu ng√†y", isImportant: true, days: [0,1,2,3,4,5,6] },
        { time: "09:00", title: "S·∫Øp x·∫øp k·ªá tr∆∞ng b√†y ch√≠nh", isImportant: false, days: [0,1,2,3,4,5,6] },
        { time: "11:30", title: "Ki·ªÉm tra nhi·ªát ƒë·ªô t·ªß m√°t/ƒë√¥ng", isImportant: true, days: [0,1,2,3,4,5,6] },
        { time: "14:00", title: "So·∫°n ƒë∆°n h√†ng Online", isImportant: false, days: [0,1,2,3,4,5,6] },
        { time: "17:00", title: "V·ªá sinh kho b√£i & l·ªëi ƒëi", isImportant: false, days: [0,1,2,3,4,5,6] },
        { time: "21:00", title: "Ki·ªÉm tra kh√≥a c·ª≠a kho & t·∫Øt ƒëi·ªán", isImportant: true, days: [0,1,2,3,4,5,6] }
    ],
    cashier: [
        { time: "08:00", title: "Ki·ªÉm qu·ªπ ƒë·∫ßu ca & V·ªá sinh qu·∫ßy", isImportant: true, days: [0,1,2,3,4,5,6] },
        { time: "12:00", title: "N·ªôp doanh thu ca S√°ng", isImportant: true, days: [0,1,2,3,4,5,6] },
        { time: "15:00", title: "Ki·ªÉm tra v·∫≠t t∆∞ (bao b√¨, bill...)", isImportant: false, days: [0,1,2,3,4,5,6] },
        { time: "18:00", title: "V·ªá sinh khu v·ª±c thu ng√¢n", isImportant: false, days: [0,1,2,3,4,5,6] },
        { time: "21:30", title: "Ch·ªët ca & In b√°o c√°o cu·ªëi ng√†y", isImportant: true, days: [0,1,2,3,4,5,6] }
    ],
    handover: []
};
--- END FILE: ./src/lib/stores.js ---

--- START FILE: ./src/lib/utils.js ---
// src/lib/utils.js

// H√†m x·ª≠ l√Ω chu·ªói an to√†n
export function safeString(val) {
    if (val === undefined || val === null) return '';
    return String(val).trim();
}

// L·∫•y ng√†y hi·ªán t·∫°i (YYYY-MM-DD)
export function getTodayStr() {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
}

// ƒê·ªãnh d·∫°ng ng√†y gi·ªù hi·ªÉn th·ªã
export function formatDateTime(isoStr) {
    if (!isoStr) return "";
    const d = new Date(isoStr);
    const h = d.getHours().toString().padStart(2, '0');
    const m = d.getMinutes().toString().padStart(2, '0');
    const day = d.getDate().toString().padStart(2, '0');
    const mon = (d.getMonth() + 1).toString().padStart(2, '0');
    return `${h}:${m} - ${day}/${mon}`;
}

// L·∫•y gi·ªù hi·ªán t·∫°i ng·∫Øn g·ªçn
export function getCurrentTimeShort() {
    const d = new Date();
    const h = d.getHours().toString().padStart(2, '0');
    const m = d.getMinutes().toString().padStart(2, '0');
    return `${h}:${m}`;
}
--- END FILE: ./src/lib/utils.js ---

--- START FILE: ./src/main.js ---
// Version 3.0 - Svelte 5 Mount Fix + PWA Debug Mode
import { mount } from 'svelte' // B·∫ÆT BU·ªòC CHO SVELTE 5
import './app.css'
import App from './App.svelte'

// --- PWA LOGIC (Ch·∫ø ƒë·ªô Debug cho ph√©p ch·∫°y Local) ---
if ('serviceWorker' in navigator) {
  // Logic: Ch·∫°y SW k·ªÉ c·∫£ khi ·ªü Localhost ƒë·ªÉ fix l·ªói hi·ªÉn th·ªã
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('‚úÖ Service Worker Active:', registration.scope);
      })
      .catch((err) => {
        console.log('‚ùå Service Worker Fail:', err);
      });
  });
}
// ----------------------------------------------------

// KH·ªûI T·∫†O APP (C√ö PH√ÅP SVELTE 5)
// Thay th·∫ø cho new App(...) g√¢y l·ªói
const app = mount(App, {
  target: document.getElementById('app'),
})

export default app
--- END FILE: ./src/main.js ---

--- START FILE: ./src/modules/settings.service.js ---
// Version 1.0 - Settings Module
export const settingsService = {
    initInterface: () => {
        console.log("Settings: Interface initialized.");
    },
    initGoalSettings: () => {
        console.log("Settings: Goals initialized.");
    }
};
--- END FILE: ./src/modules/settings.service.js ---

--- START FILE: ./src/services/dataService.js ---
// Version 1.0 - Core Data Service
export const loadAllFromCache = async () => {
    // T·∫°m th·ªùi gi·∫£ l·∫≠p vi·ªác t·∫£i d·ªØ li·ªáu th√†nh c√¥ng
    console.log("DataService: Loaded cache successfully.");
    return Promise.resolve(true);
};
--- END FILE: ./src/services/dataService.js ---

--- START FILE: ./src/services/employeeService.js ---
// Version 1.0 - Employee Service
console.log("EmployeeService: Active.");
export default {};
--- END FILE: ./src/services/employeeService.js ---

--- START FILE: ./src/utils/excelExport.js ---
import { utils, writeFile } from 'xlsx';

export function exportScheduleToExcel({
    scheduleData,
    viewMonth,
    viewYear,
    selectedViewStore,
    getWeekday,
    getWeekendHardRoleCount
}) {
    if (!scheduleData) return;
    
    const wb = utils.book_new();
    const days = Object.keys(scheduleData.data).sort((a, b) => Number(a) - Number(b));
    const wsData = [];
    
    // D√≤ng 1: Ti√™u ƒë·ªÅ ng√†y v√† c√°c c·ªôt t·ªïng k·∫øt
    const row1 = ["NH√ÇN S·ª∞"]; 
    days.forEach(d => row1.push(d)); 
    row1.push("T·ªïng Gi·ªù", "GH", "TN", "K", "Ca cu·ªëi tu·∫ßn"); 
    wsData.push(row1);
    
    // D√≤ng 2: Th·ª© trong tu·∫ßn
    const row2 = [""]; 
    days.forEach(d => row2.push(getWeekday(d))); 
    row2.push("", "", "", "", ""); 
    wsData.push(row2);
    
    // C√°c d√≤ng d·ªØ li·ªáu nh√¢n s·ª±
    scheduleData.stats.forEach(staff => {
        const row = [staff.name];
        days.forEach(d => {
            const assign = scheduleData.data[d].find(x => x.staffId === staff.id);
            if (assign) { 
                let cell = assign.shift; 
                if (assign.role && assign.role !== 'TV') cell += ` (${assign.role})`; 
                row.push(cell); 
            } else { 
                row.push(""); 
            }
        });
        row.push(
            Math.round(staff.totalHours), 
            staff.gh, 
            staff.tn, 
            staff.kho, 
            getWeekendHardRoleCount(staff.id)
        );
        wsData.push(row);
    });
    
    // T·∫°o sheet v√† xu·∫•t file
    const ws = utils.aoa_to_sheet(wsData);
    utils.book_append_sheet(wb, ws, `Lich_T${viewMonth}`);
    writeFile(wb, `Lich_Lam_Viec_Kho_${selectedViewStore}_T${viewMonth}_${viewYear}.xlsx`);
}
--- END FILE: ./src/utils/excelExport.js ---

--- START FILE: ./svelte.config.js ---
import { vitePreprocess } from '@sveltejs/vite-plugin-svelte'

/** @type {import("@sveltejs/vite-plugin-svelte").SvelteConfig} */
export default {
  // Consult https://svelte.dev/docs#compile-time-svelte-preprocess
  // for more information about preprocessors
  preprocess: vitePreprocess(),
}

--- END FILE: ./svelte.config.js ---

--- START FILE: ./tailwind.config.js ---
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{svelte,js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      // T·∫≠n d·ª•ng l·∫°i c√°c bi·∫øn m√†u c≈© c·ªßa b·∫°n ƒë·ªÉ d√πng c√∫ ph√°p Tailwind
      // V√≠ d·ª•: class="bg-warehouse" ho·∫∑c class="text-warehouse"
      colors: {
        warehouse: '#ff9800',
        cashier: '#4caf50',
        handover: '#673ab7',
        completed: '#9e9e9e',
      }
    },
  },
  plugins: [],
}
--- END FILE: ./tailwind.config.js ---

--- START FILE: ./vite.config.js ---
import { defineConfig } from 'vite'
import { svelte } from '@sveltejs/vite-plugin-svelte'

// https://vite.dev/config/
export default defineConfig({
  plugins: [svelte()],
})

--- END FILE: ./vite.config.js ---

